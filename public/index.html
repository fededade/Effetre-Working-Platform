<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Effetre Properties - Gestione Pratiche</title>
    
    <!-- ‚≠ê FIREBASE: STEP 1 - Aggiungi gli script Firebase PRIMA di tutto -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- üìß EMAILJS: Per invio email recupero password -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .pratica-disponibile { background-color: #e0f2fe; }
        .pratica-in-lavorazione { background-color: #e5e7eb; opacity: 0.7; }
        .pratica-sospesa { background-color: #fee2e2; }
        .pratica-completata { background-color: #d1fae5; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .badge {
            display: inline-block; padding: 0.25rem 0.75rem;
            border-radius: 9999px; font-size: 0.75rem; font-weight: 600;
        }
        .badge-disponibile { background-color: #3b82f6; color: white; }
        .badge-in-lavorazione { background-color: #6b7280; color: white; }
        .badge-sospesa { background-color: #ef4444; color: white; }
        .badge-completata { background-color: #10b981; color: white; }
        .badge-eliminata { background-color: #9ca3af; color: white; }
        .badge-prelavorata { background-color: #f59e0b; color: white; } /* Arancione */
        .pratica-eliminata { 
            background-color: #f3f4f6 !important; 
            opacity: 0.6;
        }
        .pratica-eliminata td { color: #9ca3af !important; }
        /* Disabilita pulsanti in pratiche eliminate MA NON il select */
        .pratica-eliminata button {
            pointer-events: none !important;
            opacity: 0.3;
        }
        /* Select rimane cliccabile per admin */
        .pratica-eliminata .stato-select {
            pointer-events: auto !important;
            opacity: 1 !important;
        }
        .stato-select {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            border: 2px solid #3b82f6;
            background-color: white;
            color: #3b82f6;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .stato-select:hover {
            background-color: #3b82f6;
            color: white;
        }
        .stato-select option {
            border-radius: 0;
        }
        .reminder-badge { 
            background-color: #dc2626; 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
            margin-left: 0.5rem;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .giorno-card { border-left: 4px solid #3b82f6; }
        .row-hover:hover { background-color: #f0f9ff; cursor: pointer; }
        .logo-container { max-width: 350px; margin: 0 auto 2rem; }
        .logo-effetre { width: 100%; height: auto; }
        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #1a1a1a; font-weight: bold; padding: 1.5rem 3rem;
            border-radius: 0.75rem; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
            font-size: 1.125rem; border: none; cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.6);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
            color: white; font-weight: bold; padding: 1.5rem 3rem;
            border-radius: 0.75rem; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(75, 85, 99, 0.4);
            font-size: 1.125rem; border: none; cursor: pointer;
        }
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(75, 85, 99, 0.6);
        }
        .upload-zone {
            border: 3px dashed #d4af37; background-color: #2a2a2a;
            transition: all 0.3s; padding: 3rem; border-radius: 0.75rem;
            cursor: pointer; text-align: center;
        }
        .upload-zone:hover { border-color: #f4d03f; background-color: #3a3a3a; }
        .upload-zone.dragover { border-color: #f4d03f; background-color: #4a4a4a; }
        .home-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .filtri-sticky {
            position: sticky;
            top: 80px;
            z-index: 50;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-sticky {
            position: sticky;
            top: 0;
            z-index: 100;
        }
        /* Badge per indicare stato Firebase */
        .firebase-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }
        .firebase-connected {
            background-color: #10b981;
            color: white;
        }
        .firebase-disconnected {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============================================================
        // ‚≠ê FIREBASE: CONFIGURAZIONE - PROGETTO "GESTIONALE EFFETRE"
        // ============================================================
        // ‚úÖ CONFIGURAZIONE COMPLETA AL 100%!
        // Tutti i valori sono stati configurati correttamente.
        // 
        // Progetto: Gestionale Effetre
        // ID: gestionale-effetre
        // App ID: 1:418072647086:web:bbba16fa2e6c6140fee43f
        // ============================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAxuZxv3_7w4cR01W4dRrGOJ3-qbSsL868",
            authDomain: "gestionale-effetre.firebaseapp.com",
            projectId: "gestionale-effetre",
            storageBucket: "gestionale-effetre.firebasestorage.app",
            messagingSenderId: "418072647086",
            appId: "1:418072647086:web:bbba16fa2e6c6140fee43f",
            measurementId: "G-DYSPC79396"
        };

        // Inizializza Firebase
        let db = null;
        let firebaseInitialized = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseInitialized = true;
            console.log('‚úÖ Firebase inizializzato correttamente');
        } catch (error) {
            console.error('‚ùå Errore inizializzazione Firebase:', error);
            console.warn('‚ö†Ô∏è L\'app funzioner√† in modalit√† locale (localStorage)');
        }

        // ============================================================
        // UTENTI
        // ============================================================
        
        // ============================================================
        // üìß EMAILJS - CONFIGURAZIONE
        // ============================================================
        // Per configurare EmailJS:
        // 1. Vai su https://www.emailjs.com e crea un account gratuito
        // 2. Collega il tuo servizio email (Gmail, Outlook, ecc.)
        // 3. Crea un template email con queste variabili:
        //    - {{to_email}} = email destinatario
        //    - {{to_name}} = nome utente
        //    - {{password}} = password da recuperare
        // 4. Sostituisci i valori qui sotto con i tuoi
        // ============================================================
        const EMAILJS_CONFIG = {
            PUBLIC_KEY: "HeYuxWj8J-z2JGY3n",      // Da EmailJS Dashboard > Account > API Keys
            SERVICE_ID: "service_eak01rs",      // Da EmailJS Dashboard > Email Services
            TEMPLATE_ID: "template_95sgj1i"     // Da EmailJS Dashboard > Email Templates
        };
        
        // Inizializza EmailJS
        let emailjsInitialized = false;
        try {
            if (typeof emailjs !== 'undefined' && EMAILJS_CONFIG.PUBLIC_KEY !== "IL_TUO_PUBLIC_KEY") {
                emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
                emailjsInitialized = true;
                console.log('‚úÖ EmailJS inizializzato correttamente');
            } else if (EMAILJS_CONFIG.PUBLIC_KEY === "IL_TUO_PUBLIC_KEY") {
                console.warn('‚ö†Ô∏è EmailJS non configurato - Configura le credenziali in EMAILJS_CONFIG');
            }
        } catch (error) {
            console.error('‚ùå Errore inizializzazione EmailJS:', error);
        }
        
        // ============================================================
        // UTENTI INIZIALI (saranno salvati su Firebase)
        // ============================================================
        const UTENTI_INIZIALI = [
            { id: 'Davide', nome: 'Davide Federico', email: 'davide.federico@effetre-properties.com', ruolo: 'Super Amministratore', username: 'Davide', password: 'Davide123', isAdmin: true, isSuperAdmin: true },
            { id: 'IlariaC', nome: 'Ilaria Congiu', email: 'ilaria@effetre.it', ruolo: 'Tecnico', username: 'IlariaC', password: 'Giulia123', isAdmin: false, isSuperAdmin: false },
            { id: 'ChiaraP', nome: 'Chiara Pardile', email: 'chiara@effetre.it', ruolo: 'Amministratore', username: 'ChiaraP', password: 'Chiara123', isAdmin: true, isSuperAdmin: false },
            { id: 'CristinaP', nome: 'Cristina Popa', email: 'cristina@effetre.it', ruolo: 'Tecnico', username: 'CristinaP', password: 'Cristina123', isAdmin: false, isSuperAdmin: false },
            { id: 'TatianaC', nome: 'Tatiana Caloni', email: 'tatiana@effetre.it', ruolo: 'Tecnico', username: 'TatianaC', password: 'Tatiana123', isAdmin: false, isSuperAdmin: false }
        ];

        // ============================================================
        // COMPONENTE DASHBOARD STATISTICHE
        // ============================================================
        function DashboardStatistiche({ pratiche, utenti, periodoStats, setPeriodoStats, dataInizioStats, setDataInizioStats, dataFineStats, setDataFineStats, calcolaStatistiche, setVistaStatistiche, setPraticaSelezionata, setMostraModal }) {
            const { useState, useEffect, useRef } = React;
            const [stats, setStats] = useState(null);
            const [chartsInitialized, setChartsInitialized] = useState(false);
            const [praticheSelezionate, setPraticheSelezionate] = useState(null);
            
            // Refs per i canvas dei grafici
            const chartUtentiRef = useRef(null);
            const chartTempoRef = useRef(null);
            const chartStatiRef = useRef(null);
            const chartPrelavorataRef = useRef(null);
            
            // Refs per le istanze dei grafici
            const chartUtentiInstance = useRef(null);
            const chartTempoInstance = useRef(null);
            const chartStatiInstance = useRef(null);
            const chartPrelavorataInstance = useRef(null);
            
            // Calcola statistiche quando cambia periodo o range
            useEffect(() => {
                const newStats = calcolaStatistiche();
                setStats(newStats);
            }, [periodoStats, pratiche, dataInizioStats, dataFineStats]);
            
            // Crea/aggiorna grafici quando cambiano le stats
            useEffect(() => {
                if (!stats || !window.Chart) return;
                
                // Distruggi grafici esistenti
                if (chartUtentiInstance.current) chartUtentiInstance.current.destroy();
                if (chartTempoInstance.current) chartTempoInstance.current.destroy();
                if (chartStatiInstance.current) chartStatiInstance.current.destroy();
                if (chartPrelavorataInstance.current) chartPrelavorataInstance.current.destroy();
                
                // GRAFICO 1: Pratiche per utente
                if (chartUtentiRef.current) {
                    const ctx = chartUtentiRef.current.getContext('2d');
                    chartUtentiInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: stats.statsPerUtente.map(s => s.utente),
                            datasets: [
                                {
                                    label: 'Completate',
                                    data: stats.statsPerUtente.map(s => s.completate),
                                    backgroundColor: '#10b981',
                                },
                                {
                                    label: 'In Lavorazione',
                                    data: stats.statsPerUtente.map(s => s.inLavorazione),
                                    backgroundColor: '#6b7280',
                                },
                                {
                                    label: 'Sospese',
                                    data: stats.statsPerUtente.map(s => s.sospese),
                                    backgroundColor: '#ef4444',
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Pratiche per Utente' }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });
                }
                
                // GRAFICO 2: Pratiche nel tempo
                if (chartTempoRef.current) {
                    const ctx = chartTempoRef.current.getContext('2d');
                    const giorni = Object.keys(stats.pratichPerGiorno);
                    chartTempoInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: giorni,
                            datasets: [
                                {
                                    label: 'Completate',
                                    data: giorni.map(g => stats.pratichPerGiorno[g].completate),
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'Prese in Carico',
                                    data: giorni.map(g => stats.pratichPerGiorno[g].presInCarico),
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Attivit√† nel Tempo' }
                            },
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });
                }
                
                // GRAFICO 3: Distribuzione stati
                if (chartStatiRef.current) {
                    const ctx = chartStatiRef.current.getContext('2d');
                    chartStatiInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Disponibili', 'In Lavorazione', 'Sospese', 'Completate'],
                            datasets: [{
                                data: [
                                    stats.distribuzioneStati.disponibili,
                                    stats.distribuzioneStati.inLavorazione,
                                    stats.distribuzioneStati.sospese,
                                    stats.distribuzioneStati.completate
                                ],
                                backgroundColor: ['#3b82f6', '#6b7280', '#ef4444', '#10b981']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' },
                                title: { display: true, text: 'Distribuzione Stati' }
                            }
                        }
                    });
                }
                
                // GRAFICO 4: Prelavorata vs Normale
                if (chartPrelavorataRef.current) {
                    const ctx = chartPrelavorataRef.current.getContext('2d');
                    chartPrelavorataInstance.current = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Prelavorata', 'Normale'],
                            datasets: [{
                                data: [
                                    stats.prelavorataVsNormale.prelavorata,
                                    stats.prelavorataVsNormale.normale
                                ],
                                backgroundColor: ['#f59e0b', '#6b7280']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: true, text: 'Pratiche in Lavorazione' }
                            }
                        }
                    });
                }
                
                setChartsInitialized(true);
                
                // Cleanup
                return () => {
                    if (chartUtentiInstance.current) chartUtentiInstance.current.destroy();
                    if (chartTempoInstance.current) chartTempoInstance.current.destroy();
                    if (chartStatiInstance.current) chartStatiInstance.current.destroy();
                    if (chartPrelavorataInstance.current) chartPrelavorataInstance.current.destroy();
                };
            }, [stats]);
            
            if (!stats) {
                return <div className="text-center py-8">Caricamento statistiche...</div>;
            }
            
            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <div className="flex flex-wrap justify-between items-center gap-4">
                            <div className="flex items-center gap-4">
                                <button
                                    onClick={() => setVistaStatistiche(false)}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center gap-2"
                                    title="Torna al Gestionale"
                                >
                                    ‚Üê Gestionale
                                </button>
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-800">üìä Dashboard Statistiche</h2>
                                    <p className="text-gray-600 mt-1">Analisi attivit√† e performance</p>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2 items-center">
                                {['giorno', 'settimana'].map(p => (
                                    <button
                                        key={p}
                                        onClick={() => {
                                            setPeriodoStats(p);
                                            setDataInizioStats('');
                                            setDataFineStats('');
                                        }}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                            periodoStats === p && !dataInizioStats && !dataFineStats
                                                ? 'bg-orange-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        {p === 'giorno' ? 'Oggi' : 'Settimana'}
                                    </button>
                                ))}
                                
                                {/* Selettore Mese integrato come pulsante */}
                                <div className="relative inline-block">
                                    <input
                                        type="month"
                                        onChange={(e) => {
                                            if (e.target.value) {
                                                const [anno, mese] = e.target.value.split('-');
                                                const primoGiorno = `${anno}-${mese}-01`;
                                                const ultimoGiorno = new Date(anno, parseInt(mese), 0).toISOString().split('T')[0];
                                                setDataInizioStats(primoGiorno);
                                                setDataFineStats(ultimoGiorno);
                                                setPeriodoStats('range');
                                            }
                                        }}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors cursor-pointer ${
                                            periodoStats === 'range' && dataInizioStats && dataFineStats && 
                                            new Date(dataInizioStats).getDate() === 1 && 
                                            new Date(dataFineStats).getDate() === new Date(new Date(dataFineStats).getFullYear(), new Date(dataFineStats).getMonth() + 1, 0).getDate()
                                                ? 'bg-orange-600 text-white border-orange-600'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300 border-gray-300'
                                        } border`}
                                        title="Seleziona mese"
                                        style={{colorScheme: 'light'}}
                                    />
                                </div>
                                
                                {/* Separatore */}
                                <span className="text-gray-400 mx-1">|</span>
                                
                                {/* Range Date Picker Dal-Al */}
                                <div className="flex items-center gap-2">
                                    <span className="text-sm text-gray-600">Dal:</span>
                                    <input
                                        type="date"
                                        value={dataInizioStats}
                                        onChange={(e) => {
                                            setDataInizioStats(e.target.value);
                                            if (e.target.value || dataFineStats) {
                                                setPeriodoStats('range');
                                            }
                                        }}
                                        className={`px-2 py-1 rounded text-sm border transition-colors ${
                                            periodoStats === 'range'
                                                ? 'border-orange-600 bg-orange-50 ring-2 ring-orange-200'
                                                : 'border-gray-300 hover:border-gray-400'
                                        }`}
                                    />
                                    <span className="text-sm text-gray-600">Al:</span>
                                    <input
                                        type="date"
                                        value={dataFineStats}
                                        onChange={(e) => {
                                            setDataFineStats(e.target.value);
                                            if (e.target.value || dataInizioStats) {
                                                setPeriodoStats('range');
                                            }
                                        }}
                                        className={`px-2 py-1 rounded text-sm border transition-colors ${
                                            periodoStats === 'range'
                                                ? 'border-orange-600 bg-orange-50 ring-2 ring-orange-200'
                                                : 'border-gray-300 hover:border-gray-400'
                                        }`}
                                    />
                                    
                                    {/* Pulsante Reset Range */}
                                    {(dataInizioStats || dataFineStats) && periodoStats === 'range' && (
                                        <button
                                            onClick={() => {
                                                setDataInizioStats('');
                                                setDataFineStats('');
                                                setPeriodoStats('settimana');
                                            }}
                                            className="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded hover:bg-red-50"
                                            title="Rimuovi filtro data"
                                        >
                                            ‚úï
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Card riassuntive */}
                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="text-gray-600 text-sm font-medium">Totale Periodo</div>
                            <div className="text-3xl font-bold text-blue-600 mt-2">{stats.totaliPeriodo.totale}</div>
                        </div>
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="text-gray-600 text-sm font-medium">Completate</div>
                            <div className="text-3xl font-bold text-green-600 mt-2">{stats.totaliPeriodo.completate}</div>
                        </div>
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="text-gray-600 text-sm font-medium">In Lavorazione</div>
                            <div className="text-3xl font-bold text-gray-600 mt-2">{stats.distribuzioneStati.inLavorazione}</div>
                        </div>
                        <div 
                            className="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow"
                            onClick={() => setPraticheSelezionate(pratiche.filter(p => p.stato === 'sospesa'))}
                        >
                            <div className="text-gray-600 text-sm font-medium">Sospese</div>
                            <div className="text-3xl font-bold text-red-600 mt-2">{stats.distribuzioneStati.sospese}</div>
                            <div className="text-xs text-gray-500 mt-1">Click per dettagli</div>
                        </div>
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div className="text-gray-600 text-sm font-medium">Tasso Completamento</div>
                            <div className="text-3xl font-bold text-orange-600 mt-2">
                                {stats.totaliPeriodo.totale > 0 
                                    ? Math.round((stats.totaliPeriodo.completate / stats.totaliPeriodo.totale) * 100) 
                                    : 0}%
                            </div>
                        </div>
                    </div>
                    
                    {/* Grafici */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Grafico Pratiche per Utente */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div style={{ height: '300px' }}>
                                <canvas ref={chartUtentiRef}></canvas>
                            </div>
                        </div>
                        
                        {/* Grafico Attivit√† nel Tempo */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div style={{ height: '300px' }}>
                                <canvas ref={chartTempoRef}></canvas>
                            </div>
                        </div>
                        
                        {/* Grafico Distribuzione Stati */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div style={{ height: '300px' }}>
                                <canvas ref={chartStatiRef}></canvas>
                            </div>
                        </div>
                        
                        {/* Grafico Prelavorata vs Normale */}
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <div style={{ height: '300px' }}>
                                <canvas ref={chartPrelavorataRef}></canvas>
                            </div>
                        </div>
                    </div>
                    
                    {/* Tabella dettagli per utente */}
                    <div className="bg-white rounded-lg shadow-md overflow-hidden">
                        <div className="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4">
                            <h3 className="text-lg font-bold">Dettaglio per Utente</h3>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utente</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale Periodo</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completate</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">In Lavorazione</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sospese</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">% Completamento</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {stats.statsPerUtente.map((stat, index) => (
                                        <tr key={index} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900">{stat.utente}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700">{stat.totale}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    {stat.completate}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                    {stat.inLavorazione}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    {stat.sospese}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-gray-700">
                                                {stat.totale > 0 ? Math.round((stat.completate / stat.totale) * 100) : 0}%
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    {/* Popup Pratiche Sospese */}
                    {praticheSelezionate && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setPraticheSelezionate(null)}>
                            <div className="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-auto" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-2xl font-bold text-red-600">üî¥ Pratiche Sospese ({praticheSelezionate.length})</h3>
                                    <button 
                                        onClick={() => setPraticheSelezionate(null)}
                                        className="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                                    >
                                        √ó
                                    </button>
                                </div>
                                
                                {praticheSelezionate.length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">Nessuna pratica sospesa</p>
                                ) : (
                                    <div className="space-y-3">
                                        {praticheSelezionate.map(pratica => (
                                            <div 
                                                key={pratica.id}
                                                className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                                                onClick={() => {
                                                    setPraticheSelezionate(null);
                                                    setVistaStatistiche(false);
                                                    setPraticaSelezionata(pratica);
                                                    setMostraModal('dettagli');
                                                }}
                                            >
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <span className="font-bold text-lg text-gray-900">{pratica.numero}</span>
                                                            <span className="badge badge-secondary">{pratica.codice}</span>
                                                            {pratica.prelavorata && (
                                                                <span className="badge badge-prelavorata">üìù Prelavorata</span>
                                                            )}
                                                        </div>
                                                        <div className="text-sm text-gray-700 space-y-1">
                                                            <div><strong>Intestati:</strong> {pratica.intestati}</div>
                                                            <div><strong>Indirizzo:</strong> {pratica.indirizzo}, {pratica.comune}</div>
                                                            <div><strong>Assegnata a:</strong> {pratica.utenteAssegnato?.nome || 'Non assegnata'}</div>
                                                            {pratica.motivoSospensione && (
                                                                <div className="text-red-600"><strong>Motivo:</strong> {pratica.motivoSospensione}</div>
                                                            )}
                                                            {pratica.dataSospensione && (
                                                                <div className="text-orange-600">
                                                                    <strong>Sospesa da:</strong> {(() => {
                                                                        const oggi = new Date();
                                                                        oggi.setHours(0, 0, 0, 0);
                                                                        const parts = pratica.dataSospensione.split(',')[0].split('/');
                                                                        const dataSosp = new Date(parts[2], parts[1] - 1, parts[0]);
                                                                        const giorni = Math.floor((oggi - dataSosp) / (1000 * 60 * 60 * 24));
                                                                        return `${giorni} giorni`;
                                                                    })()}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <button className="text-blue-600 hover:text-blue-800 font-medium text-sm">
                                                        Vai alla pratica ‚Üí
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function App() {
            // ============================================================
            // VERSIONE APP
            // ============================================================
            const VERSION = "7.17.1 - Gestione Pratiche Manuale";
            
            // Logo Effetre Properties (Base64)
            const LOGO_BASE64 = "data:image/jpeg;base64,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D5xGnFI/R7+07T/nsn50f2naf890/Ovzi/4XF4w/6DU/50f8Lh8X/wDQan/Oub/VGq3e50Sz6PY/R3+07T/nsn502XU7XynxMmdp7+1fnJ/wuLxh/wBBqf8AOkPxh8YEYOtTj6Gqp8K1aVRSCpncKkLFj4zTeZ45vMDI3Nz+NcNVi/1C51O4ae6maeZurt1qvX6dhaP1ejGn2Pj61T2s3PuFFFFdRiFOh/18XGfnX+dNoBIIIOCO9ROPPFx7lRfK0z9E/gBqVunw7tFaZUfd0J9q9MGq2v8Az3T86/MnS/if4m0WzFtZ6rNDEDkKDVv/AIXL4x/6Dc4/GvzXFcL1K1VzT0PraObwpwSP0tXVbT/nun507+1rXH+vT86/NFfjN4yH/Mcn/Ol/4XR4y/6Dc/51y/6oT7m39t0z9LRqtn/z3T86k/tezK8zJ+dfmf8A8Lq8Zf8AQbn/ADo/4XV4y/6Dc/50/wDVGp/MH9uQP0xGq2h/5bJ+dOXVLT/nsn51+Zf/AAunxp2124H40v8AwuvxoP8AmPXH50f6o1O/4on+2oM/TZdVtAf9cg/Gn/2tZ/8APdPzr8xv+F1+NO+u3B/Gl/4XX4z/AOg5cfnS/wBUanf8g/tqB+nH9qWX/PdPzp66lZ4z56c+9fmJ/wALs8af9By4/Oj/AIXZ417a9cCn/qlU7j/tqB+no1O0XpOn505dVtCwPnI2OwNfl/8A8Ls8bf8AQeuPzoHxt8cDka/cKfUGojwnVjK9wlnUGj6v/bQ1CG78ByJG4MnmJwK+F04UA+ldL4g+IniHxVbeRqmpzXcWQSHPWucr7/LMA8DT5WfNYzE/WJXCiiivaOAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//9k=";
            
            // ============================================================
            // STATE
            // ============================================================
            const [pratiche, setPratiche] = useState([]);
            const [utenti, setUtenti] = useState(UTENTI_INIZIALI);
            const [schermata, setSchermata] = useState('home');
            const [utenteCorrente, setUtenteCorrente] = useState(null);
            const [usernameInserito, setUsernameInserito] = useState('');
            const [passwordInserita, setPasswordInserita] = useState('');
            const [erroreLogin, setErroreLogin] = useState('');
            const [mostraRecuperoPassword, setMostraRecuperoPassword] = useState(false);
            const [usernameRecupero, setUsernameRecupero] = useState('');
            const [emailRecupero, setEmailRecupero] = useState('');
            const [faseRecupero, setFaseRecupero] = useState(1); // 1=username, 2=email, 3=conferma
            const [passwordRecuperata, setPasswordRecuperata] = useState(null);
            const [erroreRecupero, setErroreRecupero] = useState('');
            const [invioEmailInCorso, setInvioEmailInCorso] = useState(false);
            const [emailInviataConSuccesso, setEmailInviataConSuccesso] = useState(false);
            const [notifiche, setNotifiche] = useState({});
            const [mostraNotifiche, setMostraNotifiche] = useState(false);
            const [filtro, setFiltro] = useState('tutte');
            const [cercaTesto, setCercaTesto] = useState('');
            const [vistaAgenda, setVistaAgenda] = useState(false);
            const [mostraModal, setMostraModal] = useState(null);
            const [praticaSelezionata, setPraticaSelezionata] = useState(null);
            const [motivoSospensione, setMotivoSospensione] = useState('');
            const [noteSopralluogo, setNoteSopralluogo] = useState('');
            const [utenteRiassegnazione, setUtenteRiassegnazione] = useState(null);
            const [firebaseConnesso, setFirebaseConnesso] = useState(firebaseInitialized);
            
            // NUOVI STATI V7.9 - Filtri avanzati
            const [subFiltroMie, setSubFiltroMie] = useState('tutte'); // in-lavorazione, completate, tutte
            const [filtroUtente, setFiltroUtente] = useState(null); // ID utente per filtrare (admin)
            const [filtroTemporale, setFiltroTemporale] = useState('tutte'); // oggi, settimana, tutte, range
            const [dataInizio, setDataInizio] = useState(''); // Data inizio range
            const [dataFine, setDataFine] = useState(''); // Data fine range
            const [dropdownAperto, setDropdownAperto] = useState(null); // 'mie', 'in-lavorazione', 'sospese', 'completate', null
            
            // NUOVI STATI V7.9 FASE 2 - Statistiche
            const [vistaStatistiche, setVistaStatistiche] = useState(false);
            const [periodoStats, setPeriodoStats] = useState('settimana'); // giorno, settimana, mese, range
            const [dataInizioStats, setDataInizioStats] = useState(''); // Data inizio range statistiche
            const [dataFineStats, setDataFineStats] = useState(''); // Data fine range statistiche
            const [mostraPopupSospese, setMostraPopupSospese] = useState(false);
            
            // Stati Analisi Automatica Documenti
            const [utenteAnalisi, setUtenteAnalisi] = useState(null);
            const [usernameAnalisi, setUsernameAnalisi] = useState('');
            const [passwordAnalisi, setPasswordAnalisi] = useState('');
            const [erroreLoginAnalisi, setErroreLoginAnalisi] = useState('');
            const [filesVisure, setFilesVisure] = useState([]); // Array di visure multiple
            const [fileAtto, setFileAtto] = useState(null);
            const [analisiInCorso, setAnalisiInCorso] = useState(false);
            const [progressoAnalisi, setProgressoAnalisi] = useState(0);
            const [messaggioProgresso, setMessaggioProgresso] = useState('');
            const [datiEstratti, setDatiEstratti] = useState(null);
            const [risultatoAnalisi, setRisultatoAnalisi] = useState(null);
            const [mostraDettaglioPagina, setMostraDettaglioPagina] = useState(null);
            const [dragOverVisura, setDragOverVisura] = useState(false);
            const [dragOverAtto, setDragOverAtto] = useState(false);
            
            // Stati per visualizzatore PDF con verifica dati
            const [pdfViewer, setPdfViewer] = useState({
                isOpen: false,
                tipo: null, // 'atto' o 'visura'
                pagina: 1,
                titoloDato: '',
                pdfUrl: null
            });
            
            // State per gestione utenti (solo Davide super-admin)
            const [mostraFormUtente, setMostraFormUtente] = useState(false);
            const [utenteInModifica, setUtenteInModifica] = useState(null);
            const [formUtente, setFormUtente] = useState({
                nome: '',
                email: '',
                username: '',
                password: '',
                ruolo: 'Tecnico',
                isAdmin: false
            });
            
            // State per inserimento/modifica pratiche manuale
            const [mostraFormPratica, setMostraFormPratica] = useState(false);
            const [praticaInModifica, setPraticaInModifica] = useState(null);
            const [formPratica, setFormPratica] = useState({
                nOrdine: '',
                numero: '',
                codice: 'ISP',
                comune: '',
                indirizzo: '',
                osservazioni: '',
                dataSopralluogo: ''
            });
            
            const fileInputRef = useRef(null);
            const isUpdatingFromFirebase = useRef(false);

            // ============================================================
            // ‚≠ê FIREBASE: FUNZIONE HELPER PER SALVARE SU FIREBASE
            // ============================================================
            const salvasuFirebase = async (nuovePratiche) => {
                if (!firebaseInitialized || !db) {
                    // Fallback a localStorage
                    localStorage.setItem('pratiche_effetre', JSON.stringify(nuovePratiche));
                    return;
                }

                try {
                    await db.collection('pratiche')
                        .doc('data')
                        .set({
                            pratiche: nuovePratiche,
                            ultimoAggiornamento: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log('‚úÖ Pratiche salvate su Firebase');
                    setFirebaseConnesso(true);
                } catch (error) {
                    console.error('‚ùå Errore salvataggio Firebase:', error);
                    setFirebaseConnesso(false);
                    // Fallback a localStorage
                    localStorage.setItem('pratiche_effetre', JSON.stringify(nuovePratiche));
                }
            };

            // ============================================================
            // üîî FIREBASE: NOTIFICHE (SEMPLICE - NO LISTENER)
            // ============================================================
            
            const salvaNotificheFirebase = async (userId, notificheArray) => {
                console.log(`üîµ salvaNotificheFirebase chiamata per ${userId}`, {
                    firebaseInitialized,
                    hasDb: !!db,
                    notificheCount: notificheArray.length
                });
                
                if (!firebaseInitialized || !db) {
                    console.error('‚ùå Firebase NON inizializzato! Notifica NON salvata!');
                    return;
                }
                
                try {
                    await db.collection('notifiche').doc(userId).set({
                        notifiche: notificheArray,
                        ultimoAggiornamento: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`‚úÖ Notifiche salvate per ${userId} su Firebase`);
                } catch (error) {
                    console.error('‚ùå Errore salvataggio notifiche:', error);
                }
            };

            const caricaNotificheFirebase = async (userId) => {
                console.log(`üîµ caricaNotificheFirebase chiamata per ${userId}`, {
                    firebaseInitialized,
                    hasDb: !!db
                });
                
                if (!firebaseInitialized || !db) {
                    console.error('‚ùå Firebase NON inizializzato! Impossibile caricare notifiche!');
                    return [];
                }
                
                try {
                    const doc = await db.collection('notifiche').doc(userId).get();
                    if (doc.exists) {
                        return doc.data().notifiche || [];
                    }
                    return [];
                } catch (error) {
                    console.error('‚ùå Errore caricamento notifiche:', error);
                    return [];
                }
            };

            const aggiungiNotificaFirebase = async (userId, nuovaNotifica) => {
                const notificheAttuali = await caricaNotificheFirebase(userId);
                notificheAttuali.push(nuovaNotifica);
                await salvaNotificheFirebase(userId, notificheAttuali);
            };

            const rimuoviNotificaFirebase = async (userId, notificaId) => {
                const notificheAttuali = await caricaNotificheFirebase(userId);
                const notificheFiltrate = notificheAttuali.filter(n => n.id !== notificaId);
                await salvaNotificheFirebase(userId, notificheFiltrate);
            };

            // ============================================================
            // ‚≠ê FIREBASE: SINCRONIZZAZIONE IN TEMPO REALE (SOLO LETTURA)
            // ============================================================
            useEffect(() => {
                if (!firebaseInitialized || !db) {
                    // Fallback a localStorage se Firebase non √® configurato
                    const saved = localStorage.getItem('pratiche_effetre');
                    if (saved) {
                        setPratiche(JSON.parse(saved));
                    }
                    return;
                }

                console.log('üîÑ Attivazione listener Firebase per pratiche...');
                
                // Ascolta i cambiamenti in tempo reale
                const unsubscribe = db.collection('pratiche')
                    .doc('data')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log('üì• Dati ricevuti da Firebase:', data.pratiche?.length || 0, 'pratiche');
                            
                            // Setta il flag per indicare che l'update viene da Firebase
                            isUpdatingFromFirebase.current = true;
                            setPratiche(data.pratiche || []);
                            setFirebaseConnesso(true);
                            
                            // Resetta il flag dopo un breve delay
                            setTimeout(() => {
                                isUpdatingFromFirebase.current = false;
                            }, 100);
                        } else {
                            console.log('üìÑ Nessun dato esistente in Firebase');
                            isUpdatingFromFirebase.current = true;
                            setPratiche([]);
                            setTimeout(() => {
                                isUpdatingFromFirebase.current = false;
                            }, 100);
                        }
                    }, (error) => {
                        console.error('‚ùå Errore listener Firebase:', error);
                        setFirebaseConnesso(false);
                        // Fallback a localStorage
                        const saved = localStorage.getItem('pratiche_effetre');
                        if (saved) {
                            setPratiche(JSON.parse(saved));
                        }
                    });

                // Cleanup
                return () => unsubscribe();
            }, []);

            // ============================================================
            // ‚≠ê FIREBASE: GESTIONE UTENTI (SOLO SUPER-ADMIN)
            // ============================================================
            useEffect(() => {
                if (!firebaseInitialized || !db) {
                    // Fallback a utenti iniziali se Firebase non √® configurato
                    setUtenti(UTENTI_INIZIALI);
                    return;
                }

                console.log('üîÑ Attivazione listener Firebase per utenti...');
                
                // Ascolta i cambiamenti in tempo reale
                const unsubscribe = db.collection('utenti')
                    .doc('lista')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log('üì• Utenti ricevuti da Firebase:', data.utenti?.length || 0);
                            
                            // MIGRAZIONE AUTOMATICA: Converti ID numerici in ID stringa
                            let utentiMigrati = data.utenti || UTENTI_INIZIALI;
                            let necessitaMigrazione = false;
                            
                            utentiMigrati = utentiMigrati.map(u => {
                                if (typeof u.id === 'number') {
                                    console.log(`üîÑ Migrazione ID utente ${u.nome}: ${u.id} ‚Üí ${u.username}`);
                                    necessitaMigrazione = true;
                                    return { ...u, id: u.username };
                                }
                                return u;
                            });
                            
                            // Se c'√® stata migrazione, salva su Firebase
                            if (necessitaMigrazione) {
                                console.log('üíæ Salvataggio utenti migrati su Firebase...');
                                db.collection('utenti').doc('lista').set({
                                    utenti: utentiMigrati,
                                    ultimoAggiornamento: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                            
                            setUtenti(utentiMigrati);
                        } else {
                            // Prima volta: salva gli utenti iniziali su Firebase
                            console.log('üìÑ Inizializzazione utenti su Firebase...');
                            db.collection('utenti').doc('lista').set({
                                utenti: UTENTI_INIZIALI,
                                ultimoAggiornamento: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            setUtenti(UTENTI_INIZIALI);
                        }
                    }, (error) => {
                        console.error('‚ùå Errore listener Firebase utenti:', error);
                        setUtenti(UTENTI_INIZIALI);
                    });

                // Cleanup
                return () => unsubscribe();
            }, []);

            const salvaUtentisuFirebase = async (nuoviUtenti) => {
                if (!firebaseInitialized || !db) {
                    console.warn('‚ö†Ô∏è Firebase non disponibile per salvare utenti');
                    return;
                }

                try {
                    await db.collection('utenti')
                        .doc('lista')
                        .set({
                            utenti: nuoviUtenti,
                            ultimoAggiornamento: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    console.log('‚úÖ Utenti salvati su Firebase');
                } catch (error) {
                    console.error('‚ùå Errore salvataggio utenti Firebase:', error);
                    alert('Errore durante il salvataggio degli utenti: ' + error.message);
                }
            };

            // ============================================================
            // üîî FIREBASE: LISTENER REAL-TIME NOTIFICHE
            // ============================================================
            useEffect(() => {
                // Solo se utente loggato e Firebase inizializzato
                if (!utenteCorrente || !firebaseInitialized || !db) {
                    return;
                }

                console.log(`üîî Attivazione listener notifiche per ${utenteCorrente.nome}...`);
                
                // Ascolta le notifiche in tempo reale
                const unsubscribe = db.collection('notifiche')
                    .doc(utenteCorrente.id)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            const notificheFirebase = data.notifiche || [];
                            
                            console.log(`üì• Notifiche real-time per ${utenteCorrente.nome}:`, notificheFirebase.length);
                            
                            // Aggiorna state notifiche
                            const nuoveNotifiche = { ...notifiche };
                            nuoveNotifiche[utenteCorrente.id] = notificheFirebase;
                            setNotifiche(nuoveNotifiche);
                            
                            // Se ci sono notifiche di riassegnazione E non stiamo gi√† mostrando il modale
                            const notificheRiassegnazione = notificheFirebase.filter(n => n.richiede_conferma);
                            if (notificheRiassegnazione.length > 0 && !mostraNotifiche && schermata === 'app') {
                                console.log(`üîî Nuove notifiche riassegnazione! Mostro modale...`);
                                setMostraNotifiche(true);
                            }
                        } else {
                            // Nessuna notifica
                            const nuoveNotifiche = { ...notifiche };
                            nuoveNotifiche[utenteCorrente.id] = [];
                            setNotifiche(nuoveNotifiche);
                        }
                    }, (error) => {
                        console.error('‚ùå Errore listener notifiche:', error);
                    });

                // Cleanup
                return () => {
                    console.log(`üîï Disattivazione listener notifiche per ${utenteCorrente.nome}`);
                    unsubscribe();
                };
            }, [utenteCorrente, firebaseInitialized, db]);

            // Salvataggio notifiche su localStorage (backup)
            useEffect(() => {
                localStorage.setItem('notifiche_effetre', JSON.stringify(notifiche));
            }, [notifiche]);

            // Carica notifiche all'avvio
            useEffect(() => {
                const saved = localStorage.getItem('notifiche_effetre');
                if (saved) {
                    setNotifiche(JSON.parse(saved));
                }
            }, []);

            // ============================================================
            // PARSER KML/KMZ
            // ============================================================
            const parseKML = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    const LAYER_ESCLUSI = [
                        'lavori da ultimare',
                        'da programmare',
                        'sospensioni momentanee',
                        'milano top intesa',
                        'annullate'
                    ];
                    
                    reader.onload = async (e) => {
                        try {
                            let kmlText = '';
                            
                            if (file.name.endsWith('.kmz')) {
                                const arrayBuffer = e.target.result;
                                const zip = await JSZip.loadAsync(arrayBuffer);
                                const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
                                if (!kmlFile) {
                                    throw new Error('File KML non trovato nel KMZ');
                                }
                                kmlText = await zip.files[kmlFile].async('text');
                            } else {
                                kmlText = e.target.result;
                            }
                            
                            console.log('üìÑ Parsing KML iniziato...');
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
                            
                            const placemarks = xmlDoc.getElementsByTagName('Placemark');
                            console.log(`üìç Trovati ${placemarks.length} placemarks`);
                            
                            const pratiche = [];
                            let praticheEscluse = 0;
                            
                            for (let i = 0; i < placemarks.length; i++) {
                                const placemark = placemarks[i];
                                
                                let appartieneFolderEscluso = false;
                                let nomeFolder = '';
                                
                                let parent = placemark.parentNode;
                                while (parent && parent.nodeName !== 'Document') {
                                    if (parent.nodeName === 'Folder') {
                                        const folderNameElement = parent.getElementsByTagName('name')[0];
                                        if (folderNameElement) {
                                            nomeFolder = folderNameElement.textContent.trim().toLowerCase();
                                            
                                            if (LAYER_ESCLUSI.some(layer => nomeFolder.includes(layer))) {
                                                appartieneFolderEscluso = true;
                                                console.log(`‚è≠Ô∏è Placemark saltato: appartiene al layer escluso "${nomeFolder}"`);
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                    parent = parent.parentNode;
                                }
                                
                                if (appartieneFolderEscluso) {
                                    praticheEscluse++;
                                    continue;
                                }
                                
                                const nome = placemark.getElementsByTagName('name')[0]?.textContent?.trim() || '';
                                const descrizioneRaw = placemark.getElementsByTagName('description')[0]?.textContent?.trim() || '';
                                
                                // ‚ö†Ô∏è ESCLUDI righe con "pausa" 
                                const nomeLower = nome.toLowerCase();
                                const descrizioneRawLower = descrizioneRaw.toLowerCase();
                                if (nomeLower.includes('pausa') || descrizioneRawLower.includes('pausa')) {
                                    console.log(`‚è≠Ô∏è Placemark saltato: contiene "pausa" - ${nome}`);
                                    praticheEscluse++;
                                    continue;
                                }
                                
                                if (nomeFolder) {
                                    console.log(`üìÅ Layer: ${nomeFolder}`);
                                }
                                
                                const tempDiv = document.createElement('div');
                                // PRIMA converti <br> in newline, POI estrai il testo
                                tempDiv.innerHTML = descrizioneRaw.replace(/<br\s*\/?>/gi, '\n');
                                let descrizione = tempDiv.textContent || tempDiv.innerText || descrizioneRaw;
                                
                                descrizione = descrizione
                                    .replace(/\u00A0/g, ' ')
                                    .replace(/&nbsp;/g, ' ')
                                    .replace(/\xa0/g, ' ')
                                    .trim();
                                
                                console.log(`üìÑ Descrizione processata:`, descrizione.substring(0, 200));
                                
                                const praticaData = {
                                    nOrdine: null,  // Numero d'ordine sopralluogo
                                    numero: '',      // Codice pratica (es: 789.488)
                                    codice: '',      // Tipo pratica (es: ISP, OSTD)
                                    comune: '',      // Comune estratto
                                    indirizzo: '',   // Solo via/numero civico
                                    intestati: '',   // Solo in dettagli
                                    giorno: '',      // Solo in dettagli
                                    note: '',        // Solo in dettagli
                                    osservazioni: '' // Campo editabile in tabella
                                };
                                
                                // ============================================================
                                // PARSER NOME - VERSIONE ULTRA SEMPLIFICATA
                                // ============================================================
                                if (nome) {
                                    console.log(`üîç Parsing: "${nome}"`);
                                    let testo = nome.trim();
                                    
                                    // STEP 1: Estrai N. ORDINE (primo numero seguito da spazio)
                                    // Esempio: "1 Via..." ‚Üí nOrdine = 1
                                    const matchOrdine = testo.match(/^(\d+)\s+/);
                                    if (matchOrdine) {
                                        praticaData.nOrdine = parseInt(matchOrdine[1]);
                                        testo = testo.substring(matchOrdine[0].length);
                                        console.log(`  ‚úÖ N. ordine: ${praticaData.nOrdine}`);
                                    }
                                    
                                    // STEP 2: Trova la DATA (formato XX/XX)
                                    // Tutto PRIMA della data √® l'indirizzo+comune
                                    const matchData = testo.match(/(\d{1,2}\/\d{1,2})/);
                                    let testoIndirizzo = testo;
                                    
                                    if (matchData) {
                                        praticaData.giorno = matchData[1];
                                        testoIndirizzo = testo.substring(0, matchData.index).trim();
                                        console.log(`  ‚úÖ Giorno: ${praticaData.giorno}`);
                                    }
                                    
                                    // STEP 3: Rimuovi il trattino finale se presente
                                    // "Via Roma, 6 Milano-" ‚Üí "Via Roma, 6 Milano"
                                    testoIndirizzo = testoIndirizzo.replace(/[\-\s]+$/, '').trim();
                                    
                                    // STEP 4: Rimuovi parentesi e contenuto
                                    // "Via Roma, 6 Milano (note)" ‚Üí "Via Roma, 6 Milano"
                                    testoIndirizzo = testoIndirizzo.replace(/\s*\([^)]*\)\s*/g, ' ').trim();
                                    
                                    // STEP 5: Cerca la VIRGOLA (separa via da numero civico)
                                    // Pattern: "Via Nome, NUMERO COMUNE"
                                    const indexVirgola = testoIndirizzo.indexOf(',');
                                    
                                    if (indexVirgola > 0) {
                                        // C'√® una virgola!
                                        const via = testoIndirizzo.substring(0, indexVirgola).trim();
                                        const restoDopo = testoIndirizzo.substring(indexVirgola + 1).trim();
                                        
                                        // restoDopo = "6 Robecco SN" o "8 Trezzano SN"
                                        // Dividi in parole
                                        const parole = restoDopo.split(/\s+/);
                                        
                                        if (parole.length >= 2) {
                                            // Prima parola = numero civico
                                            // Resto = comune
                                            const numeroCivico = parole[0];
                                            const comune = parole.slice(1).join(' ');
                                            
                                            praticaData.indirizzo = `${via}, ${numeroCivico}`;
                                            praticaData.comune = comune;
                                            
                                            console.log(`  ‚úÖ Indirizzo: "${praticaData.indirizzo}"`);
                                            console.log(`  ‚úÖ Comune: "${praticaData.comune}"`);
                                        } else {
                                            // Solo numero, nessun comune
                                            praticaData.indirizzo = `${via}, ${restoDopo}`;
                                            praticaData.comune = 'NON SPECIFICATO';
                                            console.log(`  ‚ö†Ô∏è Solo numero: "${praticaData.indirizzo}"`);
                                        }
                                    } else {
                                        // Nessuna virgola - tutto va nell'indirizzo
                                        praticaData.indirizzo = testoIndirizzo;
                                        praticaData.comune = 'NON SPECIFICATO';
                                        console.log(`  ‚ö†Ô∏è No virgola: "${praticaData.indirizzo}"`);
                                    }
                                }
                                
                                // ============================================================
                                // PARSER ALTERNATIVO DA DESCRIZIONE (se comune non trovato)
                                // ============================================================
                                // Se il parsing dal nome non ha trovato il comune,
                                // prova a estrarre via, civico e comune dalla descrizione
                                if (praticaData.comune === 'NON SPECIFICATO' && descrizione) {
                                    console.log(`üîç Comune non trovato nel nome, cerco nella descrizione...`);
                                    
                                    const lines = descrizione.split('\n').map(l => l.trim()).filter(l => l);
                                    
                                    // Cerca pattern multipli per gestire formati diversi
                                    for (let line of lines) {
                                        let via, numero, comune;
                                        
                                        // PATTERN 1: Con virgole e CAP opzionale
                                        // "Via Giovanni Pascoli, 4, 20129 Milano MI"
                                        // "Via Nome, 13, Cusago MI"
                                        const viaMatch1 = line.match(/^([Vv]ia\s+[^,]+),\s*(\d+),?\s*(?:\d{5}\s+)?([A-Za-z\s]+?)(?:\s+[A-Z]{2})?$/);
                                        
                                        if (viaMatch1) {
                                            via = viaMatch1[1].trim();
                                            numero = viaMatch1[2];
                                            const comuneCompleto = viaMatch1[3].trim();
                                            // Prendi prima parola come comune (ignora provincia)
                                            comune = comuneCompleto.split(/\s+/)[0];
                                            
                                            console.log(`  ‚úÖ [PATTERN 1] Via: "${via}", Numero: "${numero}", Comune: "${comune}"`);
                                        }
                                        
                                        // PATTERN 2: Senza virgole
                                        // "Via Riccardo Pick Mangiagalli 2014 Milano MI"
                                        if (!via) {
                                            const viaMatch2 = line.match(/^([Vv]ia\s+.+?)\s+(\d{1,4})\s+(.+)$/);
                                            if (viaMatch2) {
                                                via = viaMatch2[1].trim();
                                                numero = viaMatch2[2];
                                                const restoDopo = viaMatch2[3].trim();
                                                // Prendi prima parola come comune
                                                comune = restoDopo.split(/\s+/)[0];
                                                
                                                console.log(`  ‚úÖ [PATTERN 2] Via: "${via}", Numero: "${numero}", Comune: "${comune}"`);
                                            }
                                        }
                                        
                                        if (via && numero && comune) {
                                            praticaData.indirizzo = `${via}, ${numero}`;
                                            praticaData.comune = comune;
                                            
                                            console.log(`  ‚úÖ [DA DESCRIZIONE] Indirizzo: "${praticaData.indirizzo}"`);
                                            console.log(`  ‚úÖ [DA DESCRIZIONE] Comune: "${praticaData.comune}"`);
                                            break;
                                        }
                                    }
                                }
                                
                                // Estrai codice, numero, intestati dalla descrizione
                                if (descrizione) {
                                    const lines = descrizione.split('\n').map(l => l.trim()).filter(l => l);
                                    const noteLines = [];
                                    
                                    for (let idx = 0; idx < lines.length; idx++) {
                                        const line = lines[idx];
                                        const lineLower = line.toLowerCase();
                                        
                                        if (!praticaData.numero) {
                                            const matchCodiceNumero = line.match(/([A-Z]+)\s+(\d{3}\.\d{3})/);
                                            if (matchCodiceNumero) {
                                                praticaData.codice = matchCodiceNumero[1];
                                                praticaData.numero = matchCodiceNumero[2];
                                                continue;
                                            }
                                            
                                            const matchSoloNumero = line.match(/^(\d{3}\.\d{3})$/);
                                            if (matchSoloNumero) {
                                                praticaData.numero = matchSoloNumero[1];
                                                praticaData.codice = 'ISP';
                                                continue;
                                            }
                                            
                                            const matchFlexible = line.match(/([A-Z]+)?\s*(\d+\.?\d*)/);
                                            if (matchFlexible && matchFlexible[2] && matchFlexible[2].length >= 4) {
                                                if (matchFlexible[1]) {
                                                    praticaData.codice = matchFlexible[1];
                                                } else {
                                                    praticaData.codice = 'ISP';
                                                }
                                                praticaData.numero = matchFlexible[2];
                                                continue;
                                            }
                                        }
                                        
                                        if (lineLower.includes('intestat')) {
                                            // Trova la riga con "intestat" e prendi tutto quello che viene dopo
                                            let intestatiText = line;
                                            
                                            // Rimuovi "intestati:" o "intestato:" o "intestata:" con variazioni
                                            // Gestisce anche casi senza ":"
                                            intestatiText = intestatiText.replace(/.*?intestat[oia]*\s*[:;\-]?\s*/i, '').trim();
                                            
                                            // Se la riga aveva solo "intestati:" senza testo, controlla la riga successiva
                                            if (!intestatiText && idx + 1 < lines.length) {
                                                intestatiText = lines[idx + 1].trim();
                                                idx++; // Salta la riga successiva nel loop
                                            }
                                            
                                            // PULIZIA AGGRESSIVA:
                                            // 1. Sostituisci TAB con spazi
                                            intestatiText = intestatiText.replace(/\t/g, ' ');
                                            // 2. Sostituisci NBSP e caratteri strani con spazi
                                            intestatiText = intestatiText.replace(/[\u00A0\xa0]/g, ' ');
                                            // 3. Sostituisci spazi multipli con uno solo
                                            intestatiText = intestatiText.replace(/\s+/g, ' ');
                                            // 4. Rimuovi eventuali tag <br> residui
                                            intestatiText = intestatiText.replace(/<br\s*\/?>/gi, ' ');
                                            // 5. Rimuovi caratteri di separazione finali
                                            intestatiText = intestatiText.replace(/^[:\-;\s]+/, '').replace(/[:\-;\s]+$/, '');
                                            // 6. Trim finale
                                            intestatiText = intestatiText.trim();
                                            
                                            if (intestatiText && intestatiText.length > 0) {
                                                praticaData.intestati = intestatiText.toUpperCase();
                                                console.log(`‚úÖ Intestati trovati per pratica ${praticaData.numero || 'N/D'}: "${praticaData.intestati}"`);
                                                continue;
                                            } else {
                                                console.log(`‚ö†Ô∏è Intestati vuoto nella riga: "${line}"`);
                                            }
                                        }
                                        
                                        noteLines.push(line);
                                    }
                                    
                                    praticaData.note = noteLines.join('\n');
                                }
                                
                                // Valori di default
                                if (!praticaData.numero) {
                                    const numeroMatch = nome.match(/\d{3}\.\d{3}/);
                                    if (numeroMatch) {
                                        praticaData.numero = numeroMatch[0];
                                        praticaData.codice = 'ISP';
                                    }
                                }
                                
                                if (!praticaData.codice && praticaData.numero) {
                                    praticaData.codice = 'ISP';
                                }
                                
                                if (!praticaData.intestati) {
                                    praticaData.intestati = 'NON SPECIFICATO';
                                }
                                
                                if (!praticaData.giorno) {
                                    const oggi = new Date();
                                    const giorni = ['domenica', 'luned√¨', 'marted√¨', 'mercoled√¨', 'gioved√¨', 'venerd√¨', 'sabato'];
                                    const giorno = giorni[oggi.getDay()];
                                    const data = oggi.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                                    praticaData.giorno = `${giorno} ${data}`;
                                }
                                
                                // Coordinate
                                const coordElement = placemark.getElementsByTagName('coordinates')[0];
                                if (coordElement) {
                                    const coordText = coordElement.textContent.trim();
                                    const coords = coordText.split(',').map(c => parseFloat(c.trim()));
                                    if (coords.length >= 2) {
                                        praticaData.coordinate = [coords[0], coords[1]];
                                    }
                                }
                                
                                pratiche.push({
                                    id: Date.now() + i,
                                    ...praticaData,
                                    stato: 'disponibile',
                                    utenteAssegnato: null,
                                    storico: [{
                                        data: new Date().toLocaleString('it-IT'),
                                        utente: 'Sistema',
                                        azione: 'Import',
                                        dettagli: 'Pratica importata da KML'
                                    }]
                                });
                            }
                            
                            console.log(`‚úÖ Import completato: ${pratiche.length} pratiche importate, ${praticheEscluse} escluse`);
                            resolve(pratiche);
                        } catch (error) {
                            console.error('‚ùå Errore durante il parsing:', error);
                            reject(error);
                        }
                    };
                    
                    if (file.name.endsWith('.kmz')) {
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.readAsText(file);
                    }
                });
            };

            const caricaFileIncrement = async (file) => {
                try {
                    console.log('üìÇ Inizio caricamento file:', file.name);
                    const nuovePratiche = await parseKML(file);
                    
                    const praticheEsistenti = pratiche;
                    const numeriEsistenti = new Set(praticheEsistenti.map(p => p.numero));
                    
                    const praticheDaAggiungere = nuovePratiche.filter(p => !numeriEsistenti.has(p.numero));
                    const praticheDuplicate = nuovePratiche.length - praticheDaAggiungere.length;
                    
                    const praticheAggiornate = [...praticheEsistenti, ...praticheDaAggiungere];
                    setPratiche(praticheAggiornate);
                    salvasuFirebase(praticheAggiornate);
                    
                    alert(`‚úÖ Import completato!\n\n` +
                          `‚Ä¢ Pratiche nuove aggiunte: ${praticheDaAggiungere.length}\n` +
                          `‚Ä¢ Pratiche gi√† esistenti (ignorate): ${praticheDuplicate}\n` +
                          `‚Ä¢ Totale pratiche nel sistema: ${praticheAggiornate.length}`);
                    
                    setSchermata('home');
                    
                } catch (error) {
                    console.error('‚ùå Errore caricamento file:', error);
                    alert('‚ùå Errore durante il caricamento del file.\n\nDettagli: ' + error.message);
                }
            };

            // ============================================================
            // FUNZIONI GESTIONE UTENTE
            // ============================================================
            const handleLogin = async () => {
                const utente = utenti.find(u => u.username === usernameInserito && u.password === passwordInserita);
                if (utente) {
                    setUtenteCorrente(utente);
                    setUsernameInserito('');
                    setPasswordInserita('');
                    setErroreLogin('');
                    
                    // Il listener real-time caricher√† automaticamente le notifiche
                    // Vai direttamente all'app
                    setSchermata('app');
                    
                    console.log(`‚úÖ Login effettuato: ${utente.nome}`);
                } else {
                    setErroreLogin('‚ùå Username o password non validi');
                }
            };

            // ============================================================
            // FUNZIONE RECUPERO PASSWORD
            // ============================================================
            const handleRecuperoPassword = async () => {
                setErroreRecupero('');
                
                // FASE 1: Verifica username
                if (faseRecupero === 1) {
                    if (!usernameRecupero.trim()) {
                        setErroreRecupero('‚ö†Ô∏è Inserisci il tuo username');
                        return;
                    }
                    
                    const utente = utenti.find(u => u.username.toLowerCase() === usernameRecupero.trim().toLowerCase());
                    
                    if (utente) {
                        setPasswordRecuperata({
                            password: utente.password,
                            nome: utente.nome,
                            emailRegistrata: utente.email // Salva email registrata per verifica
                        });
                        setFaseRecupero(2); // Passa alla fase email
                    } else {
                        setErroreRecupero('‚ùå Username non trovato nel sistema');
                    }
                }
                // FASE 2: Verifica email e invia
                else if (faseRecupero === 2) {
                    if (!emailRecupero.trim()) {
                        setErroreRecupero('‚ö†Ô∏è Inserisci un indirizzo email valido');
                        return;
                    }
                    
                    // Validazione email semplice
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(emailRecupero.trim())) {
                        setErroreRecupero('‚ö†Ô∏è Formato email non valido');
                        return;
                    }
                    
                    // üîí VERIFICA SICUREZZA: l'email deve corrispondere a quella registrata
                    if (emailRecupero.trim().toLowerCase() !== passwordRecuperata.emailRegistrata.toLowerCase()) {
                        setErroreRecupero('‚ùå L\'email inserita non corrisponde a quella registrata per questo account');
                        return;
                    }
                    
                    // Verifica se EmailJS √® configurato
                    if (!emailjsInitialized || EMAILJS_CONFIG.PUBLIC_KEY === "IL_TUO_PUBLIC_KEY") {
                        setErroreRecupero('‚ö†Ô∏è Sistema email non configurato. Contatta l\'amministratore.');
                        console.error('‚ùå EmailJS non configurato - Impossibile inviare email');
                        return;
                    }
                    
                    // Invia email con EmailJS
                    setInvioEmailInCorso(true);
                    
                    try {
                        const templateParams = {
                            to_email: emailRecupero.trim(),
                            to_name: passwordRecuperata.nome,
                            password: passwordRecuperata.password,
                            from_name: "Effetre Properties"
                        };
                        
                        await emailjs.send(
                            EMAILJS_CONFIG.SERVICE_ID,
                            EMAILJS_CONFIG.TEMPLATE_ID,
                            templateParams
                        );
                        
                        console.log(`‚úÖ Email inviata con successo a ${emailRecupero}`);
                        setEmailInviataConSuccesso(true);
                        setPasswordRecuperata({
                            ...passwordRecuperata,
                            email: emailRecupero.trim()
                        });
                        setFaseRecupero(3); // Passa alla conferma
                        
                    } catch (error) {
                        console.error('‚ùå Errore invio email:', error);
                        setErroreRecupero('‚ùå Errore durante l\'invio dell\'email. Riprova.');
                        setEmailInviataConSuccesso(false);
                    } finally {
                        setInvioEmailInCorso(false);
                    }
                }
            };
            
            const chiudiRecuperoPassword = () => {
                setMostraRecuperoPassword(false);
                setUsernameRecupero('');
                setEmailRecupero('');
                setFaseRecupero(1);
                setPasswordRecuperata(null);
                setErroreRecupero('');
                setInvioEmailInCorso(false);
                setEmailInviataConSuccesso(false);
                setErroreRecupero('');
            };

            const confermaNotifiche = async () => {
                // Cancella notifiche NON riassegnazione da Firebase
                const notificheUtente = notifiche[utenteCorrente.id] || [];
                const notificheDaCancellare = notificheUtente.filter(n => !n.richiede_conferma);
                
                for (const notifica of notificheDaCancellare) {
                    await rimuoviNotificaFirebase(utenteCorrente.id, notifica.id);
                }
                
                // Ricarica notifiche rimanenti
                const notificheAggiornate = await caricaNotificheFirebase(utenteCorrente.id);
                const nuoveNotifiche = { ...notifiche };
                nuoveNotifiche[utenteCorrente.id] = notificheAggiornate;
                setNotifiche(nuoveNotifiche);
                
                setMostraNotifiche(false);
                setSchermata('app');
            };

            const cancellaUttiDati = () => {
                // ‚ö†Ô∏è SOLO DAVIDE pu√≤ cancellare i dati
                if (utenteCorrente.username !== 'Davide') {
                    alert('‚õî ACCESSO NEGATO\n\nSolo l\'amministratore Davide pu√≤ cancellare tutti i dati.');
                    return;
                }
                
                if (confirm('‚ö†Ô∏è ATTENZIONE!\n\nQuesto canceller√† TUTTE le pratiche e i dati salvati.\nL\'operazione NON pu√≤ essere annullata.\n\nSei sicuro di voler procedere?')) {
                    if (confirm('‚ö†Ô∏è ULTIMA CONFERMA\n\nStai per cancellare tutti i dati in modo permanente.\n\nConfermi la cancellazione?')) {
                        // Prima cancella da Firebase
                        if (firebaseInitialized && db) {
                            db.collection('pratiche').doc('data').set({
                                pratiche: [],
                                ultimoAggiornamento: firebase.firestore.FieldValue.serverTimestamp(),
                                cancellatoDa: utenteCorrente.nome,
                                dataCancellazione: new Date().toISOString()
                            })
                            .then(() => {
                                console.log('‚úÖ Dati cancellati da Firebase');
                                // Poi cancella da localStorage
                                localStorage.removeItem('pratiche_effetre');
                                localStorage.removeItem('notifiche_effetre');
                                setPratiche([]);
                                setNotifiche({});
                                alert('‚úÖ Tutti i dati sono stati cancellati.\n\nL\'app √® stata resettata.');
                                // Attendi che il salvataggio sia completato
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1000);
                            })
                            .catch((error) => {
                                console.error('‚ùå Errore cancellazione Firebase:', error);
                                alert('‚ùå Errore durante la cancellazione.\n\nDettagli: ' + error.message);
                            });
                        } else {
                            // Fallback a localStorage
                            localStorage.removeItem('pratiche_effetre');
                            localStorage.removeItem('notifiche_effetre');
                            setPratiche([]);
                            setNotifiche({});
                            alert('‚úÖ Tutti i dati sono stati cancellati.\n\nL\'app √® stata resettata.');
                            window.location.reload();
                        }
                    }
                }
            };

            // Funzione per cancellare tutti i filtri e ripristinare la visualizzazione completa
            const cancellaTuttiIFiltri = () => {
                setFiltro('tutte');
                setFiltroUtente(null);
                setFiltroTemporale('tutte');
                setDataInizio('');
                setDataFine('');
                setSubFiltroMie('tutte');
                setCercaTesto('');
                setDropdownAperto(null);
            };

            // ============================================================
            // FUNZIONI GESTIONE UTENTI (SOLO SUPER-ADMIN DAVIDE)
            // ============================================================
            const apriFormNuovoUtente = () => {
                if (!utenteCorrente?.isSuperAdmin) {
                    alert('‚õî ACCESSO NEGATO\n\nSolo il Super Amministratore pu√≤ gestire gli utenti.');
                    return;
                }
                setFormUtente({
                    nome: '',
                    email: '',
                    username: '',
                    password: '',
                    ruolo: 'Tecnico',
                    isAdmin: false
                });
                setUtenteInModifica(null);
                setMostraFormUtente(true);
            };

            const apriFormModificaUtente = (utente) => {
                if (!utenteCorrente?.isSuperAdmin) {
                    alert('‚õî ACCESSO NEGATO\n\nSolo il Super Amministratore pu√≤ gestire gli utenti.');
                    return;
                }
                setFormUtente({
                    nome: utente.nome,
                    email: utente.email,
                    username: utente.username,
                    password: utente.password,
                    ruolo: utente.ruolo,
                    isAdmin: utente.isAdmin
                });
                setUtenteInModifica(utente);
                setMostraFormUtente(true);
            };

            const salvaUtente = async () => {
                // Validazione
                if (!formUtente.nome.trim()) {
                    alert('‚ö†Ô∏è Inserisci il nome dell\'utente');
                    return;
                }
                if (!formUtente.username.trim()) {
                    alert('‚ö†Ô∏è Inserisci lo username');
                    return;
                }
                if (!formUtente.password.trim()) {
                    alert('‚ö†Ô∏è Inserisci la password');
                    return;
                }
                if (!formUtente.email.trim()) {
                    alert('‚ö†Ô∏è Inserisci l\'email');
                    return;
                }

                // Controlla se username gi√† esiste (solo per nuovi utenti)
                if (!utenteInModifica) {
                    const usernameEsistente = utenti.find(u => u.username === formUtente.username);
                    if (usernameEsistente) {
                        alert('‚ö†Ô∏è Username gi√† esistente.\n\nScegli un altro username.');
                        return;
                    }
                }

                let nuoviUtenti;
                if (utenteInModifica) {
                    // Modifica utente esistente
                    nuoviUtenti = utenti.map(u => 
                        u.id === utenteInModifica.id
                            ? {
                                ...u,
                                nome: formUtente.nome.trim(),
                                email: formUtente.email.trim(),
                                username: formUtente.username.trim(),
                                password: formUtente.password.trim(),
                                ruolo: formUtente.ruolo,
                                isAdmin: formUtente.isAdmin,
                                isSuperAdmin: u.isSuperAdmin // Mantieni super-admin status
                            }
                            : u
                    );
                    alert('‚úÖ Utente modificato con successo!');
                } else {
                    // Crea nuovo utente
                    const nuovoId = Math.max(...utenti.map(u => u.id)) + 1;
                    const nuovoUtente = {
                        id: nuovoId,
                        nome: formUtente.nome.trim(),
                        email: formUtente.email.trim(),
                        username: formUtente.username.trim(),
                        password: formUtente.password.trim(),
                        ruolo: formUtente.ruolo,
                        isAdmin: formUtente.isAdmin,
                        isSuperAdmin: false
                    };
                    nuoviUtenti = [...utenti, nuovoUtente];
                    alert('‚úÖ Nuovo utente creato con successo!');
                }

                setUtenti(nuoviUtenti);
                await salvaUtentisuFirebase(nuoviUtenti);
                setMostraFormUtente(false);
                setUtenteInModifica(null);
            };

            const eliminaUtente = async (utente) => {
                if (!utenteCorrente?.isSuperAdmin) {
                    alert('‚õî ACCESSO NEGATO\n\nSolo il Super Amministratore pu√≤ eliminare utenti.');
                    return;
                }

                // Non permettere eliminazione di se stesso
                if (utente.id === utenteCorrente.id) {
                    alert('‚ö†Ô∏è Non puoi eliminare il tuo stesso account!');
                    return;
                }

                // Non permettere eliminazione di super-admin
                if (utente.isSuperAdmin) {
                    alert('‚ö†Ô∏è Non puoi eliminare un Super Amministratore!');
                    return;
                }

                if (!confirm(`‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler eliminare l'utente "${utente.nome}"?\n\nQuesta operazione NON pu√≤ essere annullata.`)) {
                    return;
                }

                const nuoviUtenti = utenti.filter(u => u.id !== utente.id);
                setUtenti(nuoviUtenti);
                await salvaUtentisuFirebase(nuoviUtenti);
                alert('‚úÖ Utente eliminato con successo!');
            };

            // ============================================================
            // FUNZIONI GESTIONE PRATICHE
            // ============================================================
            const prendiInCarico = (id) => {
                const pratica = pratiche.find(p => p.id === id);
                
                // Non permettere di prendere in carico pratiche eliminate
                if (pratica && pratica.stato === 'eliminata') {
                    alert('‚ö†Ô∏è ATTENZIONE!\n\nQuesta pratica √® stata eliminata e non pu√≤ essere presa in carico.');
                    return;
                }
                
                // Controlla se ha pratiche in lavorazione NON prelavorata
                // Le pratiche prelavorata NON bloccano la presa in carico di altre
                const praticaInLavorazione = pratiche.find(p => 
                    p.stato === 'in-lavorazione' && 
                    p.utenteAssegnato?.id === utenteCorrente.id &&
                    !p.prelavorata  // ESCLUDI pratiche prelavorata
                );
                
                if (praticaInLavorazione) {
                    alert('‚ö†Ô∏è ATTENZIONE!\n\nHai gi√† una pratica in lavorazione con sopralluogo effettuato.\n\nCompleta o sospendi la pratica ' + praticaInLavorazione.numero + ' prima di accettarne un\'altra.');
                    return;
                }
                
                setPraticaSelezionata(pratiche.find(p => p.id === id));
                setMostraModal('conferma-presa-in-carico');
            };

            const confermaPrendInCarico = (sopralluogoEffettuato) => {
                const dataOdierna = new Date().toLocaleDateString('it-IT');
                const isPrelavorata = !sopralluogoEffettuato;
                
                let nuoveOsservazioni = praticaSelezionata.osservazioni || '';
                let azioneStorico = '';
                let dettagliStorico = '';
                
                if (isPrelavorata) {
                    // Pratica prelavorata - sopralluogo NON effettuato
                    const notaPrelavorata = `PERIZIA PRELAVORATA IN ATTESA DI SOPRALLUOGO (${dataOdierna})`;
                    nuoveOsservazioni = nuoveOsservazioni 
                        ? `${nuoveOsservazioni}\n${notaPrelavorata}`
                        : notaPrelavorata;
                    azioneStorico = 'Presa in carico - Prelavorata';
                    dettagliStorico = 'Pratica presa in carico per prelavorazione';
                } else {
                    // Pratica normale - sopralluogo effettuato
                    azioneStorico = 'Presa in carico';
                    dettagliStorico = 'Pratica presa in carico (sopralluogo effettuato)';
                }
                
                const nuovePratiche = pratiche.map(p => 
                    p.id === praticaSelezionata.id
                        ? {
                            ...p,
                            stato: 'in-lavorazione',
                            utenteAssegnato: utenteCorrente,
                            prelavorata: isPrelavorata,
                            osservazioni: nuoveOsservazioni,
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: azioneStorico,
                                dettagli: dettagliStorico
                            }]
                        }
                        : p
                );
                setPratiche(nuovePratiche);
                salvasuFirebase(nuovePratiche);
                setMostraModal(null);
                setPraticaSelezionata(null);
                
                console.log(`‚úÖ Pratica ${praticaSelezionata.numero} presa in carico - Prelavorata: ${isPrelavorata}`);
            };

            const completaPratica = (id) => {
                const nuovePratiche = pratiche.map(p => 
                    p.id === id
                        ? {
                            ...p,
                            stato: 'completata',
                            prelavorata: false,  // Rimuovi flag prelavorata
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: 'Completamento',
                                dettagli: 'Pratica completata'
                            }]
                        }
                        : p
                );
                setPratiche(nuovePratiche);
                salvasuFirebase(nuovePratiche);
            };

            const sospendiPratica = (id) => {
                setPraticaSelezionata(pratiche.find(p => p.id === id));
                setMotivoSospensione('');
                setMostraModal('sospendi');
            };

            const confermaSospensione = () => {
                if (!motivoSospensione.trim()) {
                    alert('Inserisci un motivo per la sospensione');
                    return;
                }
                
                const nuovePratiche = pratiche.map(p => 
                    p.id === praticaSelezionata.id
                        ? {
                            ...p,
                            stato: 'sospesa',
                            dataSospensione: new Date().toISOString(),
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: 'Sospensione',
                                dettagli: `Motivo: ${motivoSospensione}`
                            }]
                        }
                        : p
                );
                setPratiche(nuovePratiche);
                salvasuFirebase(nuovePratiche);
                setMostraModal(null);
                setPraticaSelezionata(null);
                setMotivoSospensione('');
            };

            const riattivaPratica = (id) => {
                const nuovePratiche = pratiche.map(p => 
                    p.id === id
                        ? {
                            ...p,
                            stato: 'in-lavorazione',
                            dataSospensione: null,
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: 'Riattivazione',
                                dettagli: 'Pratica riattivata'
                            }]
                        }
                        : p
                );
                setPratiche(nuovePratiche);
                salvasuFirebase(nuovePratiche);
            };

            const cambiaStatoPratica = (id, nuovoStato) => {
                const pratica = pratiche.find(p => p.id === id);
                if (!pratica) return;
                
                // WORKFLOW ELIMINAZIONE - Verifica mail riattivazione
                if (nuovoStato === 'eliminata') {
                    const mailTrasmessa = confirm(
                        `üìß VERIFICA MAIL DI RIATTIVAZIONE\n\n` +
                        `Prima di eliminare la pratica ${pratica.numero}, √® necessario trasmettere la nota di riattivazione alla societ√†.\n\n` +
                        `La mail di riattivazione √® stata regolarmente trasmessa?\n\n` +
                        `‚Ä¢ Clicca OK se la mail √® stata inviata\n` +
                        `‚Ä¢ Clicca Annulla se la mail NON √® stata ancora inviata`
                    );
                    
                    if (!mailTrasmessa) {
                        // Mail NON trasmessa - BLOCCA eliminazione
                        alert(
                            `‚ö†Ô∏è OPERAZIONE BLOCCATA\n\n` +
                            `Prima di procedere all'eliminazione della perizia, √® necessario trasmettere la mail alla societ√†.\n\n` +
                            `Invia la mail di riattivazione e poi riprova.`
                        );
                        return; // STOP - Non elimina
                    }
                    
                    // Mail trasmessa - PROCEDI con eliminazione
                    const dataOdierna = new Date().toLocaleDateString('it-IT');
                    const notaMail = `Mail di riattivazione trasmessa in data ${dataOdierna}`;
                    
                    const nuovePratiche = pratiche.map(p => 
                        p.id === id
                            ? {
                                ...p,
                                stato: 'eliminata',
                                osservazioni: pratica.osservazioni 
                                    ? `${pratica.osservazioni}\n${notaMail}`
                                    : notaMail,
                                storico: [...p.storico, {
                                    data: new Date().toLocaleString('it-IT'),
                                    utente: utenteCorrente.nome,
                                    azione: 'Eliminazione',
                                    dettagli: `Pratica eliminata - ${notaMail}`
                                }]
                            }
                            : p
                    );
                    setPratiche(nuovePratiche);
                    salvasuFirebase(nuovePratiche);
                    
                    console.log(`‚úÖ Pratica ${pratica.numero} eliminata - Mail registrata`);
                    return;
                }
                
                // RIPRISTINO a disponibile (da eliminata)
                if (nuovoStato === 'disponibile' && pratica.stato === 'eliminata') {
                    const confermaRipristino = confirm(
                        `üîÑ RIPRISTINO PRATICA\n\n` +
                        `Vuoi ripristinare la pratica ${pratica.numero} come disponibile?\n\n` +
                        `La pratica torner√† selezionabile per i tecnici.`
                    );
                    
                    if (!confermaRipristino) return;
                    
                    const nuovePratiche = pratiche.map(p => 
                        p.id === id
                            ? {
                                ...p,
                                stato: 'disponibile',
                                utenteAssegnato: null, // Reset assegnazione
                                storico: [...p.storico, {
                                    data: new Date().toLocaleString('it-IT'),
                                    utente: utenteCorrente.nome,
                                    azione: 'Ripristino',
                                    dettagli: 'Pratica ripristinata come disponibile'
                                }]
                            }
                            : p
                    );
                    setPratiche(nuovePratiche);
                    salvasuFirebase(nuovePratiche);
                    
                    console.log(`‚úÖ Pratica ${pratica.numero} ripristinata a disponibile`);
                }
            };

            const riassegnaPratica = (id) => {
                setPraticaSelezionata(pratiche.find(p => p.id === id));
                setUtenteRiassegnazione(null);
                setMostraModal('riassegna');
            };

            const confermaRiassegnazione = async () => {
                if (!utenteRiassegnazione) {
                    alert('Seleziona un utente');
                    return;
                }
                
                // PROMEMORIA SEMPLICE - SOLO CONFERMA OK
                const conferma = confirm(
                    `Assegni la pratica ${praticaSelezionata.numero} a ${utenteRiassegnazione.nome}?`
                );
                
                if (!conferma) {
                    return;
                }
                
                const nuovePratiche = pratiche.map(p => 
                    p.id === praticaSelezionata.id
                        ? {
                            ...p,
                            utenteAssegnato: utenteRiassegnazione,
                            stato: 'in-lavorazione',
                            riassegnataDa: utenteCorrente.id,
                            aspettaConferma: true,
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: 'Riassegnazione',
                                dettagli: `Riassegnata a ${utenteRiassegnazione.nome} (in attesa conferma)`
                            }]
                        }
                        : p
                );
                
                setPratiche(nuovePratiche);
                await salvasuFirebase(nuovePratiche);
                
                // NOTIFICA ALL'UTENTE - SALVA SU FIREBASE
                const nuovaNotifica = {
                    id: Date.now(),
                    tipo: 'riassegnazione',
                    praticaId: praticaSelezionata.id,
                    messaggio: `Ti √® stata assegnata la pratica ${praticaSelezionata.numero}`,
                    numero: praticaSelezionata.numero,
                    codice: praticaSelezionata.codice,
                    richiede_conferma: true,
                    amministratore: utenteCorrente.nome,
                    dataCreazione: new Date().toISOString()
                };
                
                // Salva su Firebase
                console.log(`üîµ PRIMA di salvare notifica per ${utenteRiassegnazione.nome}`, {
                    userId: utenteRiassegnazione.id,
                    notifica: nuovaNotifica
                });
                
                await aggiungiNotificaFirebase(utenteRiassegnazione.id, nuovaNotifica);
                console.log(`üîî Notifica salvata su Firebase per ${utenteRiassegnazione.nome}`);
                
                setMostraModal(null);
                setPraticaSelezionata(null);
                setUtenteRiassegnazione(null);
            };

            // CONFERMA ACCETTAZIONE PRATICA
            const confermaPraticaRicevuta = async (notifica) => {
                const pratica = pratiche.find(p => p.id === notifica.praticaId);
                if (!pratica) return;
                
                console.log(`‚úÖ Accettazione pratica ${pratica.numero} da ${utenteCorrente.nome}`);
                
                const nuovePratiche = pratiche.map(p => 
                    p.id === notifica.praticaId
                        ? {
                            ...p,
                            aspettaConferma: false,
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: 'Conferma accettazione',
                                dettagli: `Pratica accettata`
                            }]
                        }
                        : p
                );
                
                setPratiche(nuovePratiche);
                salvasuFirebase(nuovePratiche); // NON await - parallelo
                
                // NOTIFICA ALL'AMMINISTRATORE - SALVA SU FIREBASE
                const adminId = pratica.riassegnataDa;
                console.log(`üì§ Invio notifica ad admin: ${adminId}`, { pratica: pratica.numero });
                
                if (adminId) {
                    const notificaAdmin = {
                        id: Date.now(),
                        tipo: 'conferma_accettazione',
                        messaggio: `${utenteCorrente.nome} ha accettato la pratica ${pratica.numero}`,
                        numero: pratica.numero,
                        codice: pratica.codice,
                        dataCreazione: new Date().toISOString()
                    };
                    aggiungiNotificaFirebase(adminId, notificaAdmin); // NON await - parallelo
                    console.log(`üîî Notifica conferma inviata ad admin ${adminId}`);
                } else {
                    console.warn('‚ö†Ô∏è adminId non trovato in pratica.riassegnataDa');
                }
                
                // Rimuovi notifica corrente da Firebase E aggiorna state
                await rimuoviNotificaFirebase(utenteCorrente.id, notifica.id);
                
                // Aggiorna state locale IMMEDIATAMENTE (senza ricaricare da Firebase)
                const nuoveNotifiche = { ...notifiche };
                nuoveNotifiche[utenteCorrente.id] = (notifiche[utenteCorrente.id] || []).filter(n => n.id !== notifica.id);
                setNotifiche(nuoveNotifiche);
                
                // Se non ci sono altre notifiche, vai all'app
                if (nuoveNotifiche[utenteCorrente.id].length === 0) {
                    setMostraNotifiche(false);
                    setSchermata('app');
                }
            };

            const visualizzaDettagli = (pratica) => {
                setPraticaSelezionata(pratica);
                setNoteSopralluogo(pratica.noteSopralluogoUtente || '');
                setMostraModal('dettagli');
            };

            const salvaNoteSopralluogo = () => {
                const nuovePratiche = pratiche.map(p => 
                    p.id === praticaSelezionata.id
                        ? {
                            ...p,
                            noteSopralluogoUtente: noteSopralluogo,
                            osservazioni: noteSopralluogo, // Salva anche in osservazioni per tabella
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: 'Aggiunta note',
                                dettagli: 'Note sopralluogo aggiunte'
                            }]
                        }
                        : p
                );
                setPratiche(nuovePratiche);
                salvasuFirebase(nuovePratiche);
                setMostraModal(null);
            };

            const cancellaNoteSopralluogo = () => {
                if (!confirm('Vuoi davvero cancellare le note?')) {
                    return;
                }
                
                const nuovePratiche = pratiche.map(p => 
                    p.id === praticaSelezionata.id
                        ? {
                            ...p,
                            noteSopralluogoUtente: '',
                            osservazioni: '', // Cancella anche dalle osservazioni
                            storico: [...p.storico, {
                                data: new Date().toLocaleString('it-IT'),
                                utente: utenteCorrente.nome,
                                azione: 'Cancellazione note',
                                dettagli: 'Note sopralluogo cancellate'
                            }]
                        }
                        : p
                );
                setPratiche(nuovePratiche);
                salvasuFirebase(nuovePratiche);
                setNoteSopralluogo('');
                setMostraModal(null);
            };

            const visualizzaStorico = (pratica) => {
                setPraticaSelezionata(pratica);
                setMostraModal('storico');
            };

            // ============================================================
            // FUNZIONI INSERIMENTO/MODIFICA PRATICHE MANUALE (SOLO ADMIN)
            // ============================================================
            const apriFormNuovaPratica = () => {
                setPraticaInModifica(null);
                setFormPratica({
                    nOrdine: '',
                    numero: '',
                    codice: 'ISP',
                    comune: '',
                    indirizzo: '',
                    osservazioni: '',
                    dataSopralluogo: new Date().toISOString().split('T')[0]
                });
                setMostraFormPratica(true);
            };

            const apriFormModificaPratica = (pratica) => {
                setPraticaInModifica(pratica);
                // Parsing della data dal formato italiano "GG/MM"
                let dataFormatted = '';
                if (pratica.giorno && pratica.giorno !== 'Senza data') {
                    const parts = pratica.giorno.split('/');
                    if (parts.length >= 2) {
                        const anno = new Date().getFullYear();
                        dataFormatted = `${anno}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
                setFormPratica({
                    nOrdine: pratica.nOrdine || '',
                    numero: pratica.numero || '',
                    codice: pratica.codice || 'ISP',
                    comune: pratica.comune || '',
                    indirizzo: pratica.indirizzo || '',
                    osservazioni: pratica.osservazioni || '',
                    dataSopralluogo: dataFormatted
                });
                setMostraFormPratica(true);
            };

            const salvaPratica = () => {
                // Validazione
                if (!formPratica.numero.trim()) {
                    alert('‚ö†Ô∏è Il numero pratica √® obbligatorio!');
                    return;
                }
                if (!formPratica.comune.trim()) {
                    alert('‚ö†Ô∏è Il comune √® obbligatorio!');
                    return;
                }

                // Formatta la data per il giorno (formato GG/MM)
                let giornoFormattato = 'Senza data';
                if (formPratica.dataSopralluogo) {
                    const data = new Date(formPratica.dataSopralluogo);
                    const giorno = data.getDate();
                    const mese = data.getMonth() + 1;
                    giornoFormattato = `${giorno}/${mese}`;
                }

                if (praticaInModifica) {
                    // MODIFICA PRATICA ESISTENTE
                    const nuovePratiche = pratiche.map(p => 
                        p.id === praticaInModifica.id
                            ? {
                                ...p,
                                nOrdine: formPratica.nOrdine,
                                numero: formPratica.numero,
                                codice: formPratica.codice,
                                comune: formPratica.comune,
                                indirizzo: formPratica.indirizzo,
                                osservazioni: formPratica.osservazioni,
                                giorno: giornoFormattato,
                                storico: [...p.storico, {
                                    data: new Date().toLocaleString('it-IT'),
                                    utente: utenteCorrente.nome,
                                    azione: 'Modifica dati',
                                    dettagli: 'Dati pratica modificati manualmente'
                                }]
                            }
                            : p
                    );
                    setPratiche(nuovePratiche);
                    salvasuFirebase(nuovePratiche);
                    alert('‚úÖ Pratica modificata con successo!');
                } else {
                    // NUOVA PRATICA
                    const nuovaPratica = {
                        id: `pratica_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        nOrdine: formPratica.nOrdine || '',
                        numero: formPratica.numero,
                        codice: formPratica.codice,
                        comune: formPratica.comune,
                        indirizzo: formPratica.indirizzo,
                        osservazioni: formPratica.osservazioni,
                        giorno: giornoFormattato,
                        stato: 'disponibile',
                        utenteAssegnato: null,
                        prelavorata: false,
                        storico: [{
                            data: new Date().toLocaleString('it-IT'),
                            utente: utenteCorrente.nome,
                            azione: 'Creazione manuale',
                            dettagli: 'Pratica inserita manualmente'
                        }]
                    };
                    const nuovePratiche = [...pratiche, nuovaPratica];
                    setPratiche(nuovePratiche);
                    salvasuFirebase(nuovePratiche);
                    alert('‚úÖ Nuova pratica inserita con successo!');
                }

                setMostraFormPratica(false);
                setPraticaInModifica(null);
            };

            const calcolaGiorniTrascorsi = (dataSospensione) => {
                if (!dataSospensione) return 0;
                const oggi = new Date();
                const dataSosp = new Date(dataSospensione);
                const diffTime = Math.abs(oggi - dataSosp);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            };

            const organizzaPerGiorno = () => {
                const grouped = {};
                pratiche.forEach(pratica => {
                    const giorno = pratica.giorno || 'Senza data';
                    if (!grouped[giorno]) {
                        grouped[giorno] = [];
                    }
                    grouped[giorno].push(pratica);
                });
                return grouped;
            };

            // Helper: Controlla se pratica rientra nel filtro temporale
            const rientraFiltroTemporale = (pratica) => {
                if (filtroTemporale === 'tutte') return true;
                
                // Usa data ultimo aggiornamento storico o data creazione
                const ultimoStorico = pratica.storico && pratica.storico.length > 0 
                    ? pratica.storico[pratica.storico.length - 1].data 
                    : null;
                
                if (!ultimoStorico) return true; // Se no data, mostra sempre
                
                try {
                    // Parse data italiana "GG/MM/AAAA, HH:MM:SS"
                    const parts = ultimoStorico.split(',')[0].split('/');
                    const dataStorico = new Date(parts[2], parts[1] - 1, parts[0]);
                    const oggi = new Date();
                    oggi.setHours(0, 0, 0, 0);
                    
                    const diffGiorni = Math.floor((oggi - dataStorico) / (1000 * 60 * 60 * 24));
                    
                    if (filtroTemporale === 'oggi') return diffGiorni === 0;
                    if (filtroTemporale === 'settimana') return diffGiorni <= 7;
                    
                    // Filtro range di date dal-al
                    if (filtroTemporale === 'range') {
                        dataStorico.setHours(0, 0, 0, 0);
                        
                        if (dataInizio && dataFine) {
                            const inizio = new Date(dataInizio);
                            const fine = new Date(dataFine);
                            inizio.setHours(0, 0, 0, 0);
                            fine.setHours(23, 59, 59, 999);
                            return dataStorico >= inizio && dataStorico <= fine;
                        } else if (dataInizio) {
                            const inizio = new Date(dataInizio);
                            inizio.setHours(0, 0, 0, 0);
                            return dataStorico >= inizio;
                        } else if (dataFine) {
                            const fine = new Date(dataFine);
                            fine.setHours(23, 59, 59, 999);
                            return dataStorico <= fine;
                        }
                    }
                } catch (e) {
                    return true; // In caso di errore parsing, mostra
                }
                
                return true;
            };
            
            const praticheFiltrate = pratiche.filter(p => {
                // Filtro ricerca testo
                if (cercaTesto) {
                    const cerca = cercaTesto.toLowerCase();
                    const match = 
                        p.numero?.toLowerCase().includes(cerca) ||
                        p.codice?.toLowerCase().includes(cerca) ||
                        p.intestati?.toLowerCase().includes(cerca) ||
                        p.indirizzo?.toLowerCase().includes(cerca);
                    if (!match) return false;
                }
                
                // Filtro temporale (applica sempre)
                if (!rientraFiltroTemporale(p)) return false;
                
                // Filtri principali
                if (filtro === 'tutte') {
                    // Nessun filtro utente
                    return true;
                }
                
                if (filtro === 'mie') {
                    // Filtro "Le Mie" con sub-filtri
                    if (p.utenteAssegnato?.id !== utenteCorrente?.id) return false;
                    
                    // Sub-filtri "Le Mie"
                    if (subFiltroMie === 'in-lavorazione') return p.stato === 'in-lavorazione';
                    if (subFiltroMie === 'completate') return p.stato === 'completata';
                    if (subFiltroMie === 'sospese') return p.stato === 'sospesa';
                    if (subFiltroMie === 'eliminate') return p.stato === 'eliminata';
                    if (subFiltroMie === 'tutte') return true;
                    
                    return true;
                }
                
                if (filtro === 'disponibili') return p.stato === 'disponibile';
                
                if (filtro === 'in-lavorazione') {
                    // Filtro per utente (solo admin)
                    if (p.stato !== 'in-lavorazione') return false;
                    if (filtroUtente) return p.utenteAssegnato?.id === filtroUtente;
                    return true;
                }
                
                if (filtro === 'sospese') {
                    // Filtro per utente (solo admin)
                    if (p.stato !== 'sospesa') return false;
                    if (filtroUtente) return p.utenteAssegnato?.id === filtroUtente;
                    return true;
                }
                
                if (filtro === 'completate') {
                    // Filtro per utente (solo admin)
                    if (p.stato !== 'completata') return false;
                    if (filtroUtente) return p.utenteAssegnato?.id === filtroUtente;
                    return true;
                }
                
                return true;
            });

            const getRowClass = (pratica) => {
                if (pratica.stato === 'eliminata') return 'pratica-eliminata';
                if (pratica.stato === 'disponibile') return 'pratica-disponibile';
                if (pratica.stato === 'in-lavorazione') return 'pratica-in-lavorazione';
                if (pratica.stato === 'sospesa') return 'pratica-sospesa';
                if (pratica.stato === 'completata') return 'pratica-completata';
                return '';
            };

            const getBadgeClass = (stato) => {
                if (stato === 'disponibile') return 'badge-disponibile';
                if (stato === 'in-lavorazione') return 'badge-in-lavorazione';
                if (stato === 'sospesa') return 'badge-sospesa';
                if (stato === 'completata') return 'badge-completata';
                if (stato === 'eliminata') return 'badge-eliminata';
                return '';
            };

            const getStatoLabel = (stato) => {
                if (stato === 'disponibile') return 'Disponibile';
                if (stato === 'in-lavorazione') return 'In Lavorazione';
                if (stato === 'sospesa') return 'Sospesa';
                if (stato === 'completata') return 'Completata';
                if (stato === 'eliminata') return 'Eliminata';
                return stato;
            };

            // ============================================================
            // STATISTICHE - FUNZIONI CALCOLO
            // ============================================================
            
            const calcolaStatistiche = () => {
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                
                let dataInizioCalc, dataFineCalc;
                let giorniIndietro = 1;
                
                // Gestione range personalizzato
                if (periodoStats === 'range' && (dataInizioStats || dataFineStats)) {
                    if (dataInizioStats) {
                        dataInizioCalc = new Date(dataInizioStats);
                        dataInizioCalc.setHours(0, 0, 0, 0);
                    } else {
                        dataInizioCalc = new Date(1970, 0, 1); // Data molto vecchia
                    }
                    
                    if (dataFineStats) {
                        dataFineCalc = new Date(dataFineStats);
                        dataFineCalc.setHours(23, 59, 59, 999);
                    } else {
                        dataFineCalc = now;
                    }
                    
                    giorniIndietro = Math.ceil((dataFineCalc - dataInizioCalc) / (1000 * 60 * 60 * 24)) + 1;
                } else {
                    // Periodi predefiniti
                    if (periodoStats === 'settimana') giorniIndietro = 7;
                    if (periodoStats === 'mese') giorniIndietro = 30;
                    
                    dataInizioCalc = new Date(now);
                    dataInizioCalc.setDate(dataInizioCalc.getDate() - giorniIndietro);
                    dataFineCalc = now;
                }
                
                // Filtra pratiche per periodo
                const praticheNelPeriodo = pratiche.filter(p => {
                    if (!p.storico || p.storico.length === 0) return false;
                    
                    try {
                        const ultimoStorico = p.storico[p.storico.length - 1].data;
                        const parts = ultimoStorico.split(',')[0].split('/');
                        const dataStorico = new Date(parts[2], parts[1] - 1, parts[0]);
                        return dataStorico >= dataInizioCalc && dataStorico <= dataFineCalc;
                    } catch (e) {
                        return false;
                    }
                });
                
                // Statistiche per utente
                const statsPerUtente = utenti.filter(u => !u.isAdmin && u.username !== 'Davide').map(utente => {
                    const pratichUtente = praticheNelPeriodo.filter(p => p.utenteAssegnato?.id === utente.id);
                    const completate = pratichUtente.filter(p => p.stato === 'completata').length;
                    const inLavorazione = pratiche.filter(p => p.stato === 'in-lavorazione' && p.utenteAssegnato?.id === utente.id).length;
                    const sospese = pratiche.filter(p => p.stato === 'sospesa' && p.utenteAssegnato?.id === utente.id).length;
                    
                    return {
                        utente: utente.nome,
                        totale: pratichUtente.length,
                        completate,
                        inLavorazione,
                        sospese
                    };
                });
                
                // Pratiche per giorno
                const pratichPerGiorno = {};
                const dataCorrente = new Date(dataFineCalc);
                for (let i = 0; i < giorniIndietro && i < 30; i++) { // Max 30 giorni per il grafico
                    const data = new Date(dataFineCalc);
                    data.setDate(data.getDate() - i);
                    if (data >= dataInizioCalc) {
                        const dataStr = data.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                        pratichPerGiorno[dataStr] = {
                            completate: 0,
                            presInCarico: 0
                        };
                    }
                }
                
                praticheNelPeriodo.forEach(p => {
                    p.storico.forEach(evento => {
                        try {
                            const parts = evento.data.split(',')[0].split('/');
                            const data = new Date(parts[2], parts[1] - 1, parts[0]);
                            
                            if (data >= dataInizioCalc && data <= dataFineCalc) {
                                const dataStr = data.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                                
                                if (pratichPerGiorno[dataStr]) {
                                    if (evento.azione.includes('Completamento')) {
                                        pratichPerGiorno[dataStr].completate++;
                                    } else if (evento.azione.includes('Presa in carico')) {
                                        pratichPerGiorno[dataStr].presInCarico++;
                                    }
                                }
                            }
                        } catch (e) {}
                    });
                });
                
                // Distribuzione stati
                const distribuzioneStati = {
                    disponibili: pratiche.filter(p => p.stato === 'disponibile').length,
                    inLavorazione: pratiche.filter(p => p.stato === 'in-lavorazione').length,
                    sospese: pratiche.filter(p => p.stato === 'sospesa').length,
                    completate: pratiche.filter(p => p.stato === 'completata').length
                };
                
                // Pratiche prelavorata vs normale
                const prelavorataVsNormale = {
                    prelavorata: pratiche.filter(p => p.stato === 'in-lavorazione' && p.prelavorata).length,
                    normale: pratiche.filter(p => p.stato === 'in-lavorazione' && !p.prelavorata).length
                };
                
                return {
                    statsPerUtente,
                    pratichPerGiorno,
                    distribuzioneStati,
                    prelavorataVsNormale,
                    totaliPeriodo: {
                        totale: praticheNelPeriodo.length,
                        completate: praticheNelPeriodo.filter(p => p.stato === 'completata').length
                    }
                };
            };

            // ============================================================
            // FUNZIONI ANALISI AUTOMATICA DOCUMENTI - COMPLETE
            // ============================================================
            
            const handleLoginAnalisi = () => {
                const utente = utenti.find(u => u.username === usernameAnalisi && u.password === passwordAnalisi);
                if (utente) {
                    // SOLO SUPER ADMIN pu√≤ accedere all'analisi automatica documenti
                    if (!utente.isSuperAdmin) {
                        setErroreLoginAnalisi('‚ö†Ô∏è Accesso riservato al Super Amministratore.\nLa modalit√† di analisi accessibile √® integrata nella piattaforma.');
                        return;
                    }
                    setUtenteAnalisi(utente);
                    setErroreLoginAnalisi('');
                } else {
                    setErroreLoginAnalisi('Credenziali non valide');
                }
            };
            
            const handleLogoutAnalisi = () => {
                setUtenteAnalisi(null);
                setUsernameAnalisi('');
                setPasswordAnalisi('');
                setFilesVisure([]);
                setFileAtto(null);
                setDatiEstratti(null);
                setRisultatoAnalisi(null);
                setSchermata('home');
            };
            
            const nuovaAnalisi = () => {
                setFilesVisure([]);
                setFileAtto(null);
                setDatiEstratti(null);
                setRisultatoAnalisi(null);
            };
            
            // Funzione per mostrare la pagina del PDF da cui √® stato estratto un dato
            const mostraPaginaPDF = (tipo, pagina, titoloDato, indiceVisura = 0) => {
                let file;
                if (tipo === 'atto') {
                    file = fileAtto;
                } else if (tipo === 'visura') {
                    file = filesVisure[indiceVisura];
                } else {
                    file = filesVisure[0]; // Default prima visura
                }
                
                if (!file) {
                    alert('File PDF non disponibile');
                    return;
                }
                
                // Crea URL per il PDF
                const pdfUrl = URL.createObjectURL(file);
                
                setPdfViewer({
                    isOpen: true,
                    tipo: tipo,
                    pagina: pagina,
                    titoloDato: titoloDato,
                    pdfUrl: pdfUrl
                });
            };
            
            // NUOVA FUNZIONE: Apre il PDF in una nuova finestra del browser
            const apriPDFInNuovaFinestra = (tipo, pagina, titoloDato, indiceVisura = 0) => {
                let file;
                if (tipo === 'atto') {
                    file = fileAtto;
                } else if (tipo === 'visura') {
                    file = filesVisure[indiceVisura];
                } else {
                    file = filesVisure[0];
                }
                
                if (!file) {
                    alert('File PDF non disponibile');
                    return;
                }
                
                // Crea URL per il PDF e apri in nuova finestra
                const pdfUrl = URL.createObjectURL(file);
                const nuovaFinestra = window.open('', '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');
                
                if (nuovaFinestra) {
                    nuovaFinestra.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>üîç Verifica: ${titoloDato}</title>
                            <style>
                                * { margin: 0; padding: 0; box-sizing: border-box; }
                                body { font-family: Arial, sans-serif; }
                                .header { 
                                    background: linear-gradient(135deg, #2563eb, #1d4ed8); 
                                    color: white; 
                                    padding: 15px 20px; 
                                    display: flex; 
                                    justify-content: space-between; 
                                    align-items: center;
                                    position: fixed;
                                    top: 0;
                                    left: 0;
                                    right: 0;
                                    z-index: 1000;
                                }
                                .header h1 { font-size: 18px; }
                                .header p { font-size: 14px; opacity: 0.9; }
                                .header button {
                                    background: white;
                                    color: #2563eb;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: bold;
                                }
                                .header button:hover { background: #f0f0f0; }
                                .pdf-container {
                                    position: fixed;
                                    top: 70px;
                                    left: 0;
                                    right: 0;
                                    bottom: 0;
                                }
                                iframe { width: 100%; height: 100%; border: none; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <div>
                                    <h1>üîç Verifica Dato: ${titoloDato}</h1>
                                    <p>${tipo === 'atto' ? 'üìã Atto di Provenienza' : 'üìÑ Visura Catastale'} - Pagina ${pagina}</p>
                                </div>
                                <button onclick="window.close()">‚úï Chiudi</button>
                            </div>
                            <div class="pdf-container">
                                <iframe src="${pdfUrl}#page=${pagina}"></iframe>
                            </div>
                        </body>
                        </html>
                    `);
                    nuovaFinestra.document.close();
                } else {
                    // Fallback se popup bloccato
                    window.open(pdfUrl + '#page=' + pagina, '_blank');
                }
            };
            
            const chiudiPdfViewer = () => {
                if (pdfViewer.pdfUrl) {
                    URL.revokeObjectURL(pdfViewer.pdfUrl);
                }
                setPdfViewer({
                    isOpen: false,
                    tipo: null,
                    pagina: 1,
                    titoloDato: '',
                    pdfUrl: null
                });
            };
            
            const pdfToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };
            
            const parseData = (dataStr) => {
                const parti = dataStr.split('/').map(Number);
                return new Date(parti[2], parti[1] - 1, parti[0]);
            };
            
            const filtraVariazioniCatastaliVere = (variazioni) => {
                // Filtra SOLO variazioni catastali vere, escludendo atti notarili
                const attiNotariliDaEscludere = [
                    'compravendita', 'donazione', 'successione', 'atto', 'vendita',
                    'acquisto', 'cessione', 'trasferimento', 'permuta'
                ];
                
                return (variazioni || []).filter(v => {
                    const causaleLower = (v.causale || '').toLowerCase();
                    // Escludi se contiene parole chiave di atti notarili
                    return !attiNotariliDaEscludere.some(parola => causaleLower.includes(parola));
                });
            };
            
            const confrontaDatiCatastali = (datiAtto, datiVisura) => {
                // Filtra solo le unit√† che sono OGGETTO dell'atto (esclude "dati derivanti")
                const unitaOggettoAtto = datiAtto.filter(d => d.isOggettoAtto !== false);
                const datiDerivanti = datiAtto.filter(d => d.isOggettoAtto === false);
                
                // Crea identificatori univoci per ogni unit√† immobiliare
                const createId = (d) => `${d.foglio}-${d.particella}-${d.subalterno || 'NOSUB'}`;
                
                const idsAtto = unitaOggettoAtto.map(createId);
                const idsVisura = datiVisura.map(createId);
                
                // Trova unit√† presenti nell'atto (solo oggetto)
                const unitaAtto = unitaOggettoAtto.map((d, idx) => ({
                    ...d,
                    id: idsAtto[idx],
                    isInVisura: idsVisura.includes(idsAtto[idx])
                }));
                
                // Trova unit√† presenti nella visura
                const unitaVisura = datiVisura.map((d, idx) => ({
                    ...d,
                    id: idsVisura[idx],
                    isInAtto: idsAtto.includes(idsVisura[idx])
                }));
                
                // Analizza risultato (PRIORIT√Ä: dati visura sono ATTUALI)
                const visuraInAtto = idsVisura.every(id => idsAtto.includes(id));
                const attoInVisura = idsAtto.every(id => idsVisura.includes(id));
                
                return {
                    corrispondenzaTotale: visuraInAtto && attoInVisura && idsAtto.length === idsVisura.length,
                    corrispondenzaParziale: visuraInAtto && !attoInVisura,
                    nonCorrispondenza: !visuraInAtto,
                    unitaAtto: unitaAtto,
                    unitaVisura: unitaVisura,
                    unitaAttoNonInVisura: unitaAtto.filter(u => !u.isInVisura),
                    unitaVisuraNonInAtto: unitaVisura.filter(u => !u.isInAtto),
                    datiDerivanti: datiDerivanti,
                    hasDatiDerivanti: datiDerivanti.length > 0
                };
            };
            
            const avviaAnalisi = () => {
                if (!datiEstratti) {
                    alert('Prima devi estrarre i dati dai PDF');
                    return;
                }
                
                // NUOVO FORMATO MULTI-VISURE: il confronto √® gi√† fatto dal backend
                if (datiEstratti.risultati && datiEstratti.risultati.length > 0) {
                    const successi = datiEstratti.risultati.filter(r => r.confronto?.corrispondenzaTotale).length;
                    const parziali = datiEstratti.risultati.filter(r => r.confronto?.corrispondenzaParziale).length;
                    const errori = datiEstratti.risultati.filter(r => r.confronto?.nonCorrispondenza || r.error).length;
                    
                    let messaggio = `üìä RISULTATO ANALISI COMPARATIVA\n\n`;
                    messaggio += `Totale visure analizzate: ${datiEstratti.totalVisure}\n\n`;
                    messaggio += `‚úÖ Corrispondenze OK: ${successi}\n`;
                    messaggio += `‚ö†Ô∏è Corrispondenze parziali: ${parziali}\n`;
                    messaggio += `‚ùå Non corrispondenti: ${errori}\n\n`;
                    
                    // Dettagli per ogni visura
                    datiEstratti.risultati.forEach((r, idx) => {
                        const stato = r.error ? '‚ùì ERRORE' :
                                     r.confronto?.corrispondenzaTotale ? '‚úÖ OK' :
                                     r.confronto?.corrispondenzaParziale ? '‚ö†Ô∏è PARZIALE' : '‚ùå KO';
                        messaggio += `\nVisura #${idx + 1}: ${stato}\n`;
                        messaggio += `   File: ${r.filename}\n`;
                        if (r.confronto?.note) {
                            messaggio += `   ${r.confronto.note}\n`;
                        }
                        if (r.error) {
                            messaggio += `   Errore: ${r.error}\n`;
                        }
                    });
                    
                    alert(messaggio);
                    
                    // Imposta anche il risultato per il modal
                    if (successi === datiEstratti.totalVisure) {
                        setRisultatoAnalisi({
                            tipo: 'successo',
                            messaggio: `‚úÖ Ottimo: tutte le ${successi} visure corrispondono perfettamente ai dati dell'atto`,
                            dettagli: { risultatiMulti: datiEstratti.risultati }
                        });
                    } else if (errori === datiEstratti.totalVisure) {
                        setRisultatoAnalisi({
                            tipo: 'non_corrispondenza',
                            messaggio: `‚ùå Attenzione: nessuna visura corrisponde ai dati dell'atto`,
                            dettagli: { risultatiMulti: datiEstratti.risultati }
                        });
                    } else {
                        setRisultatoAnalisi({
                            tipo: 'corrispondenza_parziale',
                            messaggio: `‚ö†Ô∏è Risultato misto: ${successi} OK, ${parziali} parziali, ${errori} non corrispondenti`,
                            dettagli: { risultatiMulti: datiEstratti.risultati }
                        });
                    }
                    return;
                }
                
                // VECCHIO FORMATO SINGOLA VISURA (retrocompatibilit√†)
                const atto = datiEstratti.atto;
                const visura = datiEstratti.visura;
                
                if (!visura || !visura.datiCatastaliAttuali) {
                    // Prova a vedere se ci sono dati dell'atto almeno
                    if (atto && atto.datiGenerali) {
                        alert('‚ö†Ô∏è Il confronto multi-visure √® gi√† visualizzato nella sezione sopra.\n\nGuarda i box colorati per vedere lo stato di ogni visura:\n‚úÖ Verde = OK\n‚ö†Ô∏è Giallo = Parziale\n‚ùå Rosso = Non corrispondente');
                    } else {
                        alert('Dati non disponibili. Ricarica i documenti e riprova.');
                    }
                    return;
                }
                
                const confronto = confrontaDatiCatastali(atto.datiGenerali.datiCatastali, visura.datiCatastaliAttuali);
                
                // CASO 1: Corrispondenza Totale
                if (confronto.corrispondenzaTotale) {
                    setRisultatoAnalisi({
                        tipo: 'successo',
                        messaggio: '‚úÖ Ottimo: i dati catastali coincidono perfettamente con i dati della visura',
                        dettagli: {
                            unitaAnalizzate: confronto.unitaVisura.length
                        }
                    });
                    return;
                }
                
                // CASO 2: Corrispondenza Parziale (visura √® tra le unit√† dell'atto, ma atto ha pi√π unit√†)
                if (confronto.corrispondenzaParziale) {
                    const dataAtto = parseData(atto.datiGenerali.dataAtto);
                    
                    // Filtra solo variazioni catastali VERE (escludi compravendite/donazioni/ecc)
                    const variazioniVere = filtraVariazioniCatastaliVere(visura.variazioniCatastali);
                    const variazioniSuccessive = variazioniVere.filter(v => {
                        try {
                            const dataVariazione = parseData(v.data);
                            return dataVariazione > dataAtto;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    setRisultatoAnalisi({
                        tipo: 'corrispondenza_parziale',
                        messaggio: '‚ö†Ô∏è Corrispondenza Parziale: la visura caricata corrisponde ad una delle unit√† dell\'atto',
                        dettagli: {
                            unitaCorrispondenti: confronto.unitaVisura.filter(u => u.isInAtto),
                            unitaNellAttoMaNonInVisura: confronto.unitaAttoNonInVisura,
                            numeroTotaleUnitaAtto: confronto.unitaAtto.length,
                            numeroUnitaVisura: visura.datiCatastaliAttuali.length,
                            variazioniSuccessive: variazioniSuccessive,
                            hasDatiDerivanti: confronto.hasDatiDerivanti,
                            datiDerivanti: confronto.datiDerivanti
                        }
                    });
                    return;
                }
                
                // CASO 3: Non Corrispondenza (visura NON presente nell'atto)
                const dataAtto = parseData(atto.datiGenerali.dataAtto);
                
                // Filtra solo variazioni catastali VERE (escludi compravendite/donazioni/ecc)
                const variazioniVere = filtraVariazioniCatastaliVere(visura.variazioniCatastali);
                const variazioniSuccessive = variazioniVere.filter(v => {
                    try {
                        const dataVariazione = parseData(v.data);
                        return dataVariazione > dataAtto;
                    } catch (e) {
                        return false;
                    }
                });
                
                setRisultatoAnalisi({
                    tipo: 'non_corrispondenza',
                    messaggio: '‚ùå Non Corrispondenza: la visura caricata NON corrisponde a nessuna delle unit√† dell\'atto',
                    dettagli: {
                        datiAtto: confronto.unitaAtto,
                        datiVisura: visura.datiCatastaliAttuali,
                        variazioniSuccessive: variazioniSuccessive,
                        unitaVisuraNonInAtto: confronto.unitaVisuraNonInAtto,
                        hasDatiDerivanti: confronto.hasDatiDerivanti,
                        datiDerivanti: confronto.datiDerivanti,
                        prioritaVisura: true // Indica che i dati visura sono ATTUALI
                    }
                });
            };
            
            // Funzioni Drag and Drop
            const handleDragOver = (e, tipo) => {
                e.preventDefault();
                e.stopPropagation();
                if (tipo === 'visura') {
                    setDragOverVisura(true);
                } else {
                    setDragOverAtto(true);
                }
            };
            
            const handleDragLeave = (e, tipo) => {
                e.preventDefault();
                e.stopPropagation();
                if (tipo === 'visura') {
                    setDragOverVisura(false);
                } else {
                    setDragOverAtto(false);
                }
            };
            
            const handleDrop = (e, tipo) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (tipo === 'visura') {
                    setDragOverVisura(false);
                } else {
                    setDragOverAtto(false);
                }
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    if (tipo === 'visura') {
                        // Per le visure, accetta file multipli
                        const pdfFiles = Array.from(files).filter(
                            file => file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
                        );
                        if (pdfFiles.length > 0) {
                            setFilesVisure(prev => [...prev, ...pdfFiles]);
                        } else {
                            alert('Per favore carica solo file PDF');
                        }
                    } else {
                        // Per l'atto, solo un file
                        const file = files[0];
                        if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                            setFileAtto(file);
                        } else {
                            alert('Per favore carica solo file PDF');
                        }
                    }
                }
            };
            
            // Funzione per rimuovere una visura dalla lista
            const rimuoviVisura = (index) => {
                setFilesVisure(prev => prev.filter((_, i) => i !== index));
            };
            
            // Funzione per aggiungere visure da input file
            const aggiungiVisure = (e) => {
                const files = Array.from(e.target.files).filter(
                    file => file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
                );
                if (files.length > 0) {
                    setFilesVisure(prev => [...prev, ...files]);
                }
                e.target.value = ''; // Reset input per permettere di caricare lo stesso file
            };
            
            const estraiDatiPDF = async () => {
                if (filesVisure.length === 0 || !fileAtto) {
                    alert('Carica almeno una visura e l\'atto di provenienza prima di procedere');
                    return;
                }
                
                // CONTROLLO DIMENSIONE FILE (max 5 MB per evitare rate limit)
                const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB in bytes
                const attoSizeMB = (fileAtto.size / (1024 * 1024)).toFixed(2);
                
                // Controlla dimensione di ogni visura
                for (let i = 0; i < filesVisure.length; i++) {
                    const visura = filesVisure[i];
                    const visuraSizeMB = (visura.size / (1024 * 1024)).toFixed(2);
                    if (visura.size > MAX_FILE_SIZE) {
                        alert(`‚ö†Ô∏è VISURA "${visura.name}" TROPPO GRANDE\n\nDimensione: ${visuraSizeMB} MB\nMassimo consentito: 5 MB\n\nRiduci il numero di pagine o comprimi il PDF.`);
                        return;
                    }
                }
                
                if (fileAtto.size > MAX_FILE_SIZE) {
                    alert(`‚ö†Ô∏è ATTO TROPPO GRANDE\n\nDimensione: ${attoSizeMB} MB\nMassimo consentito: 5 MB\n\nCarica solo le pagine essenziali.`);
                    return;
                }
                
                console.log(`‚úÖ Dimensioni file OK - ${filesVisure.length} visure, Atto: ${attoSizeMB} MB`);
                
                setAnalisiInCorso(true);
                setDatiEstratti(null);
                setRisultatoAnalisi(null);
                setProgressoAnalisi(0);
                setMessaggioProgresso('Inizializzazione...');
                
                try {
                    // STEP 1: Conversione PDF Atto
                    setMessaggioProgresso('üìÑ Conversione atto in corso...');
                    setProgressoAnalisi(5);
                    
                    const base64Atto = await pdfToBase64(fileAtto);
                    setProgressoAnalisi(10);
                    
                    // STEP 2: Conversione PDF Visure
                    setMessaggioProgresso(`üìÑ Conversione ${filesVisure.length} visure in corso...`);
                    const visureBase64 = [];
                    for (let i = 0; i < filesVisure.length; i++) {
                        const base64 = await pdfToBase64(filesVisure[i]);
                        visureBase64.push({
                            base64: base64,
                            filename: filesVisure[i].name
                        });
                        setProgressoAnalisi(10 + Math.floor((i + 1) / filesVisure.length * 10));
                    }
                    
                    setProgressoAnalisi(20);
                    
                    // STEP 3: Invio al backend
                    setMessaggioProgresso('üì§ Invio documenti al server...');
                    console.log(`üì§ Invio ${filesVisure.length} visure + atto al backend per analisi...`);
                    
                    setProgressoAnalisi(25);
                    
                    // STEP 4: Analisi AI
                    setMessaggioProgresso(`ü§ñ Analisi AI in corso per ${filesVisure.length} visure (pu√≤ richiedere qualche minuto)...`);
                    setProgressoAnalisi(30);
                    
                    // Simulazione progresso durante attesa API
                    const progressInterval = setInterval(() => {
                        setProgressoAnalisi(prev => {
                            if (prev < 85) return prev + 0.5;
                            return prev;
                        });
                    }, 1000);
                    
                    // Chiamata al backend con endpoint multi-visure
                    const response = await fetch('http://localhost:3000/api/analizza-pdf-multi', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            visure: visureBase64,
                            atto: base64Atto
                        })
                    });
                    
                    clearInterval(progressInterval);
                    setProgressoAnalisi(90);
                    
                    if (!response.ok) {
                        try {
                            const errorData = await response.json();
                            if (errorData.error && errorData.error.includes('rate_limit')) {
                                throw new Error('RATE_LIMIT: File troppo grande. Riduci la dimensione dei PDF.');
                            } else if (errorData.error) {
                                throw new Error(errorData.error);
                            }
                        } catch (e) {
                            if (e.message.includes('RATE_LIMIT')) throw e;
                        }
                        throw new Error('Errore backend: ' + response.status);
                    }
                    
                    setMessaggioProgresso('‚úÖ Elaborazione risultati...');
                    setProgressoAnalisi(95);
                    
                    const dati = await response.json();
                    
                    if (dati.error) {
                        throw new Error(dati.error);
                    }
                    
                    // Salva i risultati multi-visura
                    setDatiEstratti(dati);
                    setProgressoAnalisi(100);
                    setMessaggioProgresso('‚úÖ Completato!');
                    
                    console.log('‚úÖ Analisi multi-visure completata:', dati);
                    
                    setTimeout(() => {
                        const successi = dati.risultati?.filter(r => !r.error).length || 0;
                        const errori = dati.risultati?.filter(r => r.error).length || 0;
                        alert(`‚úÖ Analisi completata!\n\nüìä Risultati:\n- Visure analizzate: ${dati.totalVisure}\n- Successi: ${successi}\n- Errori: ${errori}`);
                    }, 300);
                    
                } catch (error) {
                    console.error('‚ùå Errore estrazione dati:', error);
                    setMessaggioProgresso('‚ùå Errore durante l\'estrazione');
                    alert('Errore durante estrazione: ' + error.message + '\n\nAssicurati che il backend sia in esecuzione su http://localhost:3000');
                } finally {
                    setTimeout(() => {
                        setAnalisiInCorso(false);
                        setProgressoAnalisi(0);
                        setMessaggioProgresso('');
                    }, 1000);
                }
            };

            // ============================================================
            // RENDER - SCHERMATA HOME
            // ============================================================
            if (schermata === 'home' && !utenteCorrente) {
                return (
                    <div className="home-screen">
                        <div className="max-w-4xl mx-auto text-center px-4">
                            <div className="logo-container">
                                <div className="flex justify-center mb-8">
                                    <img src={LOGO_BASE64} alt="Effetre Properties" className="h-40 w-auto" />
                                </div>
                                <h1 className="text-5xl font-bold text-white mb-4">Effetre Properties</h1>
                                <p className="text-xl text-gray-300">Sistema di Gestione Pratiche</p>
                            </div>
                            <div className="flex flex-col gap-6 mt-12">
                                <button onClick={() => setSchermata('login')} className="btn-primary">
                                    üîê ACCEDI AL SISTEMA
                                </button>
                                
                                {/* Analisi Automatica Documenti - SOLO SUPER ADMIN */}
                                <button 
                                    onClick={() => {
                                        const conferma = confirm(
                                            '‚ö†Ô∏è ATTENZIONE\n\n' +
                                            'Questa modalit√† √® riservata al Super Amministratore.\n\n' +
                                            'La modalit√† di analisi documentale accessibile √® integrata all\'interno della piattaforma.\n\n' +
                                            '‚Ä¢ Premi OK per accedere (solo Super Admin)\n' +
                                            '‚Ä¢ Premi ANNULLA per tornare alla homepage'
                                        );
                                        if (conferma) {
                                            setSchermata('analisi');
                                        }
                                    }} 
                                    className="btn-secondary"
                                >
                                    üîÑ ANALISI AUTOMATICA DOCUMENTI
                                </button>
                            </div>
                            <div className="mt-12 text-gray-400 text-sm">
                                <p>Gestione pratiche immobiliari ‚Ä¢ Multi-utente ‚Ä¢ Real-time sync</p>
                                <p className="text-gray-500 text-xs mt-3">Versione {VERSION}</p>
                            </div>
                        </div>
                        
                        {/* Indicatore stato Firebase */}
                        <div className={`firebase-status ${firebaseConnesso ? 'firebase-connected' : 'firebase-disconnected'}`}>
                            {firebaseConnesso ? 'üü¢ Firebase Online' : 'üî¥ Modalit√† Locale'}
                        </div>
                        
                        {/* Versione bottom-right */}
                        <div style={{
                            position: 'fixed',
                            bottom: '10px',
                            right: '10px',
                            backgroundColor: 'rgba(0, 0, 0, 0.5)',
                            color: '#999',
                            padding: '4px 10px',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontFamily: 'monospace'
                        }}>
                            v{VERSION}
                        </div>
                    </div>
                );
            }

            // ============================================================
            // RENDER - SCHERMATA LOGIN
            // ============================================================
            if (schermata === 'login' && !utenteCorrente) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <div className="flex justify-center mb-4">
                                    <img src={LOGO_BASE64} alt="Effetre Properties" className="h-32 w-auto" />
                                </div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Effetre Properties</h1>
                                <p className="text-gray-600">Accedi al Sistema</p>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input
                                        type="text"
                                        placeholder="Inserisci username"
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={usernameInserito}
                                        onChange={(e) => {
                                            setUsernameInserito(e.target.value);
                                            setErroreLogin('');
                                        }}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input
                                        type="password"
                                        placeholder="Inserisci password"
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={passwordInserita}
                                        onChange={(e) => {
                                            setPasswordInserita(e.target.value);
                                            setErroreLogin('');
                                        }}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    />
                                </div>
                                <div className="text-right">
                                    <button 
                                        onClick={() => setMostraRecuperoPassword(true)}
                                        className="text-blue-600 hover:text-blue-800 text-sm hover:underline"
                                    >
                                        üîë Password dimenticata?
                                    </button>
                                </div>
                                {erroreLogin && (
                                    <p className="text-red-600 text-sm text-center">{erroreLogin}</p>
                                )}
                            </div>
                            <button
                                onClick={handleLogin}
                                className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors mt-6"
                            >
                                Accedi
                            </button>
                            <div className="text-center mt-6">
                                <button onClick={() => setSchermata('home')} className="text-gray-500 hover:text-gray-700 text-sm">
                                    ‚Üê Torna alla home
                                </button>
                                <p className="text-gray-400 text-xs mt-3">v{VERSION}</p>
                            </div>
                            
                            {/* MODALE RECUPERO PASSWORD */}
                            {mostraRecuperoPassword && (
                                <div className="modal-overlay" onClick={chiudiRecuperoPassword}>
                                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4" onClick={(e) => e.stopPropagation()}>
                                        <div className="text-center mb-6">
                                            <div className="text-5xl mb-3">üîê</div>
                                            <h3 className="text-xl font-bold text-gray-800">Recupero Password</h3>
                                            <p className="text-gray-600 text-sm mt-2">
                                                {faseRecupero === 1 && "Inserisci il tuo username"}
                                                {faseRecupero === 2 && "Conferma la tua email registrata"}
                                                {faseRecupero === 3 && "Password inviata con successo!"}
                                            </p>
                                            {/* Indicatore fasi */}
                                            <div className="flex justify-center gap-2 mt-4">
                                                <div className={`w-3 h-3 rounded-full ${faseRecupero >= 1 ? 'bg-blue-600' : 'bg-gray-300'}`}></div>
                                                <div className={`w-3 h-3 rounded-full ${faseRecupero >= 2 ? 'bg-blue-600' : 'bg-gray-300'}`}></div>
                                                <div className={`w-3 h-3 rounded-full ${faseRecupero >= 3 ? 'bg-green-600' : 'bg-gray-300'}`}></div>
                                            </div>
                                        </div>
                                        
                                        {/* FASE 1: Inserimento Username */}
                                        {faseRecupero === 1 && (
                                            <>
                                                <div className="mb-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                                    <input
                                                        type="text"
                                                        placeholder="Inserisci il tuo username"
                                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={usernameRecupero}
                                                        onChange={(e) => {
                                                            setUsernameRecupero(e.target.value);
                                                            setErroreRecupero('');
                                                        }}
                                                        onKeyPress={(e) => e.key === 'Enter' && handleRecuperoPassword()}
                                                    />
                                                </div>
                                                
                                                {erroreRecupero && (
                                                    <p className="text-red-600 text-sm text-center mb-4">{erroreRecupero}</p>
                                                )}
                                                
                                                <div className="flex gap-3">
                                                    <button
                                                        onClick={handleRecuperoPassword}
                                                        className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                                                    >
                                                        Avanti ‚Üí
                                                    </button>
                                                    <button
                                                        onClick={chiudiRecuperoPassword}
                                                        className="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors"
                                                    >
                                                        Annulla
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                        
                                        {/* FASE 2: Inserimento Email */}
                                        {faseRecupero === 2 && passwordRecuperata && (
                                            <>
                                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                                    <p className="text-sm text-blue-800">
                                                        üëã Ciao <strong>{passwordRecuperata.nome}</strong>!
                                                    </p>
                                                </div>
                                                
                                                <div className="mb-4">
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">üìß Email registrata</label>
                                                    <input
                                                        type="email"
                                                        placeholder="Inserisci l'email associata al tuo account"
                                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        value={emailRecupero}
                                                        onChange={(e) => {
                                                            setEmailRecupero(e.target.value);
                                                            setErroreRecupero('');
                                                        }}
                                                        onKeyPress={(e) => e.key === 'Enter' && !invioEmailInCorso && handleRecuperoPassword()}
                                                        disabled={invioEmailInCorso}
                                                    />
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        üîí Per sicurezza, inserisci l'email registrata nel sistema
                                                    </p>
                                                </div>
                                                
                                                {erroreRecupero && (
                                                    <p className="text-red-600 text-sm text-center mb-4">{erroreRecupero}</p>
                                                )}
                                                
                                                <div className="flex gap-3">
                                                    <button
                                                        onClick={() => setFaseRecupero(1)}
                                                        className="bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors disabled:opacity-50"
                                                        disabled={invioEmailInCorso}
                                                    >
                                                        ‚Üê Indietro
                                                    </button>
                                                    <button
                                                        onClick={handleRecuperoPassword}
                                                        className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                                        disabled={invioEmailInCorso}
                                                    >
                                                        {invioEmailInCorso ? (
                                                            <span className="flex items-center justify-center gap-2">
                                                                <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                                                </svg>
                                                                Invio in corso...
                                                            </span>
                                                        ) : 'üìß Invia Password'}
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                        
                                        {/* FASE 3: Conferma Invio */}
                                        {faseRecupero === 3 && passwordRecuperata && (
                                            <>
                                                <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-4">
                                                    <div className="text-center">
                                                        <div className="text-4xl mb-2">‚úÖ</div>
                                                        <p className="text-green-800 font-medium mb-3">Email inviata con successo!</p>
                                                        <div className="bg-white rounded-lg p-4 border border-green-300">
                                                            <p className="text-sm text-gray-600 mb-1">Ciao <strong>{passwordRecuperata.nome}</strong></p>
                                                            <p className="text-sm text-gray-600 mb-2">La password √® stata inviata a:</p>
                                                            <p className="text-blue-600 font-medium text-lg">{passwordRecuperata.email}</p>
                                                        </div>
                                                        <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                                                            <p className="text-sm text-blue-800">
                                                                üì¨ Controlla la tua casella di posta (anche lo spam)
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <button
                                                    onClick={chiudiRecuperoPassword}
                                                    className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                                                >
                                                    ‚úì Torna al login
                                                </button>
                                            </>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // ============================================================
            // SCHERMATA ANALISI AUTOMATICA
            // ============================================================
            if (schermata === 'analisi') {
                if (!utenteAnalisi) {
                    // Login per analisi
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                                <div className="text-center mb-8">
                                    <div className="flex justify-center mb-4">
                                        <img src={LOGO_BASE64} alt="Effetre Properties" className="h-32 w-auto" />
                                    </div>
                                    <h1 className="text-3xl font-bold text-gray-800 mb-2">Analisi Automatica Documenti</h1>
                                    <p className="text-gray-600">Accedi per continuare</p>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                        <input
                                            type="text"
                                            value={usernameAnalisi}
                                            onChange={(e) => setUsernameAnalisi(e.target.value)}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Inserisci username"
                                            onKeyPress={(e) => e.key === 'Enter' && handleLoginAnalisi()}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                        <input
                                            type="password"
                                            value={passwordAnalisi}
                                            onChange={(e) => setPasswordAnalisi(e.target.value)}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Inserisci password"
                                            onKeyPress={(e) => e.key === 'Enter' && handleLoginAnalisi()}
                                        />
                                    </div>
                                    {erroreLoginAnalisi && (
                                        <p className="text-red-600 text-sm text-center">{erroreLoginAnalisi}</p>
                                    )}
                                </div>
                                <button
                                    onClick={handleLoginAnalisi}
                                    className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors mt-6"
                                >
                                    Accedi
                                </button>
                                <div className="text-center mt-6">
                                    <button onClick={() => setSchermata('home')} className="text-gray-500 hover:text-gray-700 text-sm">
                                        ‚Üê Torna alla home
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Interfaccia principale (dopo login) - VERSIONE COMPLETA
                return (
                    <div className="min-h-screen bg-gray-50 p-6">
                        <div className="max-w-6xl mx-auto">
                            {/* Header */}
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <img src={LOGO_BASE64} alt="Effetre Properties" className="h-12 w-auto" />
                                        <div>
                                            <h1 className="text-2xl font-bold text-gray-800">Analisi Automatica Documenti</h1>
                                            <p className="text-sm text-gray-600">Utente: {utenteAnalisi.nome}</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => window.location.href = 'analisi.html'}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                                        >
                                            üè† Gestionale
                                        </button>
                                        <button
                                            onClick={handleLogoutAnalisi}
                                            className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
                                        >
                                            Esci
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Upload File */}
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">Caricamento Documenti</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Upload Visure Multiple */}
                                    <div 
                                        className={'border-2 border-dashed rounded-lg p-6 text-center transition-all ' + 
                                            (filesVisure.length > 0 ? 'border-green-600 bg-green-50' : 
                                            dragOverVisura ? 'border-blue-600 bg-blue-50 scale-105' : 
                                            'border-gray-300 hover:border-blue-500')}
                                        onDragOver={(e) => handleDragOver(e, 'visura')}
                                        onDragLeave={(e) => handleDragLeave(e, 'visura')}
                                        onDrop={(e) => handleDrop(e, 'visura')}
                                    >
                                        <div className="mb-3">
                                            <span className="text-4xl">{filesVisure.length > 0 ? '‚úÖ' : 'üìÑ'}</span>
                                            <h3 className={'text-lg font-semibold mt-2 ' + (filesVisure.length > 0 ? 'text-green-700' : 'text-gray-700')}>
                                                Visure Catastali
                                                {filesVisure.length > 0 && (
                                                    <span className="ml-2 bg-green-600 text-white text-sm px-2 py-1 rounded-full">
                                                        {filesVisure.length}
                                                    </span>
                                                )}
                                            </h3>
                                            <p className={'text-sm ' + (filesVisure.length > 0 ? 'text-green-600' : 'text-gray-500')}>
                                                {filesVisure.length > 0 ? 
                                                    'Puoi aggiungere altre visure' : 
                                                    (dragOverVisura ? 'Rilascia i file qui' : 
                                                    'Trascina qui i PDF o clicca per selezionare (multipli)')}
                                            </p>
                                        </div>
                                        
                                        {/* Lista visure caricate */}
                                        {filesVisure.length > 0 && (
                                            <div className="mb-3 max-h-40 overflow-y-auto">
                                                {filesVisure.map((file, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-white border rounded px-3 py-2 mb-1 text-sm hover:bg-gray-50">
                                                        <span className="truncate flex-1 text-left">
                                                            <span className="font-bold text-blue-600">#{idx + 1}</span>
                                                            <span className="ml-2 text-gray-800">{file.name}</span>
                                                            <span className="text-xs text-gray-500 ml-2">
                                                                ({(file.size / (1024 * 1024)).toFixed(2)} MB)
                                                            </span>
                                                        </span>
                                                        <div className="flex items-center gap-1">
                                                            <button 
                                                                onClick={(e) => { 
                                                                    e.stopPropagation(); 
                                                                    const url = URL.createObjectURL(file);
                                                                    window.open(url, '_blank');
                                                                }}
                                                                className="p-1 text-blue-500 hover:text-blue-700 hover:bg-blue-100 rounded"
                                                                title="Visualizza PDF"
                                                            >
                                                                üëÅÔ∏è
                                                            </button>
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); rimuoviVisura(idx); }}
                                                                className="p-1 text-red-500 hover:text-red-700 hover:bg-red-100 rounded"
                                                                title="Rimuovi visura"
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        
                                        <input
                                            type="file"
                                            accept=".pdf"
                                            multiple
                                            onChange={aggiungiVisure}
                                            className="hidden"
                                            id="upload-visura"
                                        />
                                        <label htmlFor="upload-visura" className={'inline-block px-6 py-2 rounded-lg cursor-pointer transition-colors ' + 
                                            (filesVisure.length > 0 ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white')}>
                                            {filesVisure.length > 0 ? '+ Aggiungi Visure' : 'Scegli File'}
                                        </label>
                                        
                                        {filesVisure.length > 0 && (
                                            <button 
                                                onClick={() => setFilesVisure([])}
                                                className="ml-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm"
                                            >
                                                Rimuovi Tutte
                                            </button>
                                        )}
                                    </div>
                                    
                                    <div 
                                        className={'border-2 border-dashed rounded-lg p-6 text-center transition-all ' + 
                                            (fileAtto ? 'border-green-600 bg-green-50' : 
                                            dragOverAtto ? 'border-blue-600 bg-blue-50 scale-105' : 
                                            'border-gray-300 hover:border-blue-500')}
                                        onDragOver={(e) => handleDragOver(e, 'atto')}
                                        onDragLeave={(e) => handleDragLeave(e, 'atto')}
                                        onDrop={(e) => handleDrop(e, 'atto')}
                                    >
                                        <div className="mb-3">
                                            <span className="text-4xl">{fileAtto ? '‚úÖ' : 'üìã'}</span>
                                            <h3 className={'text-lg font-semibold mt-2 ' + (fileAtto ? 'text-green-700' : 'text-gray-700')}>
                                                Atto di Provenienza
                                            </h3>
                                            <p className={'text-sm ' + (fileAtto ? 'text-green-600 font-semibold' : 'text-gray-500')}>
                                                {fileAtto ? (
                                                    <>
                                                        {fileAtto.name}
                                                        <br/>
                                                        <span className={'text-xs ' + (fileAtto.size > 5*1024*1024 ? 'text-red-600 font-bold' : 'text-gray-600')}>
                                                            Dimensione: {(fileAtto.size / (1024 * 1024)).toFixed(2)} MB
                                                            {fileAtto.size > 5*1024*1024 && ' ‚ö†Ô∏è TROPPO GRANDE!'}
                                                        </span>
                                                    </>
                                                ) : 
                                                dragOverAtto ? 'Rilascia il file qui' : 
                                                'Trascina qui il PDF o clicca per selezionare'}
                                            </p>
                                        </div>
                                        
                                        {/* Bottone visualizza atto */}
                                        {fileAtto && (
                                            <div className="mb-3">
                                                <button 
                                                    onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        const url = URL.createObjectURL(fileAtto);
                                                        window.open(url, '_blank');
                                                    }}
                                                    className="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm"
                                                >
                                                    üëÅÔ∏è Visualizza PDF
                                                </button>
                                            </div>
                                        )}
                                        
                                        <input
                                            type="file"
                                            accept=".pdf"
                                            onChange={(e) => setFileAtto(e.target.files[0])}
                                            className="hidden"
                                            id="upload-atto"
                                        />
                                        <label htmlFor="upload-atto" className={'inline-block px-6 py-2 rounded-lg cursor-pointer transition-colors ' + 
                                            (fileAtto ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white')}>
                                            {fileAtto ? 'Cambia File' : 'Scegli File'}
                                        </label>
                                    </div>
                                </div>
                                
                                <div className="mt-6 text-center">
                                    <button
                                        onClick={estraiDatiPDF}
                                        disabled={filesVisure.length === 0 || !fileAtto || analisiInCorso}
                                        className={((filesVisure.length === 0 || !fileAtto || analisiInCorso) ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700') + ' px-8 py-3 rounded-lg font-semibold text-white transition-colors'}
                                    >
                                        {analisiInCorso ? 'üîÑ Estrazione in corso...' : `üîç Analizza ${filesVisure.length} Visure`}
                                    </button>
                                    
                                    {/* Barra Progresso */}
                                    {analisiInCorso && (
                                        <div className="mt-6 max-w-xl mx-auto">
                                            <div className="mb-2">
                                                <p className="text-sm font-semibold text-gray-700">{messaggioProgresso}</p>
                                                <p className="text-xs text-gray-500 mt-1">Progresso: {progressoAnalisi}%</p>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-6 overflow-hidden shadow-inner">
                                                <div 
                                                    className="bg-gradient-to-r from-green-500 to-green-600 h-full rounded-full transition-all duration-500 flex items-center justify-center text-white text-xs font-bold"
                                                    style={{width: `${progressoAnalisi}%`}}
                                                >
                                                    {progressoAnalisi > 10 && `${progressoAnalisi}%`}
                                                </div>
                                            </div>
                                            <div className="mt-3 flex items-center justify-center text-sm text-gray-600">
                                                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div>
                                                <span>Attendere... L'analisi pu√≤ richiedere 1-2 minuti</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Dati Estratti - VERSIONE COMPLETA */}
                            {datiEstratti && (
                                <div className="space-y-6">
                                    {/* ATTO DI PROVENIENZA */}
                                    {datiEstratti.atto && (
                                    <div className="bg-white rounded-lg shadow-md p-6">
                                        <h2 className="text-2xl font-bold text-gray-800 mb-6">üìã Dati Estratti dall'Atto di Provenienza</h2>
                                        
                                        {/* DATI GENERALI */}
                                        {datiEstratti.atto.datiGenerali && (
                                        <div className="mb-6">
                                            <h3 className="text-lg font-semibold text-blue-700 mb-3">üìù Dati Generali</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                                <div className="bg-blue-50 p-3 rounded">
                                                    <p className="text-xs text-gray-600">Tipo Atto</p>
                                                    <p className="font-semibold">{datiEstratti.atto.datiGenerali.tipoAtto || 'Non specificato'}</p>
                                                </div>
                                                <div className="bg-blue-50 p-3 rounded">
                                                    <p className="text-xs text-gray-600">Data Atto</p>
                                                    <p className="font-semibold">{datiEstratti.atto.datiGenerali.dataAtto || 'Non specificato'}</p>
                                                </div>
                                                <div className="bg-blue-50 p-3 rounded">
                                                    <p className="text-xs text-gray-600">Repertorio</p>
                                                    <p className="font-semibold">{datiEstratti.atto.datiGenerali.repertorio || 'Non specificato'}</p>
                                                </div>
                                                <div className="bg-blue-50 p-3 rounded">
                                                    <p className="text-xs text-gray-600">Notaio</p>
                                                    <p className="font-semibold">{datiEstratti.atto.datiGenerali.notaio || 'Non specificato'}</p>
                                                </div>
                                                <div className="bg-green-50 p-3 rounded border-2 border-green-300">
                                                    <p className="text-xs text-green-700">üí∞ Prezzo</p>
                                                    <p className="font-bold text-green-800 text-lg">{datiEstratti.atto.datiGenerali.prezzo || 'Non specificato'}</p>
                                                </div>
                                            </div>
                                            
                                            {/* Riepilogo Beni */}
                                            {datiEstratti.atto.datiGenerali.riepilogoBeni && (
                                                <div className={`mt-4 border-l-4 p-4 rounded ${
                                                    (datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('quote') ||
                                                     datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('societ√†') ||
                                                     datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('cessione')) 
                                                    ? 'bg-red-50 border-red-500' 
                                                    : 'bg-indigo-50 border-indigo-500'
                                                }`}>
                                                    <p className={`text-sm font-semibold mb-1 ${
                                                        (datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('quote') ||
                                                         datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('societ√†'))
                                                        ? 'text-red-700' 
                                                        : 'text-indigo-700'
                                                    }`}>
                                                        üì¶ Riepilogo Beni Oggetto di Transazione
                                                        {(datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('quote') ||
                                                          datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('societ√†')) && (
                                                            <span className="ml-2 text-red-600">‚ö†Ô∏è VERIFICA: potrebbe essere errato!</span>
                                                        )}
                                                    </p>
                                                    <p className="text-gray-700">{datiEstratti.atto.datiGenerali.riepilogoBeni}</p>
                                                    {(datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('quote') ||
                                                      datiEstratti.atto.datiGenerali.riepilogoBeni.toLowerCase().includes('societ√†')) && (
                                                        <p className="text-xs text-red-600 mt-2 italic">
                                                            ‚ö†Ô∏è L'AI potrebbe aver confuso le PARTI dell'atto con il BENE IMMOBILE. 
                                                            Verifica nel PDF l'oggetto effettivo della compravendita (terreno, fabbricato, etc.)
                                                        </p>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* Dati Catastali */}
                                            {datiEstratti.atto.datiGenerali.datiCatastali && datiEstratti.atto.datiGenerali.datiCatastali.length > 0 && (
                                            <div className="mt-4 bg-blue-50 p-4 rounded">
                                                <p className="text-sm font-semibold text-gray-700 mb-2">
                                                    Dati Catastali ({datiEstratti.atto.datiGenerali.datiCatastali.length} unit√†)
                                                </p>
                                                <div className="space-y-2">
                                                    {datiEstratti.atto.datiGenerali.datiCatastali.map((dc, idx) => (
                                                        <div key={idx} className={`bg-white p-3 rounded border-l-4 ${dc.isOggettoAtto === false ? 'border-gray-400' : 'border-blue-600'}`}>
                                                            <div className="flex items-start justify-between">
                                                                <div className="flex-1">
                                                                    <p className="text-sm font-semibold">
                                                                        #{idx + 1}: {dc.lotto && <span className="text-purple-600">[Lotto {dc.lotto}] </span>}Foglio {dc.foglio} - Particella {dc.particella}
                                                                        {dc.subalterno && ` - Sub. ${dc.subalterno}`}
                                                                        {dc.categoria && ` - Cat. ${dc.categoria}`}
                                                                        {dc.comune && ` - ${dc.comune}`}
                                                                    </p>
                                                                    {dc.indirizzo && (
                                                                        <p className="text-xs text-gray-600">üìç {dc.indirizzo}</p>
                                                                    )}
                                                                    {dc.contestoMenzione && (
                                                                        <p className={`text-xs mt-1 ${dc.isOggettoAtto === false ? 'text-gray-600 italic' : 'text-blue-700 font-semibold'}`}>
                                                                            {dc.isOggettoAtto === false ? 'üìã ' : 'üéØ '}{dc.contestoMenzione}
                                                                        </p>
                                                                    )}
                                                                    {dc.isOggettoAtto === false && (
                                                                        <span className="inline-block bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded mt-1">
                                                                            Dato derivante / Riferimento
                                                                        </span>
                                                                    )}
                                                                    {dc.isOggettoAtto === true && (
                                                                        <span className="inline-block bg-green-200 text-green-800 text-xs px-2 py-1 rounded mt-1">
                                                                            ‚úì Oggetto dell'atto
                                                                        </span>
                                                                    )}
                                                                </div>
                                                                {dc.paginaRiferimento && (
                                                                    <div className="ml-2" title={`Pagina ${dc.paginaRiferimento}`}>
                                                                        <span className="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold cursor-help">
                                                                            üìÑ {dc.paginaRiferimento}
                                                                        </span>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            )}
                                        </div>
                                        )}
                                        
                                        {/* DATI URBANISTICI */}
                                        {datiEstratti.atto.datiUrbanistici && (
                                            <div className="mb-6">
                                                <h3 className="text-lg font-semibold text-green-700 mb-3">üèóÔ∏è Dati Urbanistici</h3>
                                                
                                                {/* Titoli Edilizi Originari */}
                                                {datiEstratti.atto.datiUrbanistici.titoliOriginari && datiEstratti.atto.datiUrbanistici.titoliOriginari.length > 0 && (
                                                    <div className="bg-green-50 p-4 rounded mb-3">
                                                        <p className="text-sm font-semibold text-green-800 mb-2">üèõÔ∏è Titoli Edilizi Originari ({datiEstratti.atto.datiUrbanistici.titoliOriginari.length})</p>
                                                        <div className="space-y-2">
                                                            {datiEstratti.atto.datiUrbanistici.titoliOriginari.map((titolo, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded border-l-4 border-green-600">
                                                                    <div className="flex items-start justify-between">
                                                                        <div className="flex-1">
                                                                            <p className="font-bold text-sm text-green-800">{titolo.tipo}</p>
                                                                            <p className="text-sm text-gray-700 mt-1">
                                                                                {titolo.testoCompleto || titolo.numero || 'N/A'}
                                                                            </p>
                                                                        </div>
                                                                        {titolo.paginaRiferimento && (
                                                                            <button 
                                                                                onClick={() => apriPDFInNuovaFinestra('atto', titolo.paginaRiferimento, titolo.tipo)}
                                                                                className="ml-2 p-2 bg-green-100 hover:bg-green-200 rounded-full transition-colors"
                                                                                title={`Verifica a pagina ${titolo.paginaRiferimento}`}
                                                                            >
                                                                                üîç
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Varianti */}
                                                {datiEstratti.atto.datiUrbanistici.varianti && datiEstratti.atto.datiUrbanistici.varianti.length > 0 && (
                                                    <div className="bg-yellow-50 p-4 rounded mb-3">
                                                        <p className="text-sm font-semibold text-yellow-800 mb-2">üìù Varianti ({datiEstratti.atto.datiUrbanistici.varianti.length})</p>
                                                        <div className="space-y-2">
                                                            {datiEstratti.atto.datiUrbanistici.varianti.map((variante, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded border-l-4 border-yellow-500">
                                                                    <div className="flex items-start justify-between">
                                                                        <div className="flex-1">
                                                                            <div className="flex items-center gap-2 mb-1">
                                                                                <p className="font-bold text-sm">{variante.tipo}</p>
                                                                                <span className="inline-block bg-orange-500 text-white text-xs px-2 py-0.5 rounded font-bold">VARIANTE</span>
                                                                            </div>
                                                                            <p className="text-sm text-gray-700 mt-1">
                                                                                {variante.testoCompleto || variante.numero || 'N/A'}
                                                                            </p>
                                                                            {variante.riferimentoTitoloOriginario && (
                                                                                <p className="text-xs text-blue-600 mt-1 font-semibold">
                                                                                    ‚Ü≥ Riferimento: {variante.riferimentoTitoloOriginario}
                                                                                </p>
                                                                            )}
                                                                        </div>
                                                                        {variante.paginaRiferimento && (
                                                                            <button 
                                                                                onClick={() => apriPDFInNuovaFinestra('atto', variante.paginaRiferimento, variante.tipo)}
                                                                                className="ml-2 p-2 bg-blue-100 hover:bg-blue-200 rounded-full transition-colors"
                                                                                title={`Verifica a pagina ${variante.paginaRiferimento}`}
                                                                            >
                                                                                üîç
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Agibilit√† */}
                                                {datiEstratti.atto.datiUrbanistici.agibilita && datiEstratti.atto.datiUrbanistici.agibilita.length > 0 && (
                                                    <div className="bg-teal-50 p-4 rounded mb-3">
                                                        <p className="text-sm font-semibold text-teal-800 mb-2">‚úÖ Agibilit√†/Abitabilit√† ({datiEstratti.atto.datiUrbanistici.agibilita.length})</p>
                                                        <div className="space-y-2">
                                                            {datiEstratti.atto.datiUrbanistici.agibilita.map((agib, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded border-l-4 border-teal-500">
                                                                    <div className="flex items-start justify-between">
                                                                        <div className="flex-1">
                                                                            <p className="font-semibold text-sm">{agib.tipo}</p>
                                                                            {agib.testoCompleto && <p className="text-sm text-gray-700 mt-1">{agib.testoCompleto}</p>}
                                                                            {agib.protocollo && !agib.testoCompleto && <p className="text-xs text-gray-700">Protocollo: {agib.protocollo}</p>}
                                                                            {agib.data && !agib.testoCompleto && <p className="text-xs text-gray-600">Data: {agib.data}</p>}
                                                                            {agib.parziale && <span className="inline-block bg-orange-500 text-white text-xs px-2 py-0.5 rounded font-bold mt-1">PARZIALE</span>}
                                                                            {agib.unitaInteressate && <p className="text-xs text-gray-600 mt-1">Unit√†: {agib.unitaInteressate}</p>}
                                                                            {agib.nota && <p className="text-xs text-gray-600 mt-1 italic">{agib.nota}</p>}
                                                                        </div>
                                                                        {agib.paginaRiferimento && (
                                                                            <button 
                                                                                onClick={() => apriPDFInNuovaFinestra('atto', agib.paginaRiferimento, agib.tipo)}
                                                                                className="ml-2 p-2 bg-teal-100 hover:bg-teal-200 rounded-full transition-colors"
                                                                                title={`Verifica a pagina ${agib.paginaRiferimento}`}
                                                                            >
                                                                                üîç
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Pratiche Catastali - SEPARATE dai titoli urbanistici */}
                                                {datiEstratti.atto.datiUrbanistici.praticheCatastali && datiEstratti.atto.datiUrbanistici.praticheCatastali.length > 0 && (
                                                    <div className="bg-purple-50 p-4 rounded mb-3">
                                                        <p className="text-sm font-semibold text-purple-800 mb-2">üè¢ Pratiche Catastali ({datiEstratti.atto.datiUrbanistici.praticheCatastali.length})</p>
                                                        <div className="space-y-2">
                                                            {datiEstratti.atto.datiUrbanistici.praticheCatastali.map((pratica, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded border-l-4 border-purple-500">
                                                                    <div className="flex items-start justify-between">
                                                                        <div className="flex-1">
                                                                            <p className="font-semibold text-sm text-purple-800">{pratica.tipo}</p>
                                                                            <p className="text-sm text-gray-700 mt-1">
                                                                                {pratica.testoCompleto || 'N/A'}
                                                                            </p>
                                                                        </div>
                                                                        {pratica.paginaRiferimento && (
                                                                            <button 
                                                                                onClick={() => apriPDFInNuovaFinestra('atto', pratica.paginaRiferimento, pratica.tipo)}
                                                                                className="ml-2 p-2 bg-purple-100 hover:bg-purple-200 rounded-full transition-colors"
                                                                                title={`Verifica a pagina ${pratica.paginaRiferimento}`}
                                                                            >
                                                                                üîç
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Fallback per vecchio formato titoliEdilizi */}
                                                {datiEstratti.atto.datiUrbanistici.titoliEdilizi && datiEstratti.atto.datiUrbanistici.titoliEdilizi.length > 0 ? (
                                                    <div className="bg-green-50 p-4 rounded mb-3">
                                                        <p className="text-sm font-semibold text-gray-700 mb-2">Titoli Edilizi ({datiEstratti.atto.datiUrbanistici.titoliEdilizi.length})</p>
                                                        <div className="space-y-2">
                                                            {datiEstratti.atto.datiUrbanistici.titoliEdilizi.map((titolo, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded border-l-4 border-green-500">
                                                                    <p className="font-semibold text-sm">{titolo.tipo}</p>
                                                                    <p className="text-xs text-gray-600">Data: {titolo.data}</p>
                                                                    {titolo.protocollo && <p className="text-xs text-gray-600">Protocollo: {titolo.protocollo}</p>}
                                                                    {titolo.osservazioni && <p className="text-xs text-gray-600 mt-1">{titolo.osservazioni}</p>}
                                                                    {titolo.abitabilita && <span className="inline-block bg-green-200 text-green-800 text-xs px-2 py-1 rounded mt-1">‚úì Abitabilit√†</span>}
                                                                    {titolo.variante && <span className="inline-block bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded mt-1 ml-1">Variante</span>}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ) : (!datiEstratti.atto.datiUrbanistici.titoliOriginari || datiEstratti.atto.datiUrbanistici.titoliOriginari.length === 0) && (
                                                    <div className="bg-gray-50 p-3 rounded mb-3">
                                                        <p className="text-sm text-gray-500">Nessun titolo edilizio trovato</p>
                                                    </div>
                                                )}
                                                
                                                {/* Edificio Ante 67 */}
                                                {datiEstratti.atto.datiUrbanistici.edificioAnte67 && datiEstratti.atto.datiUrbanistici.edificioAnte67.isAnte67 && (
                                                    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded mb-3">
                                                        <p className="font-semibold text-yellow-800">üèõÔ∏è Edificio Ante 1967</p>
                                                        <p className="text-sm text-gray-700">{datiEstratti.atto.datiUrbanistici.edificioAnte67.testoRiferimento}</p>
                                                    </div>
                                                )}
                                                
                                                {/* Conformit√† Urbanistica */}
                                                {datiEstratti.atto.datiUrbanistici.conformitaUrbanistica && datiEstratti.atto.datiUrbanistici.conformitaUrbanistica.dichiarazioneConformita && (
                                                    <div className="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                                        <p className="font-semibold text-blue-800">‚úÖ Dichiarazione di Conformit√†</p>
                                                        {datiEstratti.atto.datiUrbanistici.conformitaUrbanistica.testoConformita && (
                                                            <p className="text-sm text-gray-700 mt-1">{datiEstratti.atto.datiUrbanistici.conformitaUrbanistica.testoConformita}</p>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        
                                        {/* CONVENZIONI EDILIZIE */}
                                        {datiEstratti.atto.convenzioniEdilizie && datiEstratti.atto.convenzioniEdilizie.length > 0 && (
                                            <div className="mb-6">
                                                <h3 className="text-lg font-semibold text-purple-700 mb-3">üìú Convenzioni Edilizie</h3>
                                                <div className="bg-purple-50 p-4 rounded">
                                                    <div className="space-y-2">
                                                        {datiEstratti.atto.convenzioniEdilizie.map((conv, idx) => (
                                                            <div key={idx} className="bg-white p-3 rounded border-l-4 border-purple-500">
                                                                <p className="font-semibold text-sm">{conv.tipo}</p>
                                                                <p className="text-xs text-gray-700 mt-1">{conv.dettagli}</p>
                                                                {conv.dataStipula && <p className="text-xs text-gray-600 mt-1">Stipula: {conv.dataStipula}</p>}
                                                                {conv.scadenza && <p className="text-xs text-gray-600">Scadenza: {conv.scadenza}</p>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* CONVENZIONI URBANISTICHE */}
                                        {datiEstratti.atto.convenzioniUrbanistiche && datiEstratti.atto.convenzioniUrbanistiche.length > 0 && (
                                            <div className="mb-6">
                                                <h3 className="text-lg font-semibold text-red-700 mb-3">‚ö†Ô∏è Convenzioni Urbanistiche</h3>
                                                <div className="bg-red-50 p-4 rounded border-2 border-red-300">
                                                    <div className="space-y-3">
                                                        {datiEstratti.atto.convenzioniUrbanistiche.map((conv, idx) => (
                                                            <div key={idx} className="bg-white p-4 rounded border-l-4 border-red-500">
                                                                <div className="flex items-start justify-between">
                                                                    <div className="flex-1">
                                                                        <p className="font-bold text-red-800">{conv.tipo}</p>
                                                                        {conv.data && <p className="text-sm text-gray-700 mt-1">üìÖ Data: {conv.data}</p>}
                                                                        {conv.riferimentoAtto && <p className="text-sm text-gray-700">üìã Riferimento: {conv.riferimentoAtto}</p>}
                                                                        {conv.durataVincoli && <p className="text-sm text-orange-700 font-semibold">‚è≥ Durata vincoli: {conv.durataVincoli}</p>}
                                                                        {conv.obblighi && conv.obblighi.length > 0 && (
                                                                            <div className="mt-2">
                                                                                <p className="text-xs font-semibold text-gray-700">Obblighi:</p>
                                                                                <ul className="list-disc list-inside text-xs text-gray-600 mt-1">
                                                                                    {conv.obblighi.map((obbligo, oIdx) => (
                                                                                        <li key={oIdx}>{obbligo}</li>
                                                                                    ))}
                                                                                </ul>
                                                                            </div>
                                                                        )}
                                                                        {conv.note && <p className="text-xs text-gray-600 mt-2 italic">{conv.note}</p>}
                                                                    </div>
                                                                    {conv.paginaRiferimento && (
                                                                        <button 
                                                                            onClick={() => apriPDFInNuovaFinestra('atto', conv.paginaRiferimento, conv.tipo)}
                                                                            className="ml-2 p-2 bg-red-100 hover:bg-red-200 rounded-full transition-colors"
                                                                            title={`Verifica a pagina ${conv.paginaRiferimento}`}
                                                                        >
                                                                            üîç
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* EDILIZIA CONVENZIONATA */}
                                        {datiEstratti.atto.ediliziaConvenzionata && datiEstratti.atto.ediliziaConvenzionata.isConvenzionata && (
                                            <div className="mb-6">
                                                <h3 className="text-lg font-semibold text-red-700 mb-3">üè† Edilizia Residenziale Convenzionata</h3>
                                                <div className="bg-red-100 p-4 rounded border-2 border-red-400">
                                                    <div className="flex items-center mb-3">
                                                        <span className="text-2xl mr-2">‚ö†Ô∏è</span>
                                                        <p className="font-bold text-red-800">ATTENZIONE: Immobile soggetto a vincoli di edilizia convenzionata</p>
                                                    </div>
                                                    {datiEstratti.atto.ediliziaConvenzionata.tipoConvenzione && (
                                                        <p className="text-sm text-gray-700"><strong>Tipo:</strong> {datiEstratti.atto.ediliziaConvenzionata.tipoConvenzione}</p>
                                                    )}
                                                    {datiEstratti.atto.ediliziaConvenzionata.riferimenti && (
                                                        <p className="text-sm text-gray-700"><strong>Riferimenti:</strong> {datiEstratti.atto.ediliziaConvenzionata.riferimenti}</p>
                                                    )}
                                                    {datiEstratti.atto.ediliziaConvenzionata.vincoliPrezzo && (
                                                        <p className="text-sm text-orange-700 font-semibold mt-2">üí∞ <strong>Vincoli prezzo:</strong> {datiEstratti.atto.ediliziaConvenzionata.vincoliPrezzo}</p>
                                                    )}
                                                    {datiEstratti.atto.ediliziaConvenzionata.durata && (
                                                        <p className="text-sm text-orange-700 font-semibold">‚è≥ <strong>Durata:</strong> {datiEstratti.atto.ediliziaConvenzionata.durata}</p>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ALTRE INFORMAZIONI */}
                                        {datiEstratti.atto.altreInformazioni && datiEstratti.atto.altreInformazioni.length > 0 && (
                                            <div>
                                                <h3 className="text-lg font-semibold text-orange-700 mb-3">‚ÑπÔ∏è Altre Informazioni Rilevanti</h3>
                                                <div className="bg-orange-50 p-4 rounded">
                                                    <div className="space-y-2">
                                                        {datiEstratti.atto.altreInformazioni.map((info, idx) => (
                                                            <div key={idx} className="bg-white p-3 rounded border-l-4 border-orange-500">
                                                                <p className="font-semibold text-sm">{info.tipo}</p>
                                                                <p className="text-xs text-gray-700 mt-1">{info.descrizione}</p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    )}
                                    
                                    {/* RISULTATI CONFRONTO MULTI-VISURE */}
                                    <div className="bg-white rounded-lg shadow-md p-6">
                                        <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                            üìÑ Confronto Visure Catastali
                                            {datiEstratti.totalVisure && (
                                                <span className="ml-2 bg-blue-600 text-white text-lg px-3 py-1 rounded-full">
                                                    {datiEstratti.totalVisure}
                                                </span>
                                            )}
                                        </h2>
                                        
                                        {/* Riepilogo Risultati */}
                                        {datiEstratti.risultati && (
                                            <div className="mb-6">
                                                <div className="grid grid-cols-3 gap-4 mb-4">
                                                    <div className="bg-green-100 p-4 rounded-lg text-center">
                                                        <p className="text-3xl font-bold text-green-700">
                                                            {datiEstratti.risultati.filter(r => r.confronto?.corrispondenzaTotale).length}
                                                        </p>
                                                        <p className="text-sm text-green-600">‚úÖ Corrispondenze OK</p>
                                                    </div>
                                                    <div className="bg-yellow-100 p-4 rounded-lg text-center">
                                                        <p className="text-3xl font-bold text-yellow-700">
                                                            {datiEstratti.risultati.filter(r => r.confronto?.corrispondenzaParziale).length}
                                                        </p>
                                                        <p className="text-sm text-yellow-600">‚ö†Ô∏è Parziali</p>
                                                    </div>
                                                    <div className="bg-red-100 p-4 rounded-lg text-center">
                                                        <p className="text-3xl font-bold text-red-700">
                                                            {datiEstratti.risultati.filter(r => r.confronto?.nonCorrispondenza || r.error).length}
                                                        </p>
                                                        <p className="text-sm text-red-600">‚ùå Non Corrispondenti</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* Lista Dettagliata Visure */}
                                        {datiEstratti.risultati && datiEstratti.risultati.length > 0 && (
                                            <div className="space-y-4">
                                                {datiEstratti.risultati.map((risultato, idx) => (
                                                    <div 
                                                        key={idx} 
                                                        className={`border-2 rounded-lg p-4 ${
                                                            risultato.error ? 'border-gray-400 bg-gray-50' :
                                                            risultato.confronto?.corrispondenzaTotale ? 'border-green-500 bg-green-50' :
                                                            risultato.confronto?.corrispondenzaParziale ? 'border-yellow-500 bg-yellow-50' :
                                                            'border-red-500 bg-red-50'
                                                        }`}
                                                    >
                                                        <div className="flex items-start justify-between">
                                                            <div className="flex-1">
                                                                {/* Header Visura */}
                                                                <div className="flex items-center gap-3 mb-2">
                                                                    <span className={`text-2xl ${
                                                                        risultato.error ? '‚ùì' :
                                                                        risultato.confronto?.corrispondenzaTotale ? '' :
                                                                        risultato.confronto?.corrispondenzaParziale ? '' : ''
                                                                    }`}>
                                                                        {risultato.error ? '‚ùì' :
                                                                         risultato.confronto?.corrispondenzaTotale ? '‚úÖ' :
                                                                         risultato.confronto?.corrispondenzaParziale ? '‚ö†Ô∏è' : '‚ùå'}
                                                                    </span>
                                                                    <div>
                                                                        <p className="font-bold text-lg">
                                                                            Visura #{risultato.index + 1}
                                                                        </p>
                                                                        <p className="text-sm text-gray-600 truncate max-w-md">
                                                                            üìÅ {risultato.filename}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                
                                                                {/* Errore */}
                                                                {risultato.error && (
                                                                    <div className="bg-gray-200 p-3 rounded mt-2">
                                                                        <p className="text-sm text-gray-700">
                                                                            ‚ö†Ô∏è Errore nell'analisi: {risultato.error}
                                                                        </p>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* Risultato Confronto */}
                                                                {risultato.confronto && (
                                                                    <div className="mt-3">
                                                                        {/* Stato */}
                                                                        <div className={`inline-block px-3 py-1 rounded-full text-sm font-semibold mb-2 ${
                                                                            risultato.confronto.corrispondenzaTotale ? 'bg-green-600 text-white' :
                                                                            risultato.confronto.corrispondenzaParziale ? 'bg-yellow-600 text-white' :
                                                                            'bg-red-600 text-white'
                                                                        }`}>
                                                                            {risultato.confronto.corrispondenzaTotale ? 'RISPONDENZA OK' :
                                                                             risultato.confronto.corrispondenzaParziale ? 'RISPONDENZA PARZIALE' :
                                                                             'RISPONDENZA KO'}
                                                                        </div>
                                                                        
                                                                        {/* Note */}
                                                                        <p className="text-sm text-gray-700 mt-1">
                                                                            {risultato.confronto.note}
                                                                        </p>
                                                                        
                                                                        {/* Dati Visura */}
                                                                        {risultato.confronto.unitaVisura && risultato.confronto.unitaVisura.length > 0 && (
                                                                            <div className="mt-3 bg-white p-3 rounded border">
                                                                                <p className="text-xs font-semibold text-gray-600 mb-2">Dati dalla Visura:</p>
                                                                                {risultato.confronto.unitaVisura.map((unita, uIdx) => (
                                                                                    <div key={uIdx} className={`text-sm p-2 rounded mb-1 ${unita.isInAtto ? 'bg-green-100' : 'bg-red-100'}`}>
                                                                                        <span className="font-semibold">
                                                                                            Foglio {unita.foglio} - Part. {unita.particella} - Sub. {unita.subalterno || '-'}
                                                                                        </span>
                                                                                        {unita.categoria && <span className="text-gray-600 ml-2">Cat. {unita.categoria}</span>}
                                                                                        <span className={`ml-2 text-xs px-2 py-0.5 rounded ${unita.isInAtto ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                                                                                            {unita.isInAtto ? '‚úì Trovato in Atto' : '‚úó Non in Atto'}
                                                                                        </span>
                                                                                    </div>
                                                                                ))}
                                                                            </div>
                                                                        )}
                                                                        
                                                                        {/* Unit√† Corrispondente nell'Atto */}
                                                                        {risultato.confronto.unitaCorrispondente && (
                                                                            <div className="mt-2 bg-blue-50 p-3 rounded border border-blue-200">
                                                                                <p className="text-xs font-semibold text-blue-700 mb-1">üîó Corrispondenza nell'Atto:</p>
                                                                                <p className="text-sm">
                                                                                    {risultato.confronto.unitaCorrispondente.lotto && (
                                                                                        <span className="text-purple-600 font-semibold">[Lotto {risultato.confronto.unitaCorrispondente.lotto}] </span>
                                                                                    )}
                                                                                    Foglio {risultato.confronto.unitaCorrispondente.foglio} - 
                                                                                    Part. {risultato.confronto.unitaCorrispondente.particella} - 
                                                                                    Sub. {risultato.confronto.unitaCorrispondente.subalterno || '-'}
                                                                                    {risultato.confronto.unitaCorrispondente.categoria && (
                                                                                        <span className="text-gray-600"> - Cat. {risultato.confronto.unitaCorrispondente.categoria}</span>
                                                                                    )}
                                                                                </p>
                                                                                {risultato.confronto.unitaCorrispondente.indirizzo && (
                                                                                    <p className="text-xs text-gray-600 mt-1">üìç {risultato.confronto.unitaCorrispondente.indirizzo}</p>
                                                                                )}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            {/* Bottone per vedere PDF */}
                                                            <button 
                                                                onClick={() => apriPDFInNuovaFinestra('visura', 1, risultato.filename, risultato.index)}
                                                                className="ml-4 p-3 bg-blue-100 hover:bg-blue-200 rounded-full transition-colors"
                                                                title="Visualizza Visura"
                                                            >
                                                                üîç
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {/* Fallback per vecchio formato singola visura */}
                                        {datiEstratti.visura && !datiEstratti.risultati && (
                                            <div>
                                                <h3 className="text-lg font-semibold text-blue-700 mb-3">üè† Dati Catastali Attuali</h3>
                                                <div className="bg-blue-50 p-4 rounded">
                                                    <div className="space-y-2">
                                                        {datiEstratti.visura.datiCatastaliAttuali && datiEstratti.visura.datiCatastaliAttuali.map((dc, idx) => (
                                                            <div key={idx} className="bg-white p-3 rounded border-l-4 border-blue-500">
                                                                <p className="font-semibold text-sm">
                                                                    Foglio {dc.foglio} - Particella {dc.particella} - Sub. {dc.subalterno}
                                                                </p>
                                                                <p className="text-xs text-gray-600">
                                                                    Cat. {dc.categoria} - Classe {dc.classe} - Rendita: ‚Ç¨{dc.rendita}
                                                                </p>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="text-center">
                                        <button
                                            onClick={avviaAnalisi}
                                            className="bg-blue-600 text-white px-12 py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors shadow-lg"
                                        >
                                            üöÄ AVVIA ANALISI COMPARATIVA
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            {/* Risultato Analisi - VERSIONE COMPLETA CON 3 CASI */}
                            {risultatoAnalisi && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                    <div className="bg-white rounded-lg shadow-2xl p-8 max-w-3xl max-h-[85vh] overflow-y-auto">
                                        
                                        {/* CASO 1: Corrispondenza Totale */}
                                        {risultatoAnalisi.tipo === 'successo' && (
                                            <div className="text-center">
                                                <div className="text-6xl mb-4">‚úÖ</div>
                                                <h2 className="text-2xl font-bold text-green-700 mb-4">{risultatoAnalisi.messaggio}</h2>
                                                {risultatoAnalisi.dettagli && (
                                                    <p className="text-gray-600 mb-4">
                                                        Tutte le {risultatoAnalisi.dettagli.unitaAnalizzate} unit√† immobiliari corrispondono perfettamente.
                                                    </p>
                                                )}
                                                <div className="flex gap-4 justify-center mt-6">
                                                    <button onClick={() => { setRisultatoAnalisi(null); nuovaAnalisi(); }}
                                                        className="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                                        üîÑ Nuova Analisi
                                                    </button>
                                                    <button onClick={() => { setRisultatoAnalisi(null); setSchermata('home'); }}
                                                        className="bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                                                        üè† Torna al Menu
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* CASO 2: Corrispondenza Parziale */}
                                        {risultatoAnalisi.tipo === 'corrispondenza_parziale' && (
                                            <div>
                                                <div className="text-center mb-6">
                                                    <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                                                    <h2 className="text-2xl font-bold text-orange-600 mb-2">{risultatoAnalisi.messaggio}</h2>
                                                </div>
                                                
                                                {/* Unit√† Corrispondenti */}
                                                {risultatoAnalisi.dettagli.unitaCorrispondenti && risultatoAnalisi.dettagli.unitaCorrispondenti.length > 0 && (
                                                    <div className="mb-6">
                                                        <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                                                            <h3 className="text-lg font-semibold text-green-700 mb-2">‚úÖ Unit√† Corrispondenti</h3>
                                                            <p className="text-sm text-gray-700 mb-3">
                                                                La visura caricata corrisponde a questa/e unit√† dell'atto:
                                                            </p>
                                                            {risultatoAnalisi.dettagli.unitaCorrispondenti.map((unita, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded mb-2">
                                                                    <p className="font-semibold text-sm">
                                                                        Foglio {unita.foglio} - Particella {unita.particella} - Sub. {unita.subalterno}
                                                                    </p>
                                                                    {unita.categoria && <p className="text-xs text-gray-600">Cat. {unita.categoria}</p>}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Unit√† NON Corrispondenti */}
                                                {risultatoAnalisi.dettagli.unitaNellAttoMaNonInVisura && risultatoAnalisi.dettagli.unitaNellAttoMaNonInVisura.length > 0 && (
                                                    <div className="mb-6">
                                                        <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                                                            <h3 className="text-lg font-semibold text-yellow-700 mb-2">‚ö†Ô∏è Altre Unit√† nell'Atto (NON nella visura)</h3>
                                                            <p className="text-sm text-gray-700 mb-3">
                                                                L'atto menziona anche le seguenti unit√† che NON sono presenti nella visura caricata:
                                                            </p>
                                                            {risultatoAnalisi.dettagli.unitaNellAttoMaNonInVisura.map((unita, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded mb-2">
                                                                    <p className="font-semibold text-sm">
                                                                        Foglio {unita.foglio} - Particella {unita.particella}
                                                                        {unita.subalterno ? ` - Sub. ${unita.subalterno}` : ''}
                                                                    </p>
                                                                    {unita.categoria && <p className="text-xs text-gray-600">Cat. {unita.categoria}</p>}
                                                                </div>
                                                            ))}
                                                            <p className="text-sm text-yellow-800 mt-3 font-semibold">
                                                                üí° Nota: Potrebbe essere necessario caricare anche le visure di queste unit√† per un'analisi completa.
                                                            </p>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Dati Derivanti Esclusi */}
                                                {risultatoAnalisi.dettagli.hasDatiDerivanti && risultatoAnalisi.dettagli.datiDerivanti && risultatoAnalisi.dettagli.datiDerivanti.length > 0 && (
                                                    <div className="mb-6">
                                                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                                            <h3 className="text-lg font-semibold text-blue-700 mb-2">‚ÑπÔ∏è Dati Derivanti (esclusi dal confronto)</h3>
                                                            <p className="text-sm text-gray-700 mb-3">
                                                                L'atto menziona anche le seguenti unit√† come "dati derivanti" o "riferimenti storici" (NON oggetto dell'atto):
                                                            </p>
                                                            {risultatoAnalisi.dettagli.datiDerivanti.map((unita, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded mb-2 border-l-2 border-gray-400">
                                                                    <p className="font-semibold text-sm">
                                                                        Foglio {unita.foglio} - Particella {unita.particella}
                                                                        {unita.subalterno ? ` - Sub. ${unita.subalterno}` : ''}
                                                                    </p>
                                                                    {unita.contestoMenzione && (
                                                                        <p className="text-xs text-gray-600 italic mt-1">üìã {unita.contestoMenzione}</p>
                                                                    )}
                                                                </div>
                                                            ))}
                                                            <p className="text-sm text-blue-800 mt-3">
                                                                üí° Nota: Queste unit√† sono state escluse dal confronto perch√© non sono oggetto dell'atto.
                                                            </p>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Variazioni Successive */}
                                                {risultatoAnalisi.dettagli.variazioniSuccessive && risultatoAnalisi.dettagli.variazioniSuccessive.length > 0 && (
                                                    <div className="mb-6">
                                                        <h3 className="text-lg font-semibold text-red-700 mb-3">üìã Documentazione da Richiedere</h3>
                                                        <p className="text-sm text-gray-600 mb-3">
                                                            Le seguenti variazioni sono successive alla data dell'atto:
                                                        </p>
                                                        <div className="space-y-3">
                                                            {risultatoAnalisi.dettagli.variazioniSuccessive.map((variazione, idx) => (
                                                                <div key={idx} className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                                                                    <p className="font-semibold text-red-800">
                                                                        Richiedere documentazione urbanistica riguardante:
                                                                    </p>
                                                                    <div className="mt-2 space-y-1 text-sm">
                                                                        <p><strong>Tipologia:</strong> {variazione.causale}</p>
                                                                        <p><strong>Data:</strong> {variazione.data}</p>
                                                                        {variazione.dettagli && <p><strong>Dettagli:</strong> {variazione.dettagli}</p>}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                <div className="flex gap-4 justify-center mt-6">
                                                    <button onClick={() => { setRisultatoAnalisi(null); nuovaAnalisi(); }}
                                                        className="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                                        üîÑ Nuova Analisi
                                                    </button>
                                                    <button onClick={() => { setRisultatoAnalisi(null); setSchermata('home'); }}
                                                        className="bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                                                        üè† Torna al Menu
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* CASO 3: Non Corrispondenza */}
                                        {risultatoAnalisi.tipo === 'non_corrispondenza' && (
                                            <div>
                                                <div className="text-center mb-6">
                                                    <div className="text-6xl mb-4">‚ùå</div>
                                                    <h2 className="text-2xl font-bold text-red-700 mb-2">{risultatoAnalisi.messaggio}</h2>
                                                </div>
                                                
                                                {/* Confronto Dati */}
                                                <div className="mb-6">
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        {/* Dati Atto */}
                                                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                                            <h3 className="text-sm font-semibold text-blue-700 mb-2">üìã Unit√† nell'Atto</h3>
                                                            {risultatoAnalisi.dettagli.datiAtto.map((unita, idx) => (
                                                                <div key={idx} className="bg-white p-2 rounded mb-2">
                                                                    <p className="text-xs font-semibold">
                                                                        F.{unita.foglio} P.{unita.particella}
                                                                        {unita.subalterno ? ` S.${unita.subalterno}` : ''}
                                                                    </p>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        
                                                        {/* Dati Visura */}
                                                        <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                                                            <h3 className="text-sm font-semibold text-red-700 mb-2">üìÑ Unit√† nella Visura</h3>
                                                            {risultatoAnalisi.dettagli.datiVisura.map((unita, idx) => (
                                                                <div key={idx} className="bg-white p-2 rounded mb-2">
                                                                    <p className="text-xs font-semibold">
                                                                        F.{unita.foglio} P.{unita.particella} S.{unita.subalterno}
                                                                    </p>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="bg-red-100 border-l-4 border-red-600 p-4 rounded mt-4">
                                                        <p className="text-sm font-semibold text-red-800 mb-2">‚ö†Ô∏è ATTENZIONE</p>
                                                        <p className="text-sm text-red-700">
                                                            La visura catastale caricata NON corrisponde a nessuna delle unit√† immobiliari indicate nell'atto di provenienza. 
                                                            Verificare di aver caricato la visura corretta o che non ci siano errori nei dati catastali.
                                                        </p>
                                                    </div>
                                                </div>
                                                
                                                {/* Dati Derivanti Esclusi */}
                                                {risultatoAnalisi.dettagli.hasDatiDerivanti && risultatoAnalisi.dettagli.datiDerivanti && risultatoAnalisi.dettagli.datiDerivanti.length > 0 && (
                                                    <div className="mb-6">
                                                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                                            <h3 className="text-lg font-semibold text-blue-700 mb-2">‚ÑπÔ∏è Dati Derivanti (esclusi dal confronto)</h3>
                                                            <p className="text-sm text-gray-700 mb-3">
                                                                L'atto menziona anche le seguenti unit√† come "dati derivanti" o "riferimenti storici" (NON oggetto dell'atto):
                                                            </p>
                                                            {risultatoAnalisi.dettagli.datiDerivanti.map((unita, idx) => (
                                                                <div key={idx} className="bg-white p-3 rounded mb-2 border-l-2 border-gray-400">
                                                                    <p className="font-semibold text-sm">
                                                                        Foglio {unita.foglio} - Particella {unita.particella}
                                                                        {unita.subalterno ? ` - Sub. ${unita.subalterno}` : ''}
                                                                    </p>
                                                                    {unita.categoria && <p className="text-xs text-gray-600">Cat. {unita.categoria}</p>}
                                                                    {unita.contestoMenzione && (
                                                                        <p className="text-xs text-gray-600 italic mt-1">üìã {unita.contestoMenzione}</p>
                                                                    )}
                                                                </div>
                                                            ))}
                                                            <p className="text-sm text-blue-800 mt-3 font-semibold">
                                                                üí° Nota: Queste unit√† sono state automaticamente escluse dal confronto perch√© non sono oggetto dell'atto. Il confronto ha considerato SOLO le unit√† effettivamente oggetto della compravendita.
                                                            </p>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Priorit√† Visura */}
                                                {risultatoAnalisi.dettagli.prioritaVisura && (
                                                    <div className="mb-6">
                                                        <div className="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded">
                                                            <h3 className="text-lg font-semibold text-indigo-700 mb-2">‚ÑπÔ∏è Priorit√† Dati Visura</h3>
                                                            <p className="text-sm text-indigo-800">
                                                                I dati della <strong>VISURA sono ATTUALI</strong> e rappresentano lo stato catastale corrente (hanno priorit√†). 
                                                                I dati dell'<strong>ATTO sono STORICI</strong> e rappresentano lo stato al momento della compravendita.
                                                                Le variazioni catastali successive alla data dell'atto possono spiegare le differenze rilevate.
                                                            </p>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Variazioni Successive */}
                                                {risultatoAnalisi.dettagli.variazioniSuccessive && risultatoAnalisi.dettagli.variazioniSuccessive.length > 0 && (
                                                    <div className="mb-6">
                                                        <h3 className="text-lg font-semibold text-orange-700 mb-3">üìã Variazioni Catastali Successive</h3>
                                                        <p className="text-sm text-gray-600 mb-3">
                                                            Variazioni successive alla data dell'atto che potrebbero spiegare la non corrispondenza:
                                                        </p>
                                                        <div className="space-y-3">
                                                            {risultatoAnalisi.dettagli.variazioniSuccessive.map((variazione, idx) => (
                                                                <div key={idx} className="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                                                                    <div className="space-y-1 text-sm">
                                                                        <p><strong>Causale:</strong> {variazione.causale}</p>
                                                                        <p><strong>Data:</strong> {variazione.data}</p>
                                                                        {variazione.dettagli && <p><strong>Dettagli:</strong> {variazione.dettagli}</p>}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                <div className="flex gap-4 justify-center mt-6">
                                                    <button onClick={() => { setRisultatoAnalisi(null); nuovaAnalisi(); }}
                                                        className="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                                        üîÑ Nuova Analisi
                                                    </button>
                                                    <button onClick={() => { setRisultatoAnalisi(null); setSchermata('home'); }}
                                                        className="bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                                                        üè† Torna al Menu
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                        
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // MOSTRA NOTIFICHE
            if (mostraNotifiche && utenteCorrente) {
                const notificheUtente = notifiche[utenteCorrente.id] || [];
                const notificheRiassegnazione = notificheUtente.filter(n => n.richiede_conferma);
                const notificheNormali = notificheUtente.filter(n => !n.richiede_conferma);
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <div className="text-center mb-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                    {notificheRiassegnazione.length > 0 ? 'üìã Nuove Assegnazioni' : '‚ö†Ô∏è Notifiche'}
                                </h2>
                                <p className="text-gray-600">
                                    {notificheRiassegnazione.length > 0 
                                        ? 'Conferma le pratiche assegnate' 
                                        : 'L\'amministratore ti ha inviato delle notifiche'}
                                </p>
                            </div>
                            
                            <div className="space-y-4 mb-6">
                                {/* Notifiche riassegnazione (con conferma) */}
                                {notificheRiassegnazione.map(notifica => (
                                    <div key={notifica.id} className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <p className="font-semibold text-gray-800">{notifica.messaggio}</p>
                                        <p className="text-sm text-gray-600 mb-3">
                                            Codice: {notifica.codice}<br/>
                                            Assegnata da: {notifica.amministratore}
                                        </p>
                                        <button
                                            onClick={() => confermaPraticaRicevuta(notifica)}
                                            className="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                                        >
                                            ‚úÖ Accetto la Pratica
                                        </button>
                                    </div>
                                ))}
                                
                                {/* Notifiche normali (senza conferma) */}
                                {notificheNormali.map(notifica => (
                                    <div key={notifica.id} className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                                        <p className="font-semibold text-gray-800">{notifica.messaggio}</p>
                                        {notifica.codice && <p className="text-sm text-gray-600">Codice: {notifica.codice}</p>}
                                    </div>
                                ))}
                            </div>
                            
                            {notificheRiassegnazione.length === 0 && (
                                <button
                                    onClick={confermaNotifiche}
                                    className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                                >
                                    OK, Ho Capito
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            // SCHERMATA UPLOAD
            if (schermata === 'upload') {
                return (
                    <div className="home-screen">
                        <div className="max-w-2xl mx-auto px-4">
                            <div className="text-center mb-8">
                                <h2 className="text-3xl font-bold text-white mb-2">Carica File KML/KMZ</h2>
                                <p className="text-gray-300">Il sistema estrarr√† automaticamente tutti i dati delle pratiche</p>
                                <p className="text-gray-400 text-sm mt-2">Supporta file KML e KMZ da Google My Maps</p>
                            </div>
                            <div 
                                className="upload-zone"
                                onClick={() => fileInputRef.current?.click()}
                                onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('dragover'); }}
                                onDragLeave={(e) => { e.currentTarget.classList.remove('dragover'); }}
                                onDrop={(e) => {
                                    e.preventDefault();
                                    e.currentTarget.classList.remove('dragover');
                                    if (e.dataTransfer.files[0]) {
                                        caricaFileIncrement(e.dataTransfer.files[0]);
                                    }
                                }}
                            >
                                <div className="text-center">
                                    <div className="text-6xl mb-4">üìÅ</div>
                                    <p className="text-xl font-bold text-yellow-400 mb-2">Trascina qui il file KML/KMZ</p>
                                    <p className="text-gray-300 mb-4">oppure clicca per selezionare</p>
                                    <p className="text-sm text-gray-400">Formato: KML o KMZ esportato da Google My Maps</p>
                                </div>
                            </div>
                            <input
                                ref={fileInputRef}
                                type="file"
                                accept=".kml,.kmz"
                                style={{ display: 'none' }}
                                onChange={(e) => {
                                    if (e.target.files[0]) {
                                        caricaFileIncrement(e.target.files[0]);
                                    }
                                }}
                            />
                            <div className="text-center mt-8">
                                <button 
                                    onClick={() => {
                                        if (utenteCorrente) {
                                            setSchermata('app');
                                        } else {
                                            setSchermata('home');
                                        }
                                    }} 
                                    className="text-gray-400 hover:text-white transition-colors"
                                >
                                    ‚Üê {utenteCorrente ? 'Torna all\'app' : 'Torna alla home'}
                                </button>
                                <p className="text-gray-500 text-xs mt-3">v{VERSION}</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // ============================================================
            // SCHERMATA GESTIONE UTENTI (SOLO SUPER-ADMIN DAVIDE)
            // ============================================================
            if (schermata === 'gestione-utenti') {
                if (!utenteCorrente?.isSuperAdmin) {
                    return (
                        <div className="home-screen">
                            <div className="max-w-2xl mx-auto px-4 text-center">
                                <h2 className="text-3xl font-bold text-white mb-4">‚õî Accesso Negato</h2>
                                <p className="text-gray-300 mb-8">Solo il Super Amministratore pu√≤ accedere a questa sezione.</p>
                                <button onClick={() => setSchermata('app')} className="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors">
                                    Torna all'App
                                </button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="min-h-screen bg-gray-50">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-purple-600 to-purple-800 text-white shadow-lg">
                            <div className="container mx-auto px-4 py-4">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <div className="flex items-center gap-3">
                                            <h1 className="text-2xl font-bold">üë• Gestione Utenti</h1>
                                            <span className="bg-purple-900 bg-opacity-50 text-purple-200 text-xs px-2 py-1 rounded font-mono">
                                                v{VERSION}
                                            </span>
                                        </div>
                                        <p className="text-purple-100 text-sm">{utenti.length} utenti totali</p>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <button 
                                            onClick={apriFormNuovoUtente}
                                            className="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-purple-50 transition-colors"
                                        >
                                            + Nuovo Utente
                                        </button>
                                        <button onClick={() => setSchermata('app')} className="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-400 transition-colors">
                                            ‚Üê Torna all'App
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Contenuto */}
                        <div className="container mx-auto px-4 py-6">
                            <div className="bg-white rounded-lg shadow-md overflow-hidden">
                                <table className="w-full">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ruolo</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {utenti.map(utente => (
                                            <tr key={utente.id} className={utente.isSuperAdmin ? 'bg-purple-50' : ''}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{utente.id}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="font-medium text-gray-900">{utente.nome}</div>
                                                    {utente.isSuperAdmin && <span className="text-xs text-purple-600 font-semibold">SUPER ADMIN</span>}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">{utente.username}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">{utente.password}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{utente.email}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded ${
                                                        utente.isSuperAdmin ? 'bg-purple-100 text-purple-800' :
                                                        utente.isAdmin ? 'bg-blue-100 text-blue-800' : 
                                                        'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {utente.ruolo}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button 
                                                        onClick={() => apriFormModificaUtente(utente)}
                                                        className="text-blue-600 hover:text-blue-900 mr-4"
                                                    >
                                                        ‚úèÔ∏è Modifica
                                                    </button>
                                                    {!utente.isSuperAdmin && utente.id !== utenteCorrente.id && (
                                                        <button 
                                                            onClick={() => eliminaUtente(utente)}
                                                            className="text-red-600 hover:text-red-900"
                                                        >
                                                            üóëÔ∏è Elimina
                                                        </button>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {/* Info */}
                            <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 className="font-bold text-blue-900 mb-2">‚ÑπÔ∏è Informazioni</h3>
                                <ul className="text-sm text-blue-800 space-y-1">
                                    <li>‚Ä¢ <strong>Super Amministratore:</strong> Pu√≤ gestire tutti gli utenti e cancellare dati</li>
                                    <li>‚Ä¢ <strong>Amministratore:</strong> Pu√≤ riassegnare pratiche e cancellare dati</li>
                                    <li>‚Ä¢ <strong>Tecnico:</strong> Pu√≤ gestire pratiche assegnate</li>
                                    <li>‚Ä¢ Le password sono visibili solo per il Super Amministratore</li>
                                    <li>‚Ä¢ Non puoi eliminare il tuo stesso account o altri Super Amministratori</li>
                                </ul>
                            </div>
                        </div>

                        {/* Modale Form Utente */}
                        {mostraFormUtente && (
                            <div className="modal-overlay" onClick={() => setMostraFormUtente(false)}>
                                <div className="bg-white rounded-lg p-6 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                                    <h3 className="text-xl font-bold mb-4">
                                        {utenteInModifica ? '‚úèÔ∏è Modifica Utente' : '‚ûï Nuovo Utente'}
                                    </h3>
                                    
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                                            <input
                                                type="text"
                                                className="w-full border border-gray-300 rounded-lg p-2"
                                                placeholder="Mario Rossi"
                                                value={formUtente.nome}
                                                onChange={(e) => setFormUtente({...formUtente, nome: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                                            <input
                                                type="text"
                                                className="w-full border border-gray-300 rounded-lg p-2 font-mono"
                                                placeholder="MarioR"
                                                value={formUtente.username}
                                                onChange={(e) => setFormUtente({...formUtente, username: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                                            <input
                                                type="text"
                                                className="w-full border border-gray-300 rounded-lg p-2 font-mono"
                                                placeholder="Password123"
                                                value={formUtente.password}
                                                onChange={(e) => setFormUtente({...formUtente, password: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                                            <input
                                                type="email"
                                                className="w-full border border-gray-300 rounded-lg p-2"
                                                placeholder="mario@effetre.it"
                                                value={formUtente.email}
                                                onChange={(e) => setFormUtente({...formUtente, email: e.target.value})}
                                            />
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Ruolo *</label>
                                            <select
                                                className="w-full border border-gray-300 rounded-lg p-2"
                                                value={formUtente.isAdmin ? 'Amministratore' : 'Tecnico'}
                                                onChange={(e) => {
                                                    const isAdmin = e.target.value === 'Amministratore';
                                                    setFormUtente({
                                                        ...formUtente, 
                                                        ruolo: e.target.value,
                                                        isAdmin: isAdmin
                                                    });
                                                }}
                                            >
                                                <option value="Tecnico">Tecnico</option>
                                                <option value="Amministratore">Amministratore</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="flex gap-4 mt-6">
                                        <button
                                            onClick={salvaUtente}
                                            className="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"
                                        >
                                            {utenteInModifica ? 'Salva Modifiche' : 'Crea Utente'}
                                        </button>
                                        <button
                                            onClick={() => setMostraFormUtente(false)}
                                            className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                                        >
                                            Annulla
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // DASHBOARD PRINCIPALE
            const pratichPerGiorno = organizzaPerGiorno();
            
            const giorniOrdinati = Object.keys(pratichPerGiorno).sort((a, b) => {
                if (a === 'Senza data') return 1;
                if (b === 'Senza data') return -1;
                
                const matchA = a.match(/(\d{1,2})\/(\d{1,2})/);
                const matchB = b.match(/(\d{1,2})\/(\d{1,2})/);
                
                if (matchA && matchB) {
                    const valoreA = parseInt(matchA[2]) * 100 + parseInt(matchA[1]);
                    const valoreB = parseInt(matchB[2]) * 100 + parseInt(matchB[1]);
                    return valoreA - valoreB;
                }
                
                return a.localeCompare(b);
            });

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header Fisso */}
                    <div className="header-sticky bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
                        <div className="container mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-4">
                                    <img src={LOGO_BASE64} alt="Effetre Properties" className="h-10 w-auto" />
                                    <div>
                                        <div className="flex items-center gap-3">
                                            <h1 className="text-2xl font-bold">Effetre Properties - Gestione Pratiche</h1>
                                            <span className="bg-blue-900 bg-opacity-50 text-blue-200 text-xs px-2 py-1 rounded font-mono">
                                                v{VERSION}
                                            </span>
                                        </div>
                                        <p className="text-blue-100 text-sm">{pratiche.length} pratiche totali</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="text-right">
                                        <div className="font-semibold">{utenteCorrente.nome}</div>
                                        <div className="text-sm text-blue-100">{utenteCorrente.ruolo}</div>
                                    </div>
                                    
                                    {/* Pulsante Analisi Documentale - PER TUTTI */}
                                    <button 
                                        onClick={() => window.open('analisi.html', '_blank')}
                                        className="bg-indigo-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-600 transition-colors text-sm flex items-center gap-2"
                                        title="Apri Analisi Documentale"
                                    >
                                        üìÑ Analisi Documentale
                                    </button>
                                    
                                    {/* Pulsante Inserisci Pratica - SOLO ADMIN/SUPERADMIN */}
                                    {(utenteCorrente.isAdmin || utenteCorrente.isSuperAdmin) && (
                                        <button 
                                            onClick={apriFormNuovaPratica}
                                            className="bg-teal-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-teal-700 transition-colors text-sm flex items-center gap-2"
                                            title="Inserisci nuova pratica manualmente"
                                        >
                                            ‚ûï Inserisci Pratica
                                        </button>
                                    )}
                                    
                                    {(utenteCorrente.isAdmin || utenteCorrente.isSuperAdmin) && (
                                        <>
                                            <button 
                                                onClick={() => setSchermata('upload')}
                                                className="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors text-sm"
                                                title="Carica nuovo file KML/KMZ"
                                            >
                                                üìÅ Import
                                            </button>
                                            <button 
                                                onClick={() => { setVistaStatistiche(!vistaStatistiche); }}
                                                className={`px-4 py-2 rounded-lg font-semibold transition-colors text-sm ${
                                                    vistaStatistiche 
                                                        ? 'bg-orange-600 text-white hover:bg-orange-700' 
                                                        : 'bg-orange-500 text-white hover:bg-orange-600'
                                                }`}
                                                title="Visualizza statistiche"
                                            >
                                                üìä Statistiche
                                            </button>
                                        </>
                                    )}
                                    {utenteCorrente.isSuperAdmin && (
                                        <>
                                            <button 
                                                onClick={() => setSchermata('gestione-utenti')}
                                                className="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors text-sm"
                                                title="Gestione Utenti"
                                            >
                                                üë• Utenti
                                            </button>
                                            <button 
                                                onClick={cancellaTuttiIFiltri}
                                                className="bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600 transition-colors text-sm"
                                                title="Cancella tutti i filtri"
                                            >
                                                üö´ Reset Filtri
                                            </button>
                                        </>
                                    )}
                                    {utenteCorrente.isAdmin && !utenteCorrente.isSuperAdmin && (
                                        <button 
                                            onClick={cancellaTuttiIFiltri}
                                            className="bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600 transition-colors text-sm"
                                            title="Cancella tutti i filtri"
                                        >
                                            üö´ Reset Filtri
                                        </button>
                                    )}
                                    <button onClick={() => { setUtenteCorrente(null); setSchermata('home'); }} className="bg-white text-blue-600 px-4 py-2 rounded-lg font-semibold hover:bg-blue-50 transition-colors">
                                        Esci
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Contenuto */}
                    <div className="container mx-auto px-4 py-6">
                        {/* Filtri e Ricerca - Nascosti quando in vista statistiche */}
                        {!vistaStatistiche && (
                        <div className="filtri-sticky bg-white rounded-lg shadow-md p-4 mb-6">
                            <div className="flex flex-wrap gap-4">
                                <div className="flex-1 min-w-[300px]">
                                    <input
                                        type="text"
                                        placeholder="üîç Cerca per numero, codice, intestati o indirizzo..."
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={cercaTesto}
                                        onChange={(e) => setCercaTesto(e.target.value)}
                                    />
                                </div>
                                
                                {/* FILTRI TEMPORALI - Per tutti */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        üìÖ Periodo visualizzazione:
                                    </label>
                                    <div className="flex gap-2 flex-wrap items-center">
                                        {['oggi', 'settimana', 'tutte'].map(f => (
                                            <button
                                                key={f}
                                                onClick={() => {
                                                    setFiltroTemporale(f);
                                                    setDataInizio('');
                                                    setDataFine('');
                                                }}
                                                className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                                                    filtroTemporale === f && !dataInizio && !dataFine
                                                        ? 'bg-green-600 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                {f === 'oggi' ? 'Oggi' :
                                                 f === 'settimana' ? 'Settimana' : 'Tutte'}
                                            </button>
                                        ))}
                                        
                                        {/* Pulsante Mese con selettore integrato */}
                                        <div className="relative inline-block">
                                            <input
                                                type="month"
                                                onChange={(e) => {
                                                    if (e.target.value) {
                                                        const [anno, mese] = e.target.value.split('-');
                                                        const primoGiorno = `${anno}-${mese}-01`;
                                                        const ultimoGiorno = new Date(anno, parseInt(mese), 0).toISOString().split('T')[0];
                                                        setDataInizio(primoGiorno);
                                                        setDataFine(ultimoGiorno);
                                                        setFiltroTemporale('range');
                                                    }
                                                }}
                                                className={`px-3 py-1 rounded text-sm font-medium transition-colors cursor-pointer ${
                                                    filtroTemporale === 'range' && dataInizio && dataFine && 
                                                    new Date(dataInizio).getDate() === 1 && 
                                                    new Date(dataFine).getDate() === new Date(new Date(dataFine).getFullYear(), new Date(dataFine).getMonth() + 1, 0).getDate()
                                                        ? 'bg-green-600 text-white border-green-600'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200 border-gray-300'
                                                } border`}
                                                title="Seleziona mese"
                                                style={{colorScheme: 'light'}}
                                            />
                                        </div>
                                        
                                        {/* Separatore */}
                                        <span className="text-gray-400 mx-1">|</span>
                                        
                                        {/* Range Date Picker Dal-Al */}
                                        <div className="flex items-center gap-2">
                                            <span className="text-sm text-gray-600">Dal:</span>
                                            <input
                                                type="date"
                                                value={dataInizio}
                                                onChange={(e) => {
                                                    setDataInizio(e.target.value);
                                                    if (e.target.value || dataFine) {
                                                        setFiltroTemporale('range');
                                                    }
                                                }}
                                                className={`px-2 py-1 rounded text-sm border transition-colors ${
                                                    filtroTemporale === 'range'
                                                        ? 'border-green-600 bg-green-50 ring-2 ring-green-200'
                                                        : 'border-gray-300 hover:border-gray-400'
                                                }`}
                                            />
                                            <span className="text-sm text-gray-600">Al:</span>
                                            <input
                                                type="date"
                                                value={dataFine}
                                                onChange={(e) => {
                                                    setDataFine(e.target.value);
                                                    if (e.target.value || dataInizio) {
                                                        setFiltroTemporale('range');
                                                    }
                                                }}
                                                className={`px-2 py-1 rounded text-sm border transition-colors ${
                                                    filtroTemporale === 'range'
                                                        ? 'border-green-600 bg-green-50 ring-2 ring-green-200'
                                                        : 'border-gray-300 hover:border-gray-400'
                                                }`}
                                            />
                                            
                                            {/* Pulsante Reset Range */}
                                            {(dataInizio || dataFine) && filtroTemporale === 'range' && (
                                                <button
                                                    onClick={() => {
                                                        setDataInizio('');
                                                        setDataFine('');
                                                        setFiltroTemporale('tutte');
                                                    }}
                                                    className="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded hover:bg-red-50"
                                                    title="Rimuovi filtro data"
                                                >
                                                    ‚úï
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* FILTRI STATO PRATICHE */}
                                <div className="flex gap-2 flex-wrap">
                                    <button
                                        onClick={() => setVistaAgenda(!vistaAgenda)}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                            vistaAgenda
                                                ? 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                : 'bg-purple-500 text-white hover:bg-purple-600'
                                        }`}
                                    >
                                        {vistaAgenda ? 'üìã Vista Pratiche' : 'üìÖ Agenda Sopralluoghi'} ({pratiche.length})
                                    </button>
                                    
                                    {!vistaAgenda && (
                                        <>
                                            {/* TUTTE */}
                                            <button
                                                onClick={() => { 
                                                    setFiltro('tutte'); 
                                                    setFiltroUtente(null); 
                                                }}
                                                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                    filtro === 'tutte'
                                                        ? 'bg-blue-600 text-white'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                Tutte
                                            </button>
                                            
                                            {/* LE MIE - Con sub-filtri */}
                                            <div className="relative inline-block">
                                                <button
                                                    onClick={() => { 
                                                        setFiltro('mie'); 
                                                        setFiltroUtente(null);
                                                        setDropdownAperto(dropdownAperto === 'mie' ? null : 'mie');
                                                    }}
                                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                        filtro === 'mie'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    Le Mie ‚ñº
                                                </button>
                                                {dropdownAperto === 'mie' && (
                                                    <div className="absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 min-w-[200px]">
                                                        <button
                                                            onClick={() => { setSubFiltroMie('tutte'); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                subFiltroMie === 'tutte' ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            ‚úÖ Tutte
                                                        </button>
                                                        <button
                                                            onClick={() => { setSubFiltroMie('in-lavorazione'); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                subFiltroMie === 'in-lavorazione' ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            üü† In Lavorazione
                                                        </button>
                                                        <button
                                                            onClick={() => { setSubFiltroMie('completate'); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                subFiltroMie === 'completate' ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            üü† Completate
                                                        </button>
                                                        <button
                                                            onClick={() => { setSubFiltroMie('sospese'); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                subFiltroMie === 'sospese' ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            üü† Sospese
                                                        </button>
                                                        <button
                                                            onClick={() => { setSubFiltroMie('eliminate'); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                subFiltroMie === 'eliminate' ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            üü† Eliminate
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* DISPONIBILI */}
                                            <button
                                                onClick={() => { 
                                                    setFiltro('disponibili'); 
                                                    setFiltroUtente(null); 
                                                }}
                                                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                    filtro === 'disponibili'
                                                        ? 'bg-blue-600 text-white'
                                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                            >
                                                Disponibili
                                            </button>
                                            
                                            {/* IN LAVORAZIONE - Con filtro utente per admin */}
                                            <div className="relative inline-block">
                                                <button
                                                    onClick={() => {
                                                        setFiltro('in-lavorazione');
                                                        if (utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') {
                                                            setDropdownAperto(dropdownAperto === 'in-lavorazione' ? null : 'in-lavorazione');
                                                        }
                                                    }}
                                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                        filtro === 'in-lavorazione'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    In Lavorazione {(utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') ? '‚ñº' : ''}
                                                </button>
                                                {dropdownAperto === 'in-lavorazione' && (utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') && (
                                                    <div className="absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 min-w-[200px]">
                                                        <button
                                                            onClick={() => { setFiltroUtente(null); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                !filtroUtente ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            ‚úÖ Tutte
                                                        </button>
                                                        <div className="border-t border-gray-200 my-1"></div>
                                                        {utenti.filter(u => !u.isAdmin && u.username !== 'Davide').map(u => (
                                                            <button
                                                                key={u.id}
                                                                onClick={() => { setFiltroUtente(u.id); setDropdownAperto(null); }}
                                                                className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                    filtroUtente === u.id ? 'bg-blue-50 font-medium' : ''
                                                                }`}
                                                            >
                                                                üë§ {u.nome}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* SOSPESE - Con filtro utente per admin */}
                                            <div className="relative inline-block">
                                                <button
                                                    onClick={() => {
                                                        setFiltro('sospese');
                                                        if (utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') {
                                                            setDropdownAperto(dropdownAperto === 'sospese' ? null : 'sospese');
                                                        }
                                                    }}
                                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                        filtro === 'sospese'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    Sospese {(utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') ? '‚ñº' : ''}
                                                </button>
                                                {dropdownAperto === 'sospese' && (utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') && (
                                                    <div className="absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 min-w-[200px]">
                                                        <button
                                                            onClick={() => { setFiltroUtente(null); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                !filtroUtente ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            ‚úÖ Tutte
                                                        </button>
                                                        <div className="border-t border-gray-200 my-1"></div>
                                                        {utenti.filter(u => !u.isAdmin && u.username !== 'Davide').map(u => (
                                                            <button
                                                                key={u.id}
                                                                onClick={() => { setFiltroUtente(u.id); setDropdownAperto(null); }}
                                                                className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                    filtroUtente === u.id ? 'bg-blue-50 font-medium' : ''
                                                                }`}
                                                            >
                                                                üë§ {u.nome}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* COMPLETATE - Con filtro utente per admin */}
                                            <div className="relative inline-block">
                                                <button
                                                    onClick={() => {
                                                        setFiltro('completate');
                                                        if (utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') {
                                                            setDropdownAperto(dropdownAperto === 'completate' ? null : 'completate');
                                                        }
                                                    }}
                                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                                        filtro === 'completate'
                                                            ? 'bg-blue-600 text-white'
                                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                    }`}
                                                >
                                                    Completate {(utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') ? '‚ñº' : ''}
                                                </button>
                                                {dropdownAperto === 'completate' && (utenteCorrente?.isAdmin || utenteCorrente?.username === 'Davide') && (
                                                    <div className="absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 min-w-[200px]">
                                                        <button
                                                            onClick={() => { setFiltroUtente(null); setDropdownAperto(null); }}
                                                            className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                !filtroUtente ? 'bg-blue-50 font-medium' : ''
                                                            }`}
                                                        >
                                                            ‚úÖ Tutte
                                                        </button>
                                                        <div className="border-t border-gray-200 my-1"></div>
                                                        {utenti.filter(u => !u.isAdmin && u.username !== 'Davide').map(u => (
                                                            <button
                                                                key={u.id}
                                                                onClick={() => { setFiltroUtente(u.id); setDropdownAperto(null); }}
                                                                className={`w-full text-left px-4 py-2 hover:bg-gray-100 ${
                                                                    filtroUtente === u.id ? 'bg-blue-50 font-medium' : ''
                                                                }`}
                                                            >
                                                                üë§ {u.nome}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                        )}

                        {/* DASHBOARD STATISTICHE (Solo Admin) */}
                        {vistaStatistiche ? (
                            <DashboardStatistiche 
                                pratiche={pratiche}
                                utenti={utenti}
                                periodoStats={periodoStats}
                                setPeriodoStats={setPeriodoStats}
                                dataInizioStats={dataInizioStats}
                                setDataInizioStats={setDataInizioStats}
                                dataFineStats={dataFineStats}
                                setDataFineStats={setDataFineStats}
                                calcolaStatistiche={calcolaStatistiche}
                                setVistaStatistiche={setVistaStatistiche}
                                setPraticaSelezionata={setPraticaSelezionata}
                                setMostraModal={setMostraModal}
                            />
                        ) : (
                            <>
                                {/* Vista Agenda o Vista Pratiche */}
                                {vistaAgenda ? (
                                <>
                                <div className="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                                    <div className="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6">
                                        <h2 className="text-2xl font-bold">üìÖ Agenda Sopralluoghi</h2>
                                        <p className="text-sm text-purple-100 mt-2">{pratiche.length} {pratiche.length === 1 ? 'pratica totale' : 'pratiche totali'}</p>
                                    </div>
                                </div>

                                {giorniOrdinati.map(giorno => {
                                    const pratichGiorno = pratichPerGiorno[giorno].filter(p => 
                                        cercaTesto ? 
                                            (p.numero?.toLowerCase().includes(cercaTesto.toLowerCase()) ||
                                             p.codice?.toLowerCase().includes(cercaTesto.toLowerCase()) ||
                                             p.intestati?.toLowerCase().includes(cercaTesto.toLowerCase()) ||
                                             p.indirizzo?.toLowerCase().includes(cercaTesto.toLowerCase())) 
                                            : true
                                    );
                                    
                                    if (pratichGiorno.length === 0) return null;

                                    return (
                                        <div key={giorno} className="mb-8">
                                            <div className="giorno-card bg-white rounded-lg shadow-md overflow-hidden">
                                                <div className="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4">
                                                    <h2 className="text-xl font-bold">{giorno}</h2>
                                                    <p className="text-sm text-purple-100">{pratichGiorno.length} {pratichGiorno.length === 1 ? 'pratica' : 'pratiche'}</p>
                                                </div>
                                                <div className="divide-y divide-gray-200">
                                                    {pratichGiorno.map((pratica) => (
                                                        <div key={pratica.id} className="p-6 hover:bg-gray-50 transition-colors">
                                                            <div className="flex items-start justify-between gap-4">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-3 mb-3">
                                                                        {pratica.nOrdine && (
                                                                            <span className="text-lg font-bold text-purple-600">#{pratica.nOrdine}</span>
                                                                        )}
                                                                        <span className="badge badge-secondary">{pratica.codice}</span>
                                                                        <span className={`badge ${getBadgeClass(pratica.stato)}`}>
                                                                            {getStatoLabel(pratica.stato)}
                                                                        </span>
                                                                        {pratica.prelavorata && (
                                                                            <span className="badge badge-prelavorata">
                                                                                üìù Prelavorata
                                                                            </span>
                                                                        )}
                                                                        {pratica.stato === 'sospesa' && (
                                                                            <span className="badge reminder-badge">
                                                                                ‚è∞ {calcolaGiorniTrascorsi(pratica.dataSospensione)} giorni
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div className="space-y-2 text-sm">
                                                                        <div>
                                                                            <span className="font-semibold text-gray-700">Comune:</span>
                                                                            <span className="ml-2 text-gray-900 font-medium">{pratica.comune}</span>
                                                                        </div>
                                                                        <div>
                                                                            <span className="font-semibold text-gray-700">Indirizzo:</span>
                                                                            <span className="ml-2 text-gray-900">{pratica.indirizzo}</span>
                                                                        </div>
                                                                        {pratica.osservazioni && (
                                                                            <div>
                                                                                <span className="font-semibold text-gray-700">Osservazioni:</span>
                                                                                <span className="ml-2 text-gray-900">{pratica.osservazioni}</span>
                                                                            </div>
                                                                        )}
                                                                        {pratica.utenteAssegnato && (
                                                                            <div>
                                                                                <span className="font-semibold text-gray-700">Assegnato a:</span>
                                                                                <span className="ml-2 text-gray-900">{pratica.utenteAssegnato.nome}</span>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex flex-col gap-2">
                                                                    <button
                                                                        onClick={() => {
                                                                            if (pratica.coordinate) {
                                                                                const [lon, lat] = pratica.coordinate;
                                                                                window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`, '_blank');
                                                                            } else {
                                                                                const indirizzo = encodeURIComponent(pratica.indirizzo || '');
                                                                                window.open(`https://www.google.com/maps/search/?api=1&query=${indirizzo}`, '_blank');
                                                                            }
                                                                        }}
                                                                        className="btn-primary whitespace-nowrap"
                                                                    >
                                                                        üó∫Ô∏è Mappa
                                                                    </button>
                                                                    <button
                                                                        onClick={() => visualizzaDettagli(pratica)}
                                                                        className="btn-secondary whitespace-nowrap text-sm"
                                                                    >
                                                                        üëÅÔ∏è Dettagli
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}

                                {pratiche.filter(p => 
                                    cercaTesto ? 
                                        (p.numero?.toLowerCase().includes(cercaTesto.toLowerCase()) ||
                                         p.codice?.toLowerCase().includes(cercaTesto.toLowerCase()) ||
                                         p.intestati?.toLowerCase().includes(cercaTesto.toLowerCase()) ||
                                         p.indirizzo?.toLowerCase().includes(cercaTesto.toLowerCase())) 
                                        : true
                                ).length === 0 && (
                                    <div className="bg-white rounded-lg shadow-md p-8 text-center">
                                        <p className="text-gray-500 text-lg">Nessuna pratica trovata</p>
                                    </div>
                                )}
                            </>
                        ) : (
                            <>
                        {giorniOrdinati.map(giorno => {
                            const pratichGiorno = pratichPerGiorno[giorno].filter(p => praticheFiltrate.includes(p));
                            if (pratichGiorno.length === 0) return null;

                            return (
                                <div key={giorno} className="mb-8">
                                    <div className="giorno-card bg-white rounded-lg shadow-md overflow-hidden">
                                        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4">
                                            <h2 className="text-xl font-bold">{giorno}</h2>
                                            <p className="text-sm text-blue-100">{pratichGiorno.length} {pratichGiorno.length === 1 ? 'pratica' : 'pratiche'}</p>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        {/* Colonna Modifica - Solo Admin/SuperAdmin */}
                                                        {(utenteCorrente.isAdmin || utenteCorrente.isSuperAdmin) && (
                                                            <th className="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16">‚öôÔ∏è</th>
                                                        )}
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N. Ordine</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Numero</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codice</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comune</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Indirizzo</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Osservazioni</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stato</th>
                                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200">
                                                    {pratichGiorno.map(pratica => {
                                                        const giorniSospesa = pratica.stato === 'sospesa' ? calcolaGiorniTrascorsi(pratica.dataSospensione) : 0;
                                                        return (
                                                            <tr key={pratica.id} className={`row-hover ${getRowClass(pratica)}`}>
                                                                {/* Icona Modifica e Cancella - Solo Admin/SuperAdmin */}
                                                                {(utenteCorrente.isAdmin || utenteCorrente.isSuperAdmin) && (
                                                                    <td className="px-2 py-4 text-center">
                                                                        <div className="flex flex-col gap-1 items-center">
                                                                            <button
                                                                                onClick={() => apriFormModificaPratica(pratica)}
                                                                                className="text-blue-600 hover:text-blue-800 hover:bg-blue-100 p-1 rounded transition-colors"
                                                                                title="Modifica dati pratica"
                                                                            >
                                                                                ‚úèÔ∏è
                                                                            </button>
                                                                            <button
                                                                                onClick={() => {
                                                                                    if (confirm(`‚ö†Ô∏è CANCELLAZIONE PRATICA\n\nVuoi eliminare definitivamente la pratica ${pratica.numero}?\n\nQuesta azione NON pu√≤ essere annullata.`)) {
                                                                                        const nuovePratiche = pratiche.filter(p => p.id !== pratica.id);
                                                                                        setPratiche(nuovePratiche);
                                                                                        salvasuFirebase(nuovePratiche);
                                                                                    }
                                                                                }}
                                                                                className="text-red-600 hover:text-red-800 hover:bg-red-100 p-1 rounded transition-colors"
                                                                                title="Cancella pratica"
                                                                            >
                                                                                üóëÔ∏è
                                                                            </button>
                                                                        </div>
                                                                    </td>
                                                                )}
                                                                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                                    {pratica.nOrdine || '-'}
                                                                </td>
                                                                <td className="px-4 py-4 whitespace-nowrap text-sm font-bold text-gray-900">{pratica.numero}</td>
                                                                <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{pratica.codice}</td>
                                                                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-700">{pratica.comune}</td>
                                                                <td className="px-4 py-4 text-sm text-gray-500">{pratica.indirizzo}</td>
                                                                <td className="px-4 py-4 text-sm text-gray-600 italic" style={{maxWidth: '300px'}}>
                                                                    {pratica.osservazioni || '-'}
                                                                </td>
                                                                <td className="px-4 py-4 whitespace-nowrap">
                                                                    {/* Select per admin/superadmin su pratiche disponibili o eliminate */}
                                                                    {(utenteCorrente.isAdmin || utenteCorrente.isSuperAdmin) && 
                                                                     (pratica.stato === 'disponibile' || pratica.stato === 'eliminata') ? (
                                                                        <select 
                                                                            className="stato-select"
                                                                            value={pratica.stato}
                                                                            onChange={(e) => cambiaStatoPratica(pratica.id, e.target.value)}
                                                                        >
                                                                            <option value="disponibile">Disponibile</option>
                                                                            <option value="eliminata">Eliminata</option>
                                                                        </select>
                                                                    ) : (
                                                                        <span className={`badge ${getBadgeClass(pratica.stato)}`}>
                                                                            {getStatoLabel(pratica.stato)}
                                                                        </span>
                                                                    )}
                                                                    {pratica.prelavorata && (
                                                                        <span className="badge badge-prelavorata">
                                                                            üìù Prelavorata
                                                                        </span>
                                                                    )}
                                                                    {pratica.stato === 'sospesa' && giorniSospesa > 0 && (
                                                                        <span className="badge reminder-badge">
                                                                            ‚è∞ {giorniSospesa}gg
                                                                        </span>
                                                                    )}
                                                                    {pratica.stato === 'sospesa' && giorniSospesa >= 3 && pratica.utenteAssegnato?.id === utenteCorrente.id && (
                                                                        <div className="mt-2">
                                                                            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded text-xs">
                                                                                <strong>‚ö†Ô∏è ATTENZIONE!</strong>
                                                                                <p className="mt-1">Questa pratica √® al {giorniSospesa}¬∞ giorno di sospensione.</p>
                                                                                <p className="mt-1 font-semibold">Si chiede di ricontattare il cliente per sollecitare la documentazione e di inserire le motivazioni tra le note.</p>
                                                                            </div>
                                                                        </div>
                                                                    )}
                                                                </td>
                                                                <td className="px-4 py-4 whitespace-nowrap text-sm font-medium">
                                                                    <div className="flex gap-2 flex-wrap">
                                                                        {pratica.stato === 'disponibile' && (
                                                                            <button
                                                                                onClick={() => prendiInCarico(pratica.id)}
                                                                                className="text-blue-600 hover:text-blue-900"
                                                                            >
                                                                                ‚úÖ Prendi in carico
                                                                            </button>
                                                                        )}
                                                                        {pratica.stato === 'in-lavorazione' && pratica.utenteAssegnato?.id === utenteCorrente.id && (
                                                                            <>
                                                                                <button
                                                                                    onClick={() => completaPratica(pratica.id)}
                                                                                    className="text-green-600 hover:text-green-900"
                                                                                >
                                                                                    ‚úîÔ∏è Completa
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => sospendiPratica(pratica.id)}
                                                                                    className="text-red-600 hover:text-red-900"
                                                                                >
                                                                                    ‚è∏Ô∏è Sospendi
                                                                                </button>
                                                                            </>
                                                                        )}
                                                                        {pratica.stato === 'sospesa' && pratica.utenteAssegnato?.id === utenteCorrente.id && (
                                                                            <button
                                                                                onClick={() => riattivaPratica(pratica.id)}
                                                                                className="text-yellow-600 hover:text-yellow-900"
                                                                            >
                                                                                ‚ñ∂Ô∏è Riattiva
                                                                            </button>
                                                                        )}
                                                                        {utenteCorrente.isAdmin && (
                                                                            <button
                                                                                onClick={() => riassegnaPratica(pratica.id)}
                                                                                className="text-purple-600 hover:text-purple-900"
                                                                            >
                                                                                üë§ Riassegna
                                                                            </button>
                                                                        )}
                                                                        <button
                                                                            onClick={() => visualizzaDettagli(pratica)}
                                                                            className="text-gray-600 hover:text-gray-900"
                                                                        >
                                                                            üëÅÔ∏è Dettagli
                                                                        </button>
                                                                        <button
                                                                            onClick={() => visualizzaStorico(pratica)}
                                                                            className="text-blue-600 hover:text-blue-900"
                                                                        >
                                                                            üìú Storico
                                                                        </button>
                                                                        <button
                                                                            onClick={() => {
                                                                                if (pratica.coordinate) {
                                                                                    const [lon, lat] = pratica.coordinate;
                                                                                    window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`, '_blank');
                                                                                } else {
                                                                                    const indirizzo = encodeURIComponent(pratica.indirizzo || '');
                                                                                    window.open(`https://www.google.com/maps/search/?api=1&query=${indirizzo}`, '_blank');
                                                                                }
                                                                            }}
                                                                            className="text-green-600 hover:text-green-900 font-semibold"
                                                                        >
                                                                            üó∫Ô∏è Mappa
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}

                        {praticheFiltrate.length === 0 && (
                            <div className="bg-white rounded-lg shadow-md p-8 text-center">
                                <p className="text-gray-500 text-lg">Nessuna pratica trovata</p>
                            </div>
                        )}
                        </>
                        )}
                            </>
                        )}
                    </div>

                    {/* MODALI (abbr per brevit√† - stessi di prima) */}
                    
                    {/* MODALE INSERIMENTO/MODIFICA PRATICA */}
                    {mostraFormPratica && (
                        <div className="modal-overlay" onClick={() => setMostraFormPratica(false)}>
                            <div className="bg-white rounded-lg p-6 max-w-lg w-full" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    {praticaInModifica ? '‚úèÔ∏è Modifica Pratica' : '‚ûï Nuova Pratica'}
                                </h3>
                                
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">N. Ordine</label>
                                            <input
                                                type="text"
                                                className="w-full border border-gray-300 rounded-lg p-2"
                                                placeholder="Es: 1"
                                                value={formPratica.nOrdine}
                                                onChange={(e) => setFormPratica({...formPratica, nOrdine: e.target.value})}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Numero Pratica *</label>
                                            <input
                                                type="text"
                                                className="w-full border border-gray-300 rounded-lg p-2"
                                                placeholder="Es: 123.456"
                                                value={formPratica.numero}
                                                onChange={(e) => setFormPratica({...formPratica, numero: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Codice</label>
                                            <select
                                                className="w-full border border-gray-300 rounded-lg p-2"
                                                value={formPratica.codice}
                                                onChange={(e) => setFormPratica({...formPratica, codice: e.target.value})}
                                            >
                                                <option value="ISP">ISP</option>
                                                <option value="PER">PER</option>
                                                <option value="APE">APE</option>
                                                <option value="VAL">VAL</option>
                                                <option value="ALTRO">ALTRO</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Data Sopralluogo</label>
                                            <input
                                                type="date"
                                                className="w-full border border-gray-300 rounded-lg p-2"
                                                value={formPratica.dataSopralluogo}
                                                onChange={(e) => setFormPratica({...formPratica, dataSopralluogo: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Comune *</label>
                                        <input
                                            type="text"
                                            className="w-full border border-gray-300 rounded-lg p-2"
                                            placeholder="Es: Milano"
                                            value={formPratica.comune}
                                            onChange={(e) => setFormPratica({...formPratica, comune: e.target.value})}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Indirizzo</label>
                                        <input
                                            type="text"
                                            className="w-full border border-gray-300 rounded-lg p-2"
                                            placeholder="Es: Via Roma 123"
                                            value={formPratica.indirizzo}
                                            onChange={(e) => setFormPratica({...formPratica, indirizzo: e.target.value})}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Osservazioni</label>
                                        <textarea
                                            className="w-full border border-gray-300 rounded-lg p-2"
                                            rows="3"
                                            placeholder="Note o osservazioni..."
                                            value={formPratica.osservazioni}
                                            onChange={(e) => setFormPratica({...formPratica, osservazioni: e.target.value})}
                                        />
                                    </div>
                                </div>

                                <div className="flex gap-4 mt-6">
                                    <button
                                        onClick={salvaPratica}
                                        className="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 font-semibold"
                                    >
                                        {praticaInModifica ? 'üíæ Salva Modifiche' : '‚ûï Inserisci Pratica'}
                                    </button>
                                    <button
                                        onClick={() => { setMostraFormPratica(false); setPraticaInModifica(null); }}
                                        className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                                    >
                                        Annulla
                                    </button>
                                </div>
                                
                                {praticaInModifica && (
                                    <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <p className="text-sm text-yellow-800">
                                            <strong>‚ö†Ô∏è Nota:</strong> Le modifiche saranno registrate nello storico della pratica.
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {mostraModal === 'conferma-presa-in-carico' && praticaSelezionata && (
                        <div className="modal-overlay" onClick={() => setMostraModal(null)}>
                            <div className="bg-white rounded-lg p-6 max-w-md" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Conferma Presa in Carico</h3>
                                <p className="mb-4">Pratica: <strong>{praticaSelezionata.numero}</strong></p>
                                <p className="mb-4 text-gray-700">üìã Il sopralluogo √® gi√† stato effettuato?</p>
                                <div className="flex flex-col gap-3">
                                    <button
                                        onClick={() => confermaPrendInCarico(true)}
                                        className="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 font-medium"
                                    >
                                        ‚úÖ S√å - Sopralluogo effettuato
                                    </button>
                                    <button
                                        onClick={() => confermaPrendInCarico(false)}
                                        className="bg-orange-500 text-white px-4 py-3 rounded-lg hover:bg-orange-600 font-medium"
                                    >
                                        üìù NO - Prelavorazione (sopralluogo da fare)
                                    </button>
                                    <button
                                        onClick={() => setMostraModal(null)}
                                        className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                                    >
                                        Annulla
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {mostraModal === 'sospendi' && praticaSelezionata && (
                        <div className="modal-overlay" onClick={() => setMostraModal(null)}>
                            <div className="bg-white rounded-lg p-6 max-w-md" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Sospendi Pratica</h3>
                                <p className="mb-4">Inserisci il motivo della sospensione:</p>
                                <textarea
                                    className="w-full border border-gray-300 rounded-lg p-2 mb-4"
                                    rows="4"
                                    placeholder="Motivo della sospensione..."
                                    value={motivoSospensione}
                                    onChange={(e) => setMotivoSospensione(e.target.value)}
                                />
                                <div className="flex gap-4">
                                    <button
                                        onClick={confermaSospensione}
                                        className="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                                    >
                                        Sospendi
                                    </button>
                                    <button
                                        onClick={() => setMostraModal(null)}
                                        className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                                    >
                                        Annulla
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modale Dettagli Pratica */}
                    {mostraModal === 'dettagli' && praticaSelezionata && (
                        <div className="modal-overlay" onClick={() => setMostraModal(null)}>
                            <div className="bg-white rounded-lg p-6 max-w-2xl" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Dettagli Pratica {praticaSelezionata.numero}</h3>
                                
                                <div className="space-y-3 mb-4">
                                    <div><strong>Codice:</strong> {praticaSelezionata.codice}</div>
                                    <div><strong>Intestati:</strong> {praticaSelezionata.intestati}</div>
                                    <div><strong>Indirizzo:</strong> {praticaSelezionata.indirizzo}</div>
                                    <div><strong>Giorno sopralluogo:</strong> {praticaSelezionata.giorno}</div>
                                    <div><strong>Stato:</strong> {
                                        praticaSelezionata.stato === 'disponibile' ? 'Disponibile' :
                                        praticaSelezionata.stato === 'in-lavorazione' ? 'In Lavorazione' :
                                        praticaSelezionata.stato === 'sospesa' ? 'Sospesa' : 'Completata'
                                    }</div>
                                    {praticaSelezionata.utenteAssegnato && (
                                        <div><strong>Assegnata a:</strong> {praticaSelezionata.utenteAssegnato.nome}</div>
                                    )}
                                    {praticaSelezionata.note && (
                                        <div><strong>Note:</strong> {praticaSelezionata.note}</div>
                                    )}
                                </div>

                                <div className="mb-4">
                                    <label className="block font-bold mb-2">Note Sopralluogo Utente:</label>
                                    <textarea
                                        className="w-full border border-gray-300 rounded-lg p-2"
                                        rows="4"
                                        placeholder="Aggiungi note sul sopralluogo..."
                                        value={noteSopralluogo}
                                        onChange={(e) => setNoteSopralluogo(e.target.value)}
                                        disabled={
                                            // Editabile solo se:
                                            // - L'utente √® assegnato alla pratica
                                            // - O l'utente √® admin/super-admin
                                            !(praticaSelezionata.utenteAssegnato?.id === utenteCorrente.id || utenteCorrente.isAdmin)
                                        }
                                    />
                                    {!(praticaSelezionata.utenteAssegnato?.id === utenteCorrente.id || utenteCorrente.isAdmin) && (
                                        <p className="text-sm text-gray-500 mt-1">
                                            ‚ÑπÔ∏è Solo chi ha la pratica in carico o gli amministratori possono modificare le note
                                        </p>
                                    )}
                                </div>

                                <div className="flex gap-3">
                                    {(praticaSelezionata.utenteAssegnato?.id === utenteCorrente.id || utenteCorrente.isAdmin) && (
                                        <>
                                            <button
                                                onClick={salvaNoteSopralluogo}
                                                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                            >
                                                üíæ Salva Note
                                            </button>
                                            {noteSopralluogo && (
                                                <button
                                                    onClick={cancellaNoteSopralluogo}
                                                    className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                                                >
                                                    üóëÔ∏è Cancella
                                                </button>
                                            )}
                                        </>
                                    )}
                                    <button
                                        onClick={() => setMostraModal(null)}
                                        className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                                    >
                                        Chiudi
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modale Storico */}
                    {mostraModal === 'storico' && praticaSelezionata && (
                        <div className="modal-overlay" onClick={() => setMostraModal(null)}>
                            <div className="bg-white rounded-lg p-6 max-w-2xl" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Storico Pratica {praticaSelezionata.numero}</h3>
                                
                                <div className="space-y-3 mb-4 max-h-96 overflow-y-auto">
                                    {praticaSelezionata.storico && praticaSelezionata.storico.length > 0 ? (
                                        praticaSelezionata.storico.map((evento, index) => (
                                            <div key={index} className="border-l-4 border-blue-500 pl-3 py-2">
                                                <div className="font-bold">{evento.azione}</div>
                                                <div className="text-sm text-gray-600">
                                                    {evento.data} - {evento.utente}
                                                </div>
                                                {evento.dettagli && (
                                                    <div className="text-sm mt-1">{evento.dettagli}</div>
                                                )}
                                            </div>
                                        ))
                                    ) : (
                                        <p className="text-gray-500">Nessun evento nello storico</p>
                                    )}
                                </div>

                                <button
                                    onClick={() => setMostraModal(null)}
                                    className="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                                >
                                    Chiudi
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Modale Riassegnazione */}
                    {mostraModal === 'riassegna' && praticaSelezionata && (
                        <div className="modal-overlay" onClick={() => setMostraModal(null)}>
                            <div className="bg-white rounded-lg p-6 max-w-md" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">Riassegna Pratica {praticaSelezionata.numero}</h3>
                                
                                <p className="mb-4">Seleziona l'utente a cui riassegnare la pratica:</p>
                                
                                <div className="space-y-2 mb-4">
                                    {utenti.filter(u => !u.isAdmin).map(utente => (
                                        <label key={utente.id} className="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                            <input
                                                type="radio"
                                                name="utenteRiassegnazione"
                                                value={utente.id}
                                                checked={utenteRiassegnazione?.id === utente.id}
                                                onChange={() => setUtenteRiassegnazione(utente)}
                                            />
                                            <span>{utente.nome}</span>
                                        </label>
                                    ))}
                                </div>

                                <div className="flex gap-4">
                                    <button
                                        onClick={confermaRiassegnazione}
                                        className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                    >
                                        Riassegna
                                    </button>
                                    <button
                                        onClick={() => setMostraModal(null)}
                                        className="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400"
                                    >
                                        Annulla
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Altri modali... */}
                    
                    {/* Modal PDF Viewer per verifica dati */}
                    {pdfViewer.isOpen && (
                        <div 
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 99999
                            }}
                            onClick={chiudiPdfViewer}
                        >
                            <div 
                                className="bg-white rounded-lg shadow-2xl" 
                                style={{ width: '90vw', height: '90vh', maxWidth: '1200px' }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div className="flex items-center justify-between bg-blue-600 text-white p-4 rounded-t-lg">
                                    <div>
                                        <h3 className="text-lg font-bold">üîç Verifica Dato: {pdfViewer.titoloDato}</h3>
                                        <p className="text-sm opacity-80">
                                            {pdfViewer.tipo === 'atto' ? 'üìã Atto di Provenienza' : 'üìÑ Visura Catastale'} 
                                            {pdfViewer.pagina && ` - Pagina ${pdfViewer.pagina}`}
                                        </p>
                                    </div>
                                    <button 
                                        onClick={chiudiPdfViewer}
                                        className="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 font-bold"
                                    >
                                        ‚úï Chiudi
                                    </button>
                                </div>
                                <div className="p-2" style={{ height: 'calc(100% - 80px)' }}>
                                    {pdfViewer.pdfUrl && (
                                        <iframe
                                            src={`${pdfViewer.pdfUrl}#page=${pdfViewer.pagina}`}
                                            style={{ width: '100%', height: '100%', border: 'none' }}
                                            title="PDF Viewer"
                                        />
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Indicatore stato Firebase */}
                    <div className={`firebase-status ${firebaseConnesso ? 'firebase-connected' : 'firebase-disconnected'}`}>
                        {firebaseConnesso ? 'üü¢ Firebase Online' : 'üî¥ Modalit√† Locale'}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>